<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EV Station Finder - Navigation &amp; Route Planning</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css">
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            overflow: hidden;
        }

        html, body, #root {
            height: 100%;
            width: 100%;
        }

        #map {
            height: calc(100% - 70px);
            width: 100%;
            background: #e5e3df;
            margin-top: 70px;
            margin-left: 0;
            transition: margin-left 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            gap: 15px;
        }

        #mapTitle {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-right: auto;
        }

        .search-container {
            position: relative;
            width: 300px;
            height: 40px;
        }

        #searchInput {
            width: 100%;
            height: 100%;
            padding: 0 12px;
            border: 1px solid #d0d0d0;
            border-radius: 20px;
            font-size: 14px;
            background: white;
            outline: none;
            transition: all 0.3s;
        }

        #searchInput:focus {
            border-color: #007FFF;
            box-shadow: 0 0 0 3px rgba(0, 127, 255, 0.1);
        }

        #searchResults {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 200;
        }

        #searchResults.active {
            opacity: 1;
            pointer-events: all;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f9f9f9;
        }

        .search-result-name {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .search-result-operator {
            font-size: 12px;
            color: #999;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            color: #333;
            border: 1px solid #d0d0d0;
        }

        .btn:hover {
            background: #f0f0f0;
            border-color: #aaa;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        .side-panel {
            position: fixed;
            left: 16px;
            top: 90px;
            width: 280px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
            overflow-y: hidden;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 130px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .panel-section {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }

        .panel-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: linear-gradient(135deg, #e0eeff 0%, #cce0ff 100%);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #99ccff;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #2a52be;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .state-summary-grid-container {
            max-height: 140px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .state-summary-grid-container::-webkit-scrollbar {
            width: 6px;
        }

        .state-summary-grid-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .state-summary-grid-container::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }

        .state-summary-grid-container::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .state-summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .state-summary-card {
            background: linear-gradient(135deg, #e6f0ff 0%, #cce5ff 100%);
            padding: 10px 12px;
            border-radius: 8px;
            border: 1.5px solid #99ccff;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .state-summary-card:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(15, 82, 186, 0.15);
            border-color: #0f52ba;
        }

        .state-summary-card.active {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            border-color: #2a52be;
            box-shadow: 0 4px 12px rgba(0, 127, 255, 0.3);
        }

        .state-summary-name {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .state-summary-card.active .state-summary-name {
            color: white;
        }

        .state-summary-count {
            font-size: 14px;
            font-weight: 900;
            color: #2a52be;
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 8px;
            border-radius: 6px;
            min-width: 35px;
            text-align: center;
        }

        .state-summary-card.active .state-summary-count {
            color: #0f52ba;
            background: white;
        }

        .nearest-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .nearest-item:hover {
            border-color: #007FFF;
            box-shadow: 0 2px 8px rgba(0, 127, 255, 0.2);
        }

        .nearest-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .nearest-distance {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #nearestList {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        #nearestList::-webkit-scrollbar {
            width: 6px;
        }

        #nearestList::-webkit-scrollbar-track {
            background: transparent;
        }

        #nearestList::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }

        #nearestList::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .routing-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            transform: translateY(120%);
            transition: transform 0.3s ease;
            z-index: 10001;
        }

        .routing-panel.active {
            transform: translateY(0);
        }

        .routing-header {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .routing-destination {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 16px;
        }

        .routing-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }

        .routing-content {
            padding: 16px;
        }

        .routing-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .routing-stat-label {
            color: #666;
            font-weight: 600;
        }

        .routing-stat-value {
            color: #2a52be;
            font-weight: 700;
        }

        .battery-section {
            margin: 16px 0;
        }

        .battery-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .battery-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        #batteryFill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            width: 100%;
            transition: width 0.3s, background 0.3s;
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 16px;
        }

        .nav-button {
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .nav-button.primary {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
        }

        .nav-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 127, 255, 0.3);
        }

        .nav-button.secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #d0d0d0;
        }

        .turn-by-turn-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.6s ease-out;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .turn-by-turn-panel.active {
            opacity: 1;
            pointer-events: all;
        }

        .turn-by-turn-panel.fade-out {
            opacity: 0 !important;
            transition: opacity 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
            pointer-events: none !important;
        }

        .nav-overlay-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 32px;
            width: 100%;
            max-width: 480px;
            padding: 0 20px;
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .turn-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
            border-bottom: none;
            width: 100%;
            margin-bottom: 0;
        }

        .turn-title {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            letter-spacing: 2.5px;
            text-transform: uppercase;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .turn-progress-bar {
            height: 2px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
            background-size: 200% 100%;
            width: 100%;
            margin-top: 32px;
            border-radius: 1px;
            order: 10;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.1) inset;
            animation: progressFlow 3s ease-in-out infinite;
        }

        #turnProgressBar {
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            background-size: 200% 100%;
            transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 1px;
            animation: progressFlow 2s ease-in-out infinite;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.5);
        }

        .turn-instruction-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 28px;
            width: 100%;
        }

        #turnArrow {
            font-size: 80px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
            animation: arrowPulse 2.2s cubic-bezier(0.34, 1.56, 0.64, 1) infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            letter-spacing: -2px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        @keyframes arrowPulse {
            0%, 100% {
                transform: scale(1) translateY(0);
                opacity: 0.6;
                filter: drop-shadow(0 0 0px rgba(0, 127, 255, 0));
            }
            50% {
                transform: scale(1.15) translateY(-8px);
                opacity: 1;
                filter: drop-shadow(0 8px 24px rgba(0, 127, 255, 0.6));
            }
        }

        @keyframes textFloat {
            0%, 100% {
                opacity: 0.7;
                transform: translateY(0);
            }
            50% {
                opacity: 1;
                transform: translateY(-4px);
            }
        }

        @keyframes progressFlow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .turn-details {
            flex: 1;
            text-align: center;
            width: 100%;
        }

        #turnDistanceText {
            font-size: 48px;
            font-weight: 300;
            color: #ffffff;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            animation: textFloat 2.4s ease-in-out infinite;
        }

        #turnInstructionText {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
            line-height: 1.6;
            letter-spacing: 0.2px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            animation: textFloat 2.4s ease-in-out infinite;
            animation-delay: 0.1s;
        }

        .turn-controls {
            display: flex;
            gap: 12px;
            padding: 0;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }

        .turn-control-btn {
            padding: 11px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s;
            min-width: 130px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            letter-spacing: 0.2px;
        }

        .turn-control-btn.end {
            background: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .turn-control-btn.end:hover {
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
        }

        #pauseNavBtn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        #pauseNavBtn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
        }

        .view-toggle {
            display: flex;
            gap: 6px;
            background: white;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid #d0d0d0;
        }

        .view-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
        }

        .map-legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            min-width: 240px;
            border: 1px solid #e0e0e0;
            max-height: 70vh;
            overflow-y: auto;
        }

        .legend-title {
            font-weight: 700;
            font-size: 13px;
            color: #1a1a1a;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #666;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color-box {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .station-detail-panel {
            position: fixed;
            top: 90px;
            right: 16px;
            width: 320px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
            z-index: 9998;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            transform: translateX(400px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        .station-detail-panel.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: all;
        }

        .station-detail-header {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
            padding: 20px 16px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .station-detail-header-content {
            flex: 1;
            min-width: 0;
        }

        .station-detail-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
            line-height: 1.3;
            word-break: break-word;
        }

        .station-detail-subtitle {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 500;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .station-detail-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .station-detail-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .station-detail-body {
            padding: 20px 16px;
        }

        .detail-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .detail-item:last-of-type {
            margin-bottom: 0;
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e0eeff 0%, #cce0ff 100%);
            border: 1.5px solid #99ccff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2a52be;
            flex-shrink: 0;
        }

        .detail-content {
            flex: 1;
            min-width: 0;
        }

        .detail-label {
            font-size: 11px;
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 3px;
        }

        .detail-value {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
            line-height: 1.4;
        }

        .station-detail-divider {
            height: 1px;
            background: #f0f0f0;
            margin: 16px 0;
        }

        .station-detail-action {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        }

        .station-detail-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
        }

        body.night-mode .station-detail-panel {
            background: #2a2a2a;
            border-color: #444;
        }

        body.night-mode .station-detail-body {
            border-top-color: #444;
        }

        body.night-mode .detail-icon {
            background: linear-gradient(135deg, #1a1a1a 0%, #1f1f1f 100%);
            border-color: #444;
        }

        body.night-mode .detail-label {
            color: #999;
        }

        body.night-mode .detail-value {
            color: #e0e0e0;
        }

        body.night-mode .station-detail-divider {
            background: #444;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        @keyframes vehiclePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        @keyframes routeGlow {
            0%, 100% {
                filter: drop-shadow(0 0 2px rgba(53, 89, 232, 0.3));
            }
            50% {
                filter: drop-shadow(0 0 8px rgba(53, 89, 232, 0.6));
            }
        }

        @keyframes waterFlow {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 100% 0%;
            }
        }

        .water-flow-line {
            animation: waterFlow 3s linear infinite;
        }

        @keyframes markerBounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        @keyframes locationPulse {
            0% {
                r: 0;
                opacity: 1;
            }
            100% {
                r: 30;
                opacity: 0;
            }
        }

        .location-pulse-circle {
            animation: locationPulse 2s ease-out infinite;
        }

        @keyframes markerPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .user-location-marker {
            animation: markerPulse 2s infinite;
        }

        .animated-vehicle-marker {
            animation: vehiclePulse 2s infinite;
        }

        .animated-route-line {
            animation: routeGlow 2s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            .search-container {
                width: 200px;
            }

            #mapTitle {
                font-size: 18px;
            }
        }

        /* Night Mode Styles */
        body.night-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        body.night-mode .header {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            border-bottom-color: #333;
        }

        body.night-mode #map {
            background: #1a1a1a;
        }

        body.night-mode .side-panel,
        body.night-mode .routing-panel,
        body.night-mode .turn-by-turn-panel,
        body.night-mode .map-legend {
            background: #2a2a2a;
            border-color: #444;
        }

        body.night-mode .panel-section,
        body.night-mode .routing-content {
            border-bottom-color: #444;
        }

        body.night-mode .btn {
            background: #1f1f1f;
            color: #e0e0e0;
            border-color: #444;
        }

        body.night-mode .btn:hover {
            background: #333;
            border-color: #666;
        }

        body.night-mode #searchInput {
            background: #1f1f1f;
            color: #e0e0e0;
            border-color: #444;
        }

        body.night-mode #searchInput::placeholder {
            color: #999;
        }

        body.night-mode #searchInput:focus {
            border-color: #00D9FF;
        }

        body.night-mode #searchResults {
            background: #2a2a2a;
            border-color: #444;
        }

        body.night-mode .search-result-item {
            background: #1f1f1f;
            border-color: #444;
            color: #e0e0e0;
        }

        body.night-mode .search-result-item:hover {
            background: #333;
        }

        body.night-mode .search-result-name {
            color: #e0e0e0;
        }

        body.night-mode .search-result-operator {
            color: #999;
        }

        body.night-mode .state-summary-card {
            background: linear-gradient(135deg, #1f1f1f 0%, #252525 100%);
            border-color: #444;
        }

        body.night-mode .state-summary-name {
            color: #e0e0e0;
        }

        body.night-mode .nearest-item {
            background: #1f1f1f;
            border-color: #444;
        }

        body.night-mode .nearest-item:hover {
            border-color: #00D9FF;
        }

        body.night-mode .nearest-name {
            color: #e0e0e0;
        }

        body.night-mode .nearest-distance {
            color: #999;
        }

        body.night-mode .section-title {
            color: #999;
        }

        body.night-mode .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #1f1f1f 100%);
            border-color: #444;
        }

        body.night-mode .routing-destination {
            color: #e0e0e0;
        }

        body.night-mode .routing-stat-label {
            color: #999;
        }

        body.night-mode .battery-header {
            color: #e0e0e0;
        }

        body.night-mode .turn-header {
            background: #2a2a2a;
            border-bottom-color: #444;
        }

        body.night-mode .turn-title {
            color: #e0e0e0;
        }

        body.night-mode .turn-details {
            color: #e0e0e0;
        }

        body.night-mode #turnInstructionText {
            color: #999;
        }

        body.night-mode .turn-progress-bar {
            background: #444;
        }

        body.night-mode .turn-control-btn {
            background: #1f1f1f;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        body.night-mode .legend-title {
            color: #e0e0e0;
        }

        body.night-mode .legend-item {
            color: #999;
        }

        body.night-mode .view-btn {
            color: #999;
        }

        body.night-mode .view-btn.active {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
        }

        body.night-mode #nightModeLabel {
            display: inline;
        }

        @media (max-width: 768px) {
            #nightModeLabel {
                display: none;
            }
        }
    </style>
  <script src="/_sdk/element_sdk.js"></script>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="root" style="height: 100%; width: 100%;">
   <div id="map"></div>
   <div class="header">
    <div id="mapTitle">
     âš¡ EV Station Finder
    </div>
    <div class="search-container"><input id="searchInput" type="text" placeholder="Search stations...">
     <div id="searchResults"></div>
    </div>
    <div class="control-buttons"><button id="nightModeBtn" class="btn">
      <svg fill="currentColor" viewbox="0 0 24 24">
       <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
      </svg><span id="nightModeLabel">Night</span> </button> <button id="locationBtn" class="btn">
      <svg fill="currentColor" viewbox="0 0 24 24">
       <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
      </svg> Location </button>
    </div>
   </div>
   <div id="sidePanel" class="side-panel">
    <div class="panel-section" style="padding: 16px; border-bottom: 1px solid #f0f0f0;">
     <div style="margin-bottom: 4px;">
      <div style="font-size: 18px; font-weight: 900; color: #1a1a1a;">
       âš¡ EV Stations
      </div>
     </div>
     <div style="font-size: 12px; color: #999; font-weight: 500;">
      Filter &amp; explore charging stations
     </div>
    </div>
    <div class="panel-section" style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
     <div class="section-title">
      States
     </div><button id="clearFilterBtn" class="btn" style="font-size: 11px; padding: 4px 8px; display: none;">Clear</button>
     <div class="state-summary-grid-container">
      <div style="display: flex; gap: 6px; margin-bottom: 12px; background: white; padding: 4px; border-radius: 12px; border: 1px solid #d0d0d0;"><button id="viewClustered" class="view-btn active" style="flex: 1; padding: 6px 12px;">Clustered</button> <button id="viewIndividual" class="view-btn" style="flex: 1; padding: 6px 12px;">Individual</button>
      </div>
      <div id="stateSummary" class="state-summary-grid"></div>
     </div>
    </div>
    <div class="panel-section" style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
     <div class="section-title">
      âš¡ Overall Stats
     </div>
     <div class="stats-grid">
      <div class="stat-card">
       <div class="stat-value" id="totalStations">
        0
       </div>
       <div class="stat-label">
        Total Stations
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-value" id="totalStates">
        0
       </div>
       <div class="stat-label">
        States
       </div>
      </div>
     </div>
    </div>
    <div class="panel-section" style="padding: 12px; flex: 1; display: flex; flex-direction: column; min-height: 0; border-bottom: none;">
     <div class="section-title">
      ðŸ”‹ Nearest Stations
     </div>
     <div id="nearestList"></div>
    </div>
   </div>
   <div id="routingPanel" class="routing-panel">
    <div class="routing-header">
     <div class="routing-destination" id="routingDestination">
      Loading...
     </div><button id="routingClose" class="routing-close">âœ•</button>
    </div>
    <div class="routing-content">
     <div class="routing-stat"><span class="routing-stat-label">Distance</span> <span class="routing-stat-value" id="routingDistance">-- km</span>
     </div>
     <div class="routing-stat"><span class="routing-stat-label">Time</span> <span class="routing-stat-value" id="routingTime">--:--</span>
     </div>
     <div class="routing-stat"><span class="routing-stat-label">Avg Speed</span> <span class="routing-stat-value" id="routingSpeed">-- km/h</span>
     </div>
     <div class="battery-section">
      <div class="battery-header"><span>ðŸ”‹ Battery Impact</span> <span id="batteryRemaining">100%</span>
      </div>
      <div class="battery-bar">
       <div id="batteryFill" style="width: 100%;"></div>
      </div>
      <div style="font-size: 11px; color: #999; margin-top: 6px;"><span id="batteryUsed">0 kWh used</span>
      </div>
     </div>
     <div class="nav-buttons"><button id="startNavBtn" class="nav-button primary">Start Navigation</button> <button id="routingClose2" class="nav-button secondary">Cancel</button>
     </div>
    </div>
   </div>
   <div id="turnByTurnPanel" class="turn-by-turn-panel">
    <div class="nav-overlay-container">
     <div class="turn-header" style="flex-direction: column; gap: 8px; align-items: center;">
      <div class="turn-title">
       ðŸ§­ Navigation
      </div>
      <div style="font-size: 13px; color: #999; display: flex; gap: 16px; font-weight: 500;"><span id="turnTimeProgress">-- left</span> <span>â€¢</span> <span id="turnDistanceProgress">-- km</span>
      </div>
     </div>
     <div class="turn-instruction-area">
      <div id="turnArrow">
       âž¤
      </div>
      <div class="turn-details">
       <div id="turnDistanceText">
        --m
       </div>
       <div id="turnInstructionText">
        Continue
       </div>
      </div>
     </div>
     <div class="turn-controls"><button id="turnCloseBtn" class="turn-control-btn end">âœ• Exit</button> <button id="turnEndBtn" class="turn-control-btn end">âœ“ Arrived</button>
     </div>
     <div class="turn-progress-bar" style="margin-top: 20px;">
      <div id="turnProgressBar" style="width: 0%;"></div>
     </div>
    </div>
   </div>
   <div id="stationDetailPanel" class="station-detail-panel">
    <div class="station-detail-header">
     <div class="station-detail-header-content">
      <div class="station-detail-title" id="detailStationName">
       Station Name
      </div>
      <div class="station-detail-subtitle">
       âš¡ EV Charging
      </div>
     </div><button class="station-detail-close" onclick="closeStationDetail()">âœ•</button>
    </div>
    <div class="station-detail-body">
     <div class="detail-item">
      <div class="detail-icon">
       <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
       </svg>
      </div>
      <div class="detail-content">
       <div class="detail-label">
        Operator
       </div>
       <div class="detail-value" id="detailOperator">
        -
       </div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-icon">
       <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
       </svg>
      </div>
      <div class="detail-content">
       <div class="detail-label">
        Location
       </div>
       <div class="detail-value" id="detailState">
        -
       </div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-icon">
       <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="12" cy="12" r="1" /> <circle cx="19" cy="12" r="1" /> <circle cx="5" cy="12" r="1" />
       </svg>
      </div>
      <div class="detail-content">
       <div class="detail-label">
        Available Chargers
       </div>
       <div class="detail-value" id="detailChargers">
        -
       </div>
      </div>
     </div>
     <div class="station-detail-divider"></div><button class="station-detail-action" onclick="startDirectionsFromDetail()">
      <svg viewbox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z" />
      </svg> Get Directions </button>
    </div>
   </div>
   <div id="mapLegend" class="map-legend">
    <div class="legend-title">
     <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" />
     </svg> Map Legend
    </div>
    <div style="margin-bottom: 12px;">
     <div style="font-size: 11px; text-transform: uppercase; color: #999; margin-bottom: 8px; font-weight: 600;">
      Marker Types
     </div>
     <div class="legend-item">
      <div class="legend-color-box" style="background: linear-gradient(135deg, #3559E8 0%, #5B7EF7 100%);"></div><span>EV Station</span>
     </div>
     <div class="legend-item">
      <div class="legend-color-box" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);"></div><span>Filtered Station</span>
     </div>
    </div>
   </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script>
        const defaultConfig = {
            map_title: 'âš¡ EV Station Finder',
            search_placeholder: 'Search stations...'
        };

        let config = { ...defaultConfig };
        let map, markerClusterGroup, userMarker;
        let allStations = [];
        let stateData = {};
        let userLocation = null;
        let selectedStation = null;
        let currentView = 'clustered';
        let allMarkersArray = [];
        let routePolyline = null;
        let vehicleMarker = null;
        let animationId = null;
        let routeCoordinates = [];
        let overlayTimeoutId = null;
        let navigationActive = false;
        let navigationPaused = false;
        let navStartTime = 0;
        let navPausedTime = 0;
        let navigationTurns = [];
        let currentTurnIndex = 0;
        let geolocationWatchId = null;
        let navigationStartLocation = null;
        let navigationDestination = null;
        let navigationSimulationStartTime = 0;
        let simulatedRouteProgress = 0;

        async function initSDK() {
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (newConfig) => {
                        config = { ...defaultConfig, ...newConfig };
                        applyConfig();
                    },
                    mapToCapabilities: (cfg) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (cfg) => new Map([
                        ['map_title', cfg.map_title || defaultConfig.map_title],
                        ['search_placeholder', cfg.search_placeholder || defaultConfig.search_placeholder]
                    ])
                });
                config = { ...defaultConfig, ...window.elementSdk.config };
            }
            applyConfig();
            initMap();
        }

        function applyConfig() {
            document.getElementById('mapTitle').textContent = config.map_title || defaultConfig.map_title;
            document.getElementById('searchInput').placeholder = config.search_placeholder || defaultConfig.search_placeholder;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function getOSRMRoute(startLat, startLng, endLat, endLng) {
            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
                const response = await fetch(url, { method: 'GET' });
                const data = await response.json();
                
                if (!response.ok || data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
                    throw new Error('OSRM routing failed');
                }
                
                const route = data.routes[0];
                const coordinates = route.geometry.coordinates.map(coord => ({
                    lat: coord[1],
                    lng: coord[0]
                }));
                
                return {
                    summary: { 
                        lengthInMeters: route.distance, 
                        travelTimeInSeconds: route.duration 
                    },
                    legs: [{ points: coordinates }]
                };
            } catch (error) {
                showErrorToast('Route calculation failed');
                throw error;
            }
        }

        async function getDirections(lat, lng, name) {
            if (!userLocation) {
                showToast('Please enable your location first');
                document.getElementById('locationBtn').click();
                return;
            }
            
            selectedStation = { lat, lng, name };
            
            try {
                showToast('ðŸ§­ Calculating route...');
                const routeData = await getOSRMRoute(userLocation.lat, userLocation.lng, lat, lng);
                
                const summary = routeData.summary;
                const distance = (summary.lengthInMeters / 1000).toFixed(1);
                const time = Math.round(summary.travelTimeInSeconds / 60);
                const avgSpeed = (summary.lengthInMeters / summary.travelTimeInSeconds * 3.6).toFixed(0);
                
                routeCoordinates = routeData.legs[0].points || [];
                
                const batteryCapacity = 60;
                const consumptionRate = 17;
                const batteryUsed = (distance * consumptionRate / 100).toFixed(1);
                const batteryPercent = Math.max(0, 100 - (batteryUsed / batteryCapacity * 100)).toFixed(0);
                
                document.getElementById('routingDestination').textContent = name;
                document.getElementById('routingDistance').textContent = `${distance} km`;
                document.getElementById('routingTime').textContent = formatTime(time);
                document.getElementById('routingSpeed').textContent = `${avgSpeed} km/h`;
                document.getElementById('batteryFill').style.width = `${batteryPercent}%`;
                document.getElementById('batteryUsed').textContent = `${batteryUsed} kWh used`;
                document.getElementById('batteryRemaining').textContent = `${batteryPercent}% remaining`;
                
                const batteryFill = document.getElementById('batteryFill');
                if (batteryPercent < 20) {
                    batteryFill.style.background = 'linear-gradient(90deg, #ef4444 0%, #f87171 100%)';
                } else if (batteryPercent < 50) {
                    batteryFill.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';
                } else {
                    batteryFill.style.background = 'linear-gradient(90deg, #10b981 0%, #34d399 100%)';
                }
                
                displayRouteOnMap();
                
                document.getElementById('routingPanel').classList.add('active');
                showToast('ðŸ—ºï¸ Route ready! Click "Start Navigation" to begin...');
                
                const bounds = L.latLngBounds(routeCoordinates.map(c => [c.lat, c.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
                
            } catch (error) {
                showErrorToast(`Route failed: ${error.message}`);
            }
            
            map.closePopup();
        }

        function displayRouteOnMap() {
            if (!routeCoordinates || routeCoordinates.length === 0) return;

            if (routePolyline && map.hasLayer(routePolyline)) map.removeLayer(routePolyline);
            if (window.glowPolyline && map.hasLayer(window.glowPolyline)) map.removeLayer(window.glowPolyline);
            if (window.strokePolyline && map.hasLayer(window.strokePolyline)) map.removeLayer(window.strokePolyline);
            if (window.glowAnimationInterval) clearInterval(window.glowAnimationInterval);

            const routePath = routeCoordinates.map(c => [c.lat, c.lng]);
            
            window.strokePolyline = L.polyline(routePath, {
                color: '#1a3a7a',
                weight: 12,
                opacity: 0.6,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
            
            routePolyline = L.polyline(routePath, {
                color: '#007FFF',
                weight: 8,
                opacity: 1,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
            
            window.glowPolyline = L.polyline(routePath, {
                color: '#2a52be',
                weight: 14,
                opacity: 0.3,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
            
            let pulseScale = 1;
            let pulseDirection = 1;
            const animateGlow = () => {
                pulseScale += (0.02 * pulseDirection);
                
                if (pulseScale > 1.3) pulseDirection = -1;
                if (pulseScale < 0.7) pulseDirection = 1;
                
                if (window.glowPolyline._path) {
                    window.glowPolyline._path.style.opacity = 0.2 + (0.25 * Math.sin(pulseScale));
                }
                if (routePolyline._path) {
                    routePolyline._path.style.filter = `drop-shadow(0 0 ${6 * Math.sin(pulseScale)}px rgba(0, 127, 255, 0.5))`;
                }
            };
            
            window.glowAnimationInterval = setInterval(animateGlow, 30);
        }

        function formatTime(minutes) {
            if (minutes < 60) {
                return `${minutes} min`;
            }
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        function initMap() {
            map = L.map('map', {
                center: [4.2105, 101.9758], zoom: 7, zoomControl: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap contributors Â© CARTO',
                maxZoom: 19,
                crossOrigin: 'anonymous'
            }).addTo(map);

            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 60, iconCreateFunction: createClusterIcon
            });

            loadEVStations();
            setupEventListeners();
        }

        function createClusterIcon(cluster) {
            const count = cluster.getChildCount();
            let size, color;
            if (count < 10) { size = 'small'; color = '#4DE9FF'; }
            else if (count < 50) { size = 'medium'; color = '#00D9FF'; }
            else { size = 'large'; color = '#00A8CC'; }
            
            return L.divIcon({
                html: `<div style="background: linear-gradient(135deg, ${color}, #7C3AED); width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; font-size: 12px; border: 3px solid white; box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);">${count}</div>`,
                className: `marker-cluster marker-cluster-${size}`,
                iconSize: size === 'small' ? [40, 40] : size === 'medium' ? [50, 50] : [60, 60],
                iconAnchor: [size === 'small' ? 20 : size === 'medium' ? 25 : 30, size === 'small' ? 20 : size === 'medium' ? 25 : 30]
            });
        }

        async function loadEVStations() {
            try {
                showToast('âš¡ Loading stations...');
                const response = await fetch('data/ev_station.geojson');
                const data = await response.json();
                
                if (!data.features || data.features.length === 0) {
                    throw new Error('No stations found');
                }

                allStations = data.features.map((feature, idx) => {
                    const props = feature.properties || {};
                    const coords = feature.geometry?.coordinates || [0, 0];
                    
                    return {
                        properties: {
                            name: props.name || props.station_name || 'Unknown Station',
                            operator: props.operator || props.company || 'N/A',
                            state: props.state || props.province || 'Unknown',
                            chargers: parseInt(props.chargers) || 1
                        },
                        geometry: { 
                            coordinates: [coords[0], coords[1]]
                        },
                        id: idx
                    };
                });

                processStations();
                renderStations();
                updateStats();
                populateStateList();
                updateNearestStations();
                showToast(`âœ… Loaded ${allStations.length} stations`);

            } catch (error) {
                console.error('Load error:', error);
                showErrorToast(`Load failed: ${error.message}`);
            }
        }

        function processStations() {
            stateData = {};
            allStations.forEach(station => {
                const state = station.properties?.state || 'Unknown';
                if (!stateData[state]) stateData[state] = [];
                stateData[state].push(station);
            });
        }

        function showStationPopup(station) {
            const props = station.properties || {};
            document.getElementById('detailStationName').textContent = props.name || 'Unknown Station';
            document.getElementById('detailOperator').textContent = props.operator || 'N/A';
            document.getElementById('detailState').textContent = props.state || 'Unknown';
            document.getElementById('detailChargers').textContent = `${props.chargers || 1} Unit${(props.chargers || 1) !== 1 ? 's' : ''}`;
            
            selectedStation = {
                lat: station.geometry.coordinates[1],
                lng: station.geometry.coordinates[0],
                name: props.name || 'Unknown Station',
                station: station
            };
            
            document.getElementById('stationDetailPanel').classList.add('active');
            
            const coords = station.geometry?.coordinates;
            if (coords) {
                map.setView([coords[1], coords[0]], 16);
            }
        }

        function closeStationDetail() {
            document.getElementById('stationDetailPanel').classList.remove('active');
            selectedStation = null;
        }

        function startDirectionsFromDetail() {
            if (selectedStation) {
                getDirections(selectedStation.lat, selectedStation.lng, selectedStation.name);
                closeStationDetail();
            }
        }

        function renderStations(filterState = null) {
            markerClusterGroup.clearLayers();
            allMarkersArray.forEach(marker => {
                if (map.hasLayer(marker)) map.removeLayer(marker);
            });
            allMarkersArray = [];
            if (map.hasLayer(markerClusterGroup)) map.removeLayer(markerClusterGroup);
            
            const stationsToRender = filterState ? allStations.filter(s => s.properties?.state === filterState) : allStations;

            stationsToRender.forEach(station => {
                const coords = station.geometry?.coordinates;
                if (!coords) return;

                const props = station.properties || {};
                const lat = coords[1], lng = coords[0];
                const markerGradient = filterState ? 'linear-gradient(135deg, #10b981 0%, #34d399 100%)' : 'linear-gradient(135deg, #3559E8 0%, #5B7EF7 100%)';

                const icon = L.divIcon({
                    html: `<div style="width: 28px; height: 28px; background: ${markerGradient}; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 4px 12px rgba(53, 89, 232, 0.3);"><svg viewBox="0 0 24 24" fill="white" style="width: 14px; height: 14px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>`,
                    className: 'custom-marker-container', iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
                });

                const marker = L.marker([lat, lng], { icon });
                marker.stationId = station.id;
                marker.station = station;
                marker.on('click', function() {
                    showStationPopup(station);
                });
                markerClusterGroup.addLayer(marker);
                allMarkersArray.push(marker);
            });

            if (currentView === 'clustered') {
                map.addLayer(markerClusterGroup);
            } else {
                allMarkersArray.forEach(marker => map.addLayer(marker));
            }

            if (filterState && stationsToRender.length > 0) {
                const bounds = L.latLngBounds(stationsToRender.map(s => [s.geometry.coordinates[1], s.geometry.coordinates[0]]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function updateStats() {
            document.getElementById('totalStations').textContent = allStations.length;
            document.getElementById('totalStates').textContent = Object.keys(stateData).length;
        }

        function populateStateList() {
            const stateSummary = document.getElementById('stateSummary');
            stateSummary.innerHTML = '';

            Object.entries(stateData)
                .sort((a, b) => b[1].length - a[1].length)
                .forEach(([state, stations]) => {
                    const summaryCard = document.createElement('div');
                    summaryCard.className = 'state-summary-card';
                    summaryCard.innerHTML = `<span class="state-summary-name">${state}</span><span class="state-summary-count">${stations.length}</span>`;
                    summaryCard.addEventListener('click', () => filterByState(state));
                    stateSummary.appendChild(summaryCard);
                });
        }

        function filterByState(state) {
            document.querySelectorAll('.state-summary-card').forEach(card => {
                const isActive = card.querySelector('.state-summary-name').textContent === state;
                card.classList.toggle('active', isActive);
            });
            document.getElementById('clearFilterBtn').style.display = 'block';
            renderStations(state);
        }

        function clearFilter() {
            document.querySelectorAll('.state-summary-card').forEach(card => card.classList.remove('active'));
            document.getElementById('clearFilterBtn').style.display = 'none';
            renderStations();
            map.setView([4.2105, 101.9758], 7);
        }

        function updateNearestStations() {
            const nearestList = document.getElementById('nearestList');
            nearestList.innerHTML = '';

            if (!userLocation) {
                nearestList.innerHTML = '<div style="padding: 10px; color: #999; font-size: 0.85rem; text-align: center;">Enable location to see nearest stations</div>';
                return;
            }

            const withDistance = allStations.map(s => ({
                ...s,
                distance: getDistance(userLocation.lat, userLocation.lng, s.geometry.coordinates[1], s.geometry.coordinates[0])
            })).sort((a, b) => a.distance - b.distance).slice(0, 3);

            withDistance.forEach(station => {
                const item = document.createElement('div');
                item.className = 'nearest-item';
                const props = station.properties;
                item.innerHTML = `<div class="nearest-name">${props.name}</div><div class="nearest-distance"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg>${station.distance.toFixed(1)} km</div>`;
                item.addEventListener('click', () => {
                    getDirections(station.geometry.coordinates[1], station.geometry.coordinates[0], props.name);
                });
                nearestList.appendChild(item);
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: #1f2937;
                color: white;
                padding: 14px 24px;
                border-radius: 12px;
                font-weight: 500;
                z-index: 3000;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showErrorToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: #dc2626;
                color: white;
                padding: 14px 24px;
                border-radius: 12px;
                font-weight: 600;
                z-index: 3000;
                box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
                max-width: 90%;
                text-align: center;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function calculateBearing(from, to) {
            const dLon = (to.lng - from.lng) * Math.PI / 180;
            const lat1 = from.lat * Math.PI / 180;
            const lat2 = to.lat * Math.PI / 180;
            
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            const bearing = Math.atan2(y, x) * 180 / Math.PI;
            
            return (bearing + 360) % 360;
        }

        function calculateTurn(prevBearing, nextBearing) {
            let turn = nextBearing - prevBearing;
            while (turn > 180) turn -= 360;
            while (turn < -180) turn += 360;
            return turn;
        }

        function getTurnIcon(turn) {
            const absT = Math.abs(turn);
            if (absT < 15) return { icon: 'â¬†', text: 'Continue ahead', color: '#3559E8' };
            if (turn > 15 && turn < 45) return { icon: 'â†—', text: 'Slight right', color: '#8B5CF6' };
            if (turn >= 45 && turn < 110) return { icon: 'â†’', text: 'Turn right', color: '#3B82F6' };
            if (turn >= 110 && turn < 150) return { icon: 'â†˜', text: 'Sharp right', color: '#1D4ED8' };
            if (turn >= 150) return { icon: 'â†©', text: 'Make a U-turn', color: '#DC2626' };
            if (turn < -15 && turn > -45) return { icon: 'â†–', text: 'Slight left', color: '#8B5CF6' };
            if (turn <= -45 && turn > -110) return { icon: 'â†', text: 'Turn left', color: '#3B82F6' };
            if (turn <= -110 && turn > -150) return { icon: 'â†™', text: 'Sharp left', color: '#1D4ED8' };
            if (turn <= -150) return { icon: 'â†©', text: 'Make a U-turn', color: '#DC2626' };
            return { icon: 'â¬†', text: 'Continue', color: '#3559E8' };
        }

        function generateNavigationTurns(coordinates) {
            const turns = [];
            
            for (let i = 1; i < coordinates.length - 1; i++) {
                const prevCoord = coordinates[i - 1];
                const currentCoord = coordinates[i];
                const nextCoord = coordinates[i + 1];
                
                const prevBearing = calculateBearing(prevCoord, currentCoord);
                const nextBearing = calculateBearing(currentCoord, nextCoord);
                const turn = calculateTurn(prevBearing, nextBearing);
                
                const absT = Math.abs(turn);
                if (absT > 15) {
                    let distanceFromTurn = 0;
                    for (let j = i; j > 0; j--) {
                        distanceFromTurn += getDistance(
                            coordinates[j - 1].lat,
                            coordinates[j - 1].lng,
                            coordinates[j].lat,
                            coordinates[j].lng
                        );
                    }
                    
                    const turnInfo = getTurnIcon(turn);
                    turns.push({
                        coordinateIndex: i,
                        turn,
                        distance: distanceFromTurn,
                        ...turnInfo
                    });
                }
            }
            
            return turns;
        }

        function getNextTurnInfo(currentIndex, turns) {
            for (let i = 0; i < turns.length; i++) {
                if (turns[i].coordinateIndex > currentIndex) {
                    return { turn: turns[i], nextIndex: i };
                }
            }
            return { turn: null, nextIndex: -1 };
        }

        function startRealTimeNavigation() {
            if (!routeCoordinates || routeCoordinates.length === 0) return;

            navigationActive = true;
            navigationPaused = false;
            currentTurnIndex = 0;
            navigationStartLocation = userLocation ? { ...userLocation } : null;
            navigationDestination = selectedStation;
            
            if (animationId) cancelAnimationFrame(animationId);
            
            navigationTurns = generateNavigationTurns(routeCoordinates);

            if (window.strokePolyline) {
                window.strokePolyline.setStyle({
                    color: '#007FFF',
                    weight: 12,
                    opacity: 0.9
                });
            }
            if (routePolyline) {
                routePolyline.setStyle({
                    color: '#2a52be',
                    weight: 10,
                    opacity: 1
                });
            }
            if (window.glowPolyline) {
                window.glowPolyline.setStyle({
                    color: '#007FFF',
                    weight: 14,
                    opacity: 0.6
                });
            }

            const vehicleIcon = L.divIcon({
                html: '<div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3), 0 4px 12px rgba(16, 185, 129, 0.4);"><svg viewBox="0 0 24 24" fill="white" style="width: 20px; height: 20px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>',
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                className: 'nav-vehicle-marker'
            });

            if (vehicleMarker && map.hasLayer(vehicleMarker)) map.removeLayer(vehicleMarker);
            vehicleMarker = L.marker([userLocation.lat, userLocation.lng], { icon: vehicleIcon }).addTo(map);
            map.setView([userLocation.lat, userLocation.lng], 17);

            const totalDistance = routeCoordinates.reduce((sum, coord, i) => {
                if (i === 0) return 0;
                return sum + getDistance(routeCoordinates[i - 1].lat, routeCoordinates[i - 1].lng, coord.lat, coord.lng);
            }, 0);
            
            const navigationSpeed = 50;
            const totalTime = (totalDistance / navigationSpeed) * 3600 * 1000;
            
            navStartTime = Date.now();
            navPausedTime = 0;

            const turnByTurnPanel = document.getElementById('turnByTurnPanel');
            turnByTurnPanel.classList.add('active');
            turnByTurnPanel.classList.remove('fade-out');
            
            const navOverlayContainer = turnByTurnPanel.querySelector('.nav-overlay-container');
            navOverlayContainer.style.transition = 'none';
            navOverlayContainer.style.opacity = '1';
            navOverlayContainer.style.transform = 'scale(1)';
            
            document.getElementById('turnArrow').textContent = 'â¬†';
            document.getElementById('turnDistanceText').textContent = 'Ready?';
            document.getElementById('turnInstructionText').textContent = 'Starting navigation in 3 seconds...';
            document.getElementById('turnInstructionText').style.color = 'rgba(255, 255, 255, 0.8)';
            
            if (overlayTimeoutId) clearTimeout(overlayTimeoutId);
            
            // Schedule overlay fade-out after 3 seconds
            overlayTimeoutId = setTimeout(() => {
                console.log('Fade-out triggered at 3 seconds');
                turnByTurnPanel.classList.add('fade-out');
                
                // After fade-out animation completes, remove active class
                setTimeout(() => {
                    console.log('Removing active class after fade-out');
                    if (turnByTurnPanel.classList.contains('fade-out')) {
                        turnByTurnPanel.classList.remove('active');
                    }
                }, 800);
            }, 3000);
            
            // Start geolocation immediately in background
            beginGeolocationTracking(totalTime, navigationTurns);
        }

        let lastLocationUpdate = null;
        let smoothHeading = 0;

        function beginGeolocationTracking(totalTime, navigationTurns) {
            if (!geolocationWatchId) {
                geolocationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            heading: position.coords.heading,
                            speed: position.coords.speed
                        };
                        
                        lastLocationUpdate = {
                            lat: userLocation.lat,
                            lng: userLocation.lng,
                            timestamp: Date.now()
                        };
                        
                        if (userLocation.heading !== null && userLocation.heading !== undefined) {
                            let headingDiff = userLocation.heading - smoothHeading;
                            if (headingDiff > 180) headingDiff -= 360;
                            if (headingDiff < -180) headingDiff += 360;
                            smoothHeading += headingDiff * 0.15;
                        }
                        
                        if (vehicleMarker) {
                            vehicleMarker.setLatLng([userLocation.lat, userLocation.lng]);
                            
                            const heading = userLocation.heading !== null ? userLocation.heading : smoothHeading;
                            vehicleMarker._icon.style.transform = `rotate(${heading}deg) scale(1.1)`;
                            vehicleMarker._icon.style.filter = 'drop-shadow(0 0 8px rgba(16, 185, 129, 0.6))';
                            
                            updateDirectionIndicator(heading);
                        }
                        
                        updateMapView(userLocation);
                        
                        if (!navigationDestination) {
                            endNavigation();
                            return;
                        }
                        
                        const remainingDistance = getDistance(
                            userLocation.lat,
                            userLocation.lng,
                            navigationDestination.lat,
                            navigationDestination.lng
                        );
                        
                        if (remainingDistance < 0.05) {
                            navigationComplete();
                            return;
                        }
                        
                        let closestIndex = 0;
                        let closestDistance = Infinity;
                        for (let i = 0; i < routeCoordinates.length; i++) {
                            const d = getDistance(
                                userLocation.lat,
                                userLocation.lng,
                                routeCoordinates[i].lat,
                                routeCoordinates[i].lng
                            );
                            if (d < closestDistance) {
                                closestDistance = d;
                                closestIndex = i;
                            }
                        }
                        
                        const routeProgress = closestIndex / routeCoordinates.length;
                        const elapsedTime = routeProgress * totalTime;
                        const remainingSeconds = Math.max(0, (totalTime - elapsedTime) / 1000);
                        
                        const hours = Math.floor(remainingSeconds / 3600);
                        const mins = Math.floor((remainingSeconds % 3600) / 60);
                        const secs = Math.floor(remainingSeconds % 60);

                        let timeStr = '';
                        if (hours > 0) timeStr = `${hours}h ${mins}m`;
                        else if (mins > 0) timeStr = `${mins}:${String(secs).padStart(2, '0')}`;
                        else timeStr = `${Math.ceil(secs)}s`;

                        document.getElementById('turnTimeProgress').textContent = timeStr;
                        document.getElementById('turnDistanceProgress').textContent = `${remainingDistance.toFixed(1)} km`;
                        document.getElementById('turnProgressBar').style.width = `${(routeProgress * 100)}%`;

                        updateSpeedDisplay(userLocation.speed);

                        const { turn: nextTurn, nextIndex } = getNextTurnInfo(closestIndex, navigationTurns);

                        if (nextTurn) {
                            const distanceToTurn = getDistance(
                                userLocation.lat,
                                userLocation.lng,
                                routeCoordinates[nextTurn.coordinateIndex].lat,
                                routeCoordinates[nextTurn.coordinateIndex].lng
                            );

                            if (distanceToTurn < 0.5) {
                                updateTurnDisplay(nextTurn, Math.round(distanceToTurn * 1000), `${nextTurn.icon} ${nextTurn.text}`, true);
                            } else {
                                const futureIndex = nextIndex + 1;
                                if (futureIndex < navigationTurns.length) {
                                    const futureTurn = navigationTurns[futureIndex];
                                    const distanceToFuture = getDistance(
                                        userLocation.lat,
                                        userLocation.lng,
                                        routeCoordinates[futureTurn.coordinateIndex].lat,
                                        routeCoordinates[futureTurn.coordinateIndex].lng
                                    );
                                    
                                    if (distanceToFuture < 1) {
                                        updateTurnDisplay(futureTurn, Math.round(distanceToFuture * 1000), `In ${Math.round(distanceToTurn * 1000)}m, ${futureTurn.text}`, false);
                                    } else {
                                        updateTurnDisplay(nextTurn, distanceToTurn > 1 ? Math.round(distanceToTurn * 1000) : Math.round(distanceToTurn * 1000), nextTurn.text, false);
                                    }
                                } else {
                                    updateTurnDisplay({ icon: 'ðŸŽ¯', text: 'Continue to destination' }, Math.round(remainingDistance * 1000), 'Continue to destination', false);
                                }
                            }
                        } else {
                            updateTurnDisplay({ icon: 'ðŸŽ¯', text: 'Approaching destination' }, Math.round(remainingDistance * 1000), 'Approaching destination', false);
                        }
                    },
                    (error) => {
                        if (error.code === 3) {
                            showToast('ðŸ“ Switching to simulation mode...');
                            if (geolocationWatchId !== null) {
                                navigator.geolocation.clearWatch(geolocationWatchId);
                                geolocationWatchId = null;
                            }
                            simulateNavigation(totalTime, navigationTurns);
                        } else if (error.code === 1) {
                            showErrorToast('Location permission denied');
                            endNavigation();
                        } else if (error.code === 2) {
                            showToast('Location unavailable - retrying...');
                        }
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 20000,
                        maximumAge: 8000
                    }
                );
            }

            setupNavigationControls();
        }

        function simulateNavigation(totalTime, navigationTurns) {
            navigationSimulationStartTime = Date.now();
            
            function updateSimulation() {
                const elapsedTime = Date.now() - navigationSimulationStartTime;
                simulatedRouteProgress = Math.min(1, elapsedTime / totalTime);
                
                if (simulatedRouteProgress >= 1) {
                    navigationComplete();
                    return;
                }
                
                const currentRouteIndex = Math.floor(simulatedRouteProgress * (routeCoordinates.length - 1));
                const simLocation = routeCoordinates[currentRouteIndex];
                
                userLocation = {
                    lat: simLocation.lat,
                    lng: simLocation.lng,
                    accuracy: 15,
                    heading: currentRouteIndex < routeCoordinates.length - 1 
                        ? calculateBearing(simLocation, routeCoordinates[currentRouteIndex + 1])
                        : 0,
                    speed: 15
                };
                
                updateNavigationDisplay(userLocation, totalTime, navigationTurns);
                animationId = requestAnimationFrame(updateSimulation);
            }
            
            animationId = requestAnimationFrame(updateSimulation);
        }

        function updateNavigationDisplay(location, totalTime, navigationTurns) {
            if (vehicleMarker) {
                vehicleMarker.setLatLng([location.lat, location.lng]);
                
                const heading = location.heading !== null ? location.heading : smoothHeading;
                vehicleMarker._icon.style.transform = `rotate(${heading}deg) scale(1.1)`;
                vehicleMarker._icon.style.filter = 'drop-shadow(0 0 8px rgba(16, 185, 129, 0.6))';
                
                updateDirectionIndicator(heading);
            }
            
            updateMapView(location);
            
            if (!navigationDestination) {
                endNavigation();
                return;
            }
            
            const remainingDistance = getDistance(
                location.lat,
                location.lng,
                navigationDestination.lat,
                navigationDestination.lng
            );
            
            if (remainingDistance < 0.05) {
                navigationComplete();
                return;
            }
            
            let closestIndex = 0;
            let closestDistance = Infinity;
            for (let i = 0; i < routeCoordinates.length; i++) {
                const d = getDistance(
                    location.lat,
                    location.lng,
                    routeCoordinates[i].lat,
                    routeCoordinates[i].lng
                );
                if (d < closestDistance) {
                    closestDistance = d;
                    closestIndex = i;
                }
            }
            
            const routeProgress = closestIndex / routeCoordinates.length;
            const elapsedTime = routeProgress * totalTime;
            const remainingSeconds = Math.max(0, (totalTime - elapsedTime) / 1000);
            
            const hours = Math.floor(remainingSeconds / 3600);
            const mins = Math.floor((remainingSeconds % 3600) / 60);
            const secs = Math.floor(remainingSeconds % 60);

            let timeStr = '';
            if (hours > 0) timeStr = `${hours}h ${mins}m`;
            else if (mins > 0) timeStr = `${mins}:${String(secs).padStart(2, '0')}`;
            else timeStr = `${Math.ceil(secs)}s`;

            document.getElementById('turnTimeProgress').textContent = timeStr;
            document.getElementById('turnDistanceProgress').textContent = `${remainingDistance.toFixed(1)} km`;
            document.getElementById('turnProgressBar').style.width = `${(routeProgress * 100)}%`;

            updateSpeedDisplay(location.speed);

            const { turn: nextTurn, nextIndex } = getNextTurnInfo(closestIndex, navigationTurns);

            if (nextTurn) {
                const distanceToTurn = getDistance(
                    location.lat,
                    location.lng,
                    routeCoordinates[nextTurn.coordinateIndex].lat,
                    routeCoordinates[nextTurn.coordinateIndex].lng
                );

                if (distanceToTurn < 0.5) {
                    updateTurnDisplay(nextTurn, Math.round(distanceToTurn * 1000), `${nextTurn.icon} ${nextTurn.text}`, true);
                } else {
                    const futureIndex = nextIndex + 1;
                    if (futureIndex < navigationTurns.length) {
                        const futureTurn = navigationTurns[futureIndex];
                        const distanceToFuture = getDistance(
                            location.lat,
                            location.lng,
                            routeCoordinates[futureTurn.coordinateIndex].lat,
                            routeCoordinates[futureTurn.coordinateIndex].lng
                        );
                        
                        if (distanceToFuture < 1) {
                            updateTurnDisplay(futureTurn, Math.round(distanceToFuture * 1000), `In ${Math.round(distanceToTurn * 1000)}m, ${futureTurn.text}`, false);
                        } else {
                            updateTurnDisplay(nextTurn, distanceToTurn > 1 ? Math.round(distanceToTurn * 1000) : Math.round(distanceToTurn * 1000), nextTurn.text, false);
                        }
                    } else {
                        updateTurnDisplay({ icon: 'ðŸŽ¯', text: 'Continue to destination' }, Math.round(remainingDistance * 1000), 'Continue to destination', false);
                    }
                }
            } else {
                updateTurnDisplay({ icon: 'ðŸŽ¯', text: 'Approaching destination' }, Math.round(remainingDistance * 1000), 'Approaching destination', false);
            }
        }

        function updateMapView(location) {
            const speed = location.speed || 0;
            let zoomLevel = 18;
            
            if (speed > 20) zoomLevel = 17;
            else if (speed > 10) zoomLevel = 17.5;
            else if (speed > 5) zoomLevel = 18;
            else zoomLevel = 18.5;

            map.flyTo([location.lat, location.lng], zoomLevel, {
                duration: 0.8,
                easeLinearity: 0.25
            });
        }

        function updateSpeedDisplay(speed) {
            let speedDisplay = '0 km/h';
            if (speed !== null && speed !== undefined) {
                const kmh = Math.round((speed || 0) * 3.6);
                speedDisplay = `${kmh} km/h`;
            }

            let speedElement = document.getElementById('speedDisplay');
            if (!speedElement) {
                speedElement = document.createElement('div');
                speedElement.id = 'speedDisplay';
                speedElement.style.cssText = `
                    position: fixed;
                    bottom: 40px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, rgba(0, 127, 255, 0.95) 0%, rgba(42, 82, 190, 0.95) 100%);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 12px;
                    font-weight: 700;
                    z-index: 3001;
                    font-size: 18px;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    backdrop-filter: blur(10px);
                    box-shadow: 0 8px 24px rgba(0, 127, 255, 0.4);
                `;
                document.body.appendChild(speedElement);
            }
            speedElement.textContent = speedDisplay;
        }

        function updateDirectionIndicator(heading) {
            let directionElement = document.getElementById('directionIndicator');
            if (!directionElement) {
                directionElement = document.createElement('div');
                directionElement.id = 'directionIndicator';
                directionElement.style.cssText = `
                    position: fixed;
                    top: 90px;
                    right: 16px;
                    width: 60px;
                    height: 60px;
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1002;
                    border: 2px solid rgba(0, 127, 255, 0.3);
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
                `;
                document.body.appendChild(directionElement);
            }
            
            const arrow = document.createElement('div');
            arrow.style.cssText = `
                font-size: 32px;
                transform: rotate(${heading}deg);
                transition: transform 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            arrow.textContent = 'â¬†';
            
            directionElement.innerHTML = '';
            directionElement.appendChild(arrow);
        }

        function updateTurnDisplay(turnInfo, distance, instruction, isImmediate) {
            const arrow = document.getElementById('turnArrow');
            const distText = document.getElementById('turnDistanceText');
            const instText = document.getElementById('turnInstructionText');

            if (isImmediate) {
                arrow.style.animation = 'none';
                setTimeout(() => {
                    arrow.style.animation = 'arrowPulse 2.2s cubic-bezier(0.34, 1.56, 0.64, 1) infinite';
                }, 10);
            }

            arrow.textContent = turnInfo.icon;
            arrow.style.color = 'rgba(255, 255, 255, 0.95)';
            
            distText.style.opacity = '0.5';
            distText.style.transform = 'scale(0.8)';
            setTimeout(() => {
                distText.textContent = distance > 1000 ? `${(distance / 1000).toFixed(1)} km` : `${distance}m`;
                distText.style.opacity = '1';
                distText.style.transform = 'scale(1)';
                distText.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
            }, 100);

            instText.style.opacity = '0.5';
            setTimeout(() => {
                instText.textContent = instruction;
                instText.style.opacity = isImmediate ? '1' : '0.8';
                instText.style.transition = 'opacity 0.4s ease';
            }, 100);
        }

        function setupNavigationControls() {
            const navPanel = document.getElementById('turnByTurnPanel');
            
            if (!document.getElementById('pauseNavBtn')) {
                const pauseBtn = document.createElement('button');
                pauseBtn.id = 'pauseNavBtn';
                pauseBtn.className = 'turn-control-btn';
                pauseBtn.style.cssText = 'background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: white; grid-column: auto;';
                pauseBtn.textContent = 'â¸ Pause';
                pauseBtn.onclick = toggleNavigationPause;
                
                const controlsDiv = navPanel.querySelector('.turn-controls');
                controlsDiv.insertBefore(pauseBtn, controlsDiv.firstChild);
            }
        }

        function toggleNavigationPause() {
            const pauseBtn = document.getElementById('pauseNavBtn');
            
            if (navigationPaused) {
                navigationPaused = false;
                navPausedTime += Date.now() - navStartTime;
                navStartTime = Date.now();
                pauseBtn.textContent = 'â¸ Pause';
                pauseBtn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)';
                showToast('ðŸ§­ Navigation resumed');
                if (animationId) cancelAnimationFrame(animationId);
            } else {
                navigationPaused = true;
                pauseBtn.textContent = 'â–¶ Resume';
                pauseBtn.style.background = 'linear-gradient(135deg, #3559E8 0%, #5B7EF7 100%)';
                showToast('â¸ Navigation paused');
                if (animationId) cancelAnimationFrame(animationId);
            }
        }

        function navigationComplete() {
            navigationActive = false;
            if (animationId) cancelAnimationFrame(animationId);
            
            document.getElementById('turnDistanceText').textContent = '0m';
            document.getElementById('turnInstructionText').textContent = 'âœ“ Arrived at destination!';
            document.getElementById('turnInstructionText').style.color = 'rgba(255, 255, 255, 0.95)';
            document.getElementById('turnArrow').textContent = 'âœ“';
            document.getElementById('turnArrow').style.color = 'rgba(255, 255, 255, 0.95)';
            document.getElementById('turnProgressBar').style.width = '100%';
            
            if (vehicleMarker && vehicleMarker._icon) {
                vehicleMarker._icon.style.animation = 'markerBounce 0.6s ease-in-out 3';
            }
            
            showToast('ðŸŽ‰ You\'ve arrived at the charging station!');
            
            setTimeout(() => {
                document.getElementById('turnByTurnPanel').classList.remove('active');
                document.getElementById('routingPanel').classList.remove('active');
                endNavigation();
            }, 4000);
        }

        function endNavigation() {
            navigationActive = false;
            navigationPaused = false;
            if (animationId) cancelAnimationFrame(animationId);
            if (window.glowAnimationInterval) clearInterval(window.glowAnimationInterval);
            if (overlayTimeoutId) clearTimeout(overlayTimeoutId);
            
            if (geolocationWatchId !== null) {
                navigator.geolocation.clearWatch(geolocationWatchId);
                geolocationWatchId = null;
            }
            
            if (routePolyline && map.hasLayer(routePolyline)) {
                map.removeLayer(routePolyline);
            }
            if (vehicleMarker && map.hasLayer(vehicleMarker)) {
                map.removeLayer(vehicleMarker);
            }
            
            const speedElement = document.getElementById('speedDisplay');
            if (speedElement) speedElement.remove();
            
            const directionElement = document.getElementById('directionIndicator');
            if (directionElement) directionElement.remove();
            
            map.setZoom(14);
            
            const pauseBtn = document.getElementById('pauseNavBtn');
            if (pauseBtn) pauseBtn.remove();
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const nightModeBtn = document.getElementById('nightModeBtn');
            
            const savedNightMode = localStorage.getItem('nightMode') === 'true';
            if (savedNightMode) {
                document.body.classList.add('night-mode');
                document.getElementById('nightModeLabel').textContent = 'Light';
            }
            
            nightModeBtn.addEventListener('click', () => {
                document.body.classList.toggle('night-mode');
                const isNightMode = document.body.classList.contains('night-mode');
                localStorage.setItem('nightMode', isNightMode);
                document.getElementById('nightModeLabel').textContent = isNightMode ? 'Light' : 'Night';
            });
            
            document.getElementById('locationBtn').addEventListener('click', getUserLocation);
            document.getElementById('clearFilterBtn').addEventListener('click', clearFilter);
            document.getElementById('routingClose').addEventListener('click', () => document.getElementById('routingPanel').classList.remove('active'));
            document.getElementById('routingClose2').addEventListener('click', () => document.getElementById('routingPanel').classList.remove('active'));
            document.getElementById('turnCloseBtn').addEventListener('click', () => {
                document.getElementById('turnByTurnPanel').classList.remove('active');
                endNavigation();
            });
            document.getElementById('turnEndBtn').addEventListener('click', () => {
                document.getElementById('turnByTurnPanel').classList.remove('active');
                endNavigation();
            });

            document.getElementById('startNavBtn').addEventListener('click', () => {
                document.getElementById('routingPanel').classList.remove('active');
                startRealTimeNavigation();
            });

            document.getElementById('viewClustered').addEventListener('click', () => {
                currentView = 'clustered';
                document.getElementById('viewClustered').classList.add('active');
                document.getElementById('viewIndividual').classList.remove('active');
                renderStations();
            });

            document.getElementById('viewIndividual').addEventListener('click', () => {
                currentView = 'individual';
                document.getElementById('viewIndividual').classList.add('active');
                document.getElementById('viewClustered').classList.remove('active');
                renderStations();
            });

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                const searchResults = document.getElementById('searchResults');
                
                if (query.length < 2) {
                    searchResults.classList.remove('active');
                    return;
                }
                
                const matches = allStations.filter(station => {
                    const name = (station.properties?.name || '').toLowerCase();
                    const operator = (station.properties?.operator || '').toLowerCase();
                    return name.includes(query) || operator.includes(query);
                }).slice(0, 10);
                
                searchResults.innerHTML = matches.length === 0 ? '<div style="padding: 12px; text-align: center; color: #999;">No stations found</div>' : matches.map(station => {
                    const props = station.properties || {};
                    return `<div class="search-result-item" data-lat="${station.geometry.coordinates[1]}" data-lng="${station.geometry.coordinates[0]}"><div class="search-result-name">${props.name || 'Unknown'}</div><div class="search-result-operator">${props.operator || 'N/A'}</div></div>`;
                }).join('');
                
                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lng = parseFloat(item.dataset.lng);
                        map.setView([lat, lng], 16);
                        searchResults.classList.remove('active');
                        searchInput.value = '';
                    });
                });
                
                searchResults.classList.add('active');
            });

            document.addEventListener('click', (e) => {
                const searchResults = document.getElementById('searchResults');
                if (!e.target.closest('.search-container')) searchResults.classList.remove('active');
            });
        }

        let userLocationPulseLayer = null;

        function getUserLocation() {
            if (!navigator.geolocation) {
                showToast('Geolocation not supported');
                return;
            }
            
            const btn = document.getElementById('locationBtn');
            btn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (userMarker) map.removeLayer(userMarker);
                    if (userLocationPulseLayer) map.removeLayer(userLocationPulseLayer);
                    
                    const pulseHtml = `
                        <svg width="120" height="120" viewBox="0 0 120 120" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;">
                            <circle cx="60" cy="60" r="0" fill="none" stroke="#10b981" stroke-width="2" opacity="0.8" class="location-pulse-circle" style="animation-delay: 0s;"/>
                            <circle cx="60" cy="60" r="0" fill="none" stroke="#34d399" stroke-width="2" opacity="0.6" class="location-pulse-circle" style="animation-delay: 0.66s;"/>
                            <circle cx="60" cy="60" r="0" fill="none" stroke="#6ee7b7" stroke-width="2" opacity="0.4" class="location-pulse-circle" style="animation-delay: 1.32s;"/>
                        </svg>
                    `;
                    
                    userLocationPulseLayer = L.marker([userLocation.lat, userLocation.lng], {
                        icon: L.divIcon({
                            html: pulseHtml,
                            iconSize: [120, 120],
                            iconAnchor: [60, 60],
                            className: 'location-pulse-marker'
                        })
                    }).addTo(map);
                    
                    const userIcon = L.divIcon({
                        html: '<div class="user-location-marker" style="width: 20px; height: 20px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);"></div>',
                        iconSize: [24, 24], iconAnchor: [12, 12],
                        className: 'user-marker-wrapper'
                    });
                    
                    userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map);
                    map.setView([userLocation.lat, userLocation.lng], 14);
                    updateNearestStations();
                    btn.disabled = false;
                },
                () => {
                    showToast('Unable to get location');
                    btn.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        window.getDirections = getDirections;
        window.closeStationDetail = closeStationDetail;
        window.startDirectionsFromDetail = startDirectionsFromDetail;

        initSDK();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cbb96b0564d6312',t:'MTc3MDcyNjMyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
