<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>EV Station Finder - Navigation &amp; Route Planning</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css">
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        html, body, #root {
            height: 100%;
            width: 100%;
        }

        #map {
            height: calc(100% - 70px);
            width: 100%;
            background: #e5e3df;
            margin-top: 70px;
            margin-left: 0;
            transition: margin-left 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            gap: 15px;
        }

        #mapTitle {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-right: auto;
        }

        .search-container {
            position: relative;
            width: 300px;
            height: 40px;
        }

        #searchInput {
            width: 100%;
            height: 100%;
            padding: 0 12px;
            border: 1px solid #d0d0d0;
            border-radius: 20px;
            font-size: 14px;
            background: white;
            outline: none;
            transition: all 0.3s;
        }

        #searchInput:focus {
            border-color: #007FFF;
            box-shadow: 0 0 0 3px rgba(0, 127, 255, 0.1);
        }

        #searchResults {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 200;
        }

        #searchResults.active {
            opacity: 1;
            pointer-events: all;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:active {
            background: #f0f0f0;
        }

        .search-result-name {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .search-result-operator {
            font-size: 12px;
            color: #999;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            color: #333;
            border: 1px solid #d0d0d0;
            -webkit-user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
            background: #f0f0f0;
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        .side-panel {
            position: fixed;
            left: 16px;
            top: 90px;
            width: 280px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
            overflow-y: hidden;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 130px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .panel-section {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }

        .panel-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: linear-gradient(135deg, #e0eeff 0%, #cce0ff 100%);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #99ccff;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #2a52be;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .state-summary-grid-container {
            max-height: 140px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .state-summary-grid-container::-webkit-scrollbar {
            width: 6px;
        }

        .state-summary-grid-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .state-summary-grid-container::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }

        .state-summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .state-summary-card {
            background: linear-gradient(135deg, #e6f0ff 0%, #cce5ff 100%);
            padding: 10px 12px;
            border-radius: 8px;
            border: 1.5px solid #99ccff;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .state-summary-card:active {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(15, 82, 186, 0.15);
            border-color: #0f52ba;
        }

        .state-summary-card.active {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            border-color: #2a52be;
            box-shadow: 0 4px 12px rgba(0, 127, 255, 0.3);
        }

        .state-summary-name {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .state-summary-card.active .state-summary-name {
            color: white;
        }

        .state-summary-count {
            font-size: 14px;
            font-weight: 900;
            color: #2a52be;
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 8px;
            border-radius: 6px;
            min-width: 35px;
            text-align: center;
        }

        .state-summary-card.active .state-summary-count {
            color: #0f52ba;
            background: white;
        }

        .nearest-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .nearest-item:active {
            border-color: #007FFF;
            box-shadow: 0 2px 8px rgba(0, 127, 255, 0.2);
        }

        .nearest-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .nearest-distance {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #nearestList {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        #nearestList::-webkit-scrollbar {
            width: 6px;
        }

        #nearestList::-webkit-scrollbar-track {
            background: transparent;
        }

        #nearestList::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }

        .routing-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            transform: translateY(120%);
            transition: transform 0.3s ease;
            z-index: 10001;
        }

        .routing-panel.active {
            transform: translateY(0);
        }

        .routing-header {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .routing-destination {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 16px;
        }

        .routing-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }

        .routing-content {
            padding: 16px;
        }

        .routing-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .routing-stat-label {
            color: #666;
            font-weight: 600;
        }

        .routing-stat-value {
            color: #2a52be;
            font-weight: 700;
        }

        .battery-section {
            margin: 16px 0;
        }

        .battery-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .battery-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        #batteryFill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            width: 100%;
            transition: width 0.3s, background 0.3s;
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 16px;
        }

        .nav-button {
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .nav-button.primary {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
        }

        .nav-button.primary:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 127, 255, 0.3);
        }

        .nav-button.secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #d0d0d0;
        }

        .turn-instruction-bar {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
            padding: 18px 28px;
            border-radius: 16px;
            z-index: 1002;
            box-shadow: 0 20px 40px rgba(0, 127, 255, 0.25);
            max-width: 90%;
            width: 520px;
            text-align: center;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            animation: instructionSlideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            right: 50%;
        }

        @keyframes instructionSlideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .turn-instruction-bar.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .turn-instruction-icon {
            font-size: 32px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .turn-instruction-distance {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 2px;
            letter-spacing: -0.5px;
            font-family: 'Segoe UI', 'Courier New', monospace;
        }

        .turn-instruction-text {
            font-size: 13px;
            opacity: 0.92;
            font-weight: 500;
            letter-spacing: 0.3px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .map-legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            min-width: 240px;
            border: 1px solid #e0e0e0;
            max-height: 70vh;
            overflow-y: auto;
        }

        .legend-title {
            font-weight: 700;
            font-size: 13px;
            color: #1a1a1a;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #666;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color-box {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .station-detail-panel {
            position: fixed;
            top: 90px;
            right: 16px;
            width: 320px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
            z-index: 9998;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            transform: translateX(400px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        .station-detail-panel.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: all;
        }

        .station-detail-header {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
            padding: 20px 16px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .station-detail-header-content {
            flex: 1;
            min-width: 0;
        }

        .station-detail-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
            line-height: 1.3;
            word-break: break-word;
        }

        .station-detail-subtitle {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 500;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .station-detail-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .station-detail-close:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .station-detail-body {
            padding: 20px 16px;
        }

        .detail-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .detail-item:last-of-type {
            margin-bottom: 0;
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e0eeff 0%, #cce0ff 100%);
            border: 1.5px solid #99ccff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2a52be;
            flex-shrink: 0;
        }

        .detail-content {
            flex: 1;
            min-width: 0;
        }

        .detail-label {
            font-size: 11px;
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 3px;
        }

        .detail-value {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
            line-height: 1.4;
        }

        .station-detail-divider {
            height: 1px;
            background: #f0f0f0;
            margin: 16px 0;
        }

        .station-detail-action {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        }

        .station-detail-action:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
        }

        .view-toggle {
            display: flex;
            gap: 6px;
            background: white;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid #d0d0d0;
        }

        .view-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        @keyframes vehiclePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        @keyframes routeGlow {
            0%, 100% {
                filter: drop-shadow(0 0 2px rgba(53, 89, 232, 0.3));
            }
            50% {
                filter: drop-shadow(0 0 8px rgba(53, 89, 232, 0.6));
            }
        }

        @keyframes locationPulse {
            0% {
                r: 0;
                opacity: 1;
            }
            100% {
                r: 30;
                opacity: 0;
            }
        }

        .location-pulse-circle {
            animation: locationPulse 2s ease-out infinite;
        }

        @keyframes markerPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .user-location-marker {
            animation: markerPulse 2s infinite;
        }

        .animated-vehicle-marker {
            animation: vehiclePulse 2s infinite;
        }

        .animated-route-line {
            animation: routeGlow 2s ease-in-out infinite;
        }

        .nav-hud {
            position: fixed;
            bottom: 40px;
            right: 20px;
            background: white;
            color: #1a1a1a;
            padding: 14px 16px;
            border-radius: 18px;
            z-index: 3002;
            border: 1px solid #e0e0e0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            display: none;
            flex-direction: column;
            gap: 10px;
            min-width: 260px;
            animation: hudSlideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes hudSlideUp {
            from {
                opacity: 0;
                transform: translateY(16px) translateX(16px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) translateX(0) scale(1);
            }
        }

        .nav-hud.active {
            display: flex;
        }

        .hud-metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .hud-metric-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: linear-gradient(135deg, #e0eeff 0%, #cce0ff 100%);
            border-radius: 12px;
            border: 1.5px solid #99ccff;
            transition: all 0.25s ease;
            justify-content: center;
        }

        .hud-metric-row:hover {
            background: linear-gradient(135deg, #cce0ff 0%, #99ccff 100%);
            border-color: #5b7eef;
            transform: translateY(-1px);
        }

        .hud-icon {
            font-size: 20px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            border-radius: 8px;
            color: white;
            flex-shrink: 0;
        }

        .hud-metric-content {
            flex: 1;
            min-width: 0;
        }

        .hud-label {
            font-size: 9px;
            opacity: 0.55;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            font-weight: 700;
            color: #666;
            margin-bottom: 1px;
        }

        .hud-value {
            font-size: 18px;
            font-weight: 800;
            letter-spacing: -0.4px;
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1;
        }

        .hud-divider {
            height: 1px;
            background: linear-gradient(90deg, rgba(0, 127, 255, 0.1) 0%, transparent 100%);
            margin: 6px 0 4px 0;
        }

        .nav-control-buttons {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }

        .nav-control-btn {
            flex: 1;
            padding: 9px 12px;
            border: 1.5px solid #d0d0d0;
            background: white;
            color: #333;
            border-radius: 10px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            transition: all 0.2s ease;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .nav-control-btn:active {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
            border-color: #007FFF;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 127, 255, 0.2);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .header {
                height: 60px;
                padding: 0 12px;
                gap: 8px;
            }

            #mapTitle {
                font-size: 16px;
            }

            .search-container {
                width: 140px;
                height: 36px;
            }

            #searchInput {
                font-size: 12px;
                padding: 0 10px;
            }

            .control-buttons {
                gap: 4px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            #map {
                margin-top: 60px;
                height: calc(100% - 60px);
            }

            .side-panel {
                left: 8px;
                top: 70px;
                width: 250px;
                max-height: calc(100vh - 100px);
                border-radius: 12px;
            }

            .panel-section {
                padding: 12px;
            }

            .section-title {
                font-size: 11px;
                margin-bottom: 8px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 10px;
            }

            .stat-card {
                padding: 8px;
                border-radius: 8px;
            }

            .stat-value {
                font-size: 16px;
            }

            .stat-label {
                font-size: 10px;
            }

            .state-summary-card {
                padding: 8px 10px;
                font-size: 12px;
            }

            .state-summary-count {
                font-size: 12px;
                padding: 2px 6px;
                min-width: 30px;
            }

            .nearest-item {
                padding: 10px;
                margin-bottom: 6px;
            }

            .nearest-name {
                font-size: 13px;
                margin-bottom: 3px;
            }

            .nearest-distance {
                font-size: 11px;
            }

            .routing-panel {
                width: 90%;
                max-width: 320px;
                bottom: 10px;
                right: 5%;
                left: 5%;
            }

            .routing-header {
                padding: 12px;
            }

            .routing-destination {
                font-size: 14px;
            }

            .routing-content {
                padding: 12px;
            }

            .routing-stat {
                font-size: 13px;
                margin-bottom: 10px;
            }

            .nav-buttons {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                margin-top: 12px;
            }

            .nav-button {
                padding: 8px;
                font-size: 12px;
            }

            .turn-instruction-bar {
                width: 90%;
                max-width: 320px;
                left: 5%;
                right: 5%;
                padding: 12px 16px;
                top: 70px;
            }

            .turn-instruction-icon {
                font-size: 24px;
                margin-bottom: 6px;
            }

            .turn-instruction-distance {
                font-size: 20px;
                margin-bottom: 2px;
            }

            .turn-instruction-text {
                font-size: 12px;
            }

            @media (max-width: 480px) {
                .turn-instruction-bar {
                    width: 92%;
                    max-width: 100%;
                    left: 4%;
                    right: 4%;
                    padding: 10px 14px;
                    top: 66px;
                    gap: 8px;
                }

                .turn-instruction-icon {
                    font-size: 20px;
                    width: 36px;
                    height: 36px;
                    margin-bottom: 4px;
                }

                .turn-instruction-distance {
                    font-size: 18px;
                    margin-bottom: 1px;
                    letter-spacing: -0.3px;
                }

                .turn-instruction-text {
                    font-size: 11px;
                    opacity: 0.9;
                    max-width: 90%;
                    word-break: break-word;
                    line-height: 1.3;
                }

                .nav-hud {
                    bottom: 12px;
                    right: 8px;
                    left: 8px;
                    width: calc(100% - 16px);
                    padding: 12px 14px;
                    min-width: unset;
                    gap: 10px;
                    border-radius: 14px;
                    max-height: 90vh;
                    overflow-y: auto;
                }

                .hud-metric-row {
                    padding: 8px 10px;
                    border-radius: 10px;
                    gap: 8px;
                }

                .hud-icon {
                    width: 24px;
                    height: 24px;
                    font-size: 14px;
                    border-radius: 6px;
                    flex-shrink: 0;
                }

                .hud-label {
                    font-size: 8px;
                    letter-spacing: 0.5px;
                }

                .hud-value {
                    font-size: 16px;
                    font-weight: 800;
                    letter-spacing: -0.3px;
                }

                .nav-control-buttons {
                    gap: 6px;
                    margin-top: 8px;
                }

                .nav-control-btn {
                    padding: 7px 10px;
                    font-size: 10px;
                    border-radius: 8px;
                    letter-spacing: 0.3px;
                }
            }

            .station-detail-panel {
                width: 95%;
                max-width: 320px;
                right: 2.5%;
                left: 2.5%;
                top: auto;
                bottom: 60px;
                max-height: 70vh;
                transform: translateY(120%);
            }

            .station-detail-panel.active {
                transform: translateY(0);
            }

            .station-detail-header {
                padding: 14px 12px;
            }

            .station-detail-title {
                font-size: 14px;
            }

            .station-detail-close {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            .station-detail-body {
                padding: 12px;
            }

            .detail-item {
                gap: 10px;
                margin-bottom: 12px;
            }

            .detail-icon {
                width: 36px;
                height: 36px;
                border-radius: 8px;
            }

            .detail-label {
                font-size: 10px;
            }

            .detail-value {
                font-size: 13px;
            }

            .station-detail-divider {
                margin: 12px 0;
            }

            .station-detail-action {
                padding: 10px;
                font-size: 13px;
            }

            .nav-hud {
                bottom: 20px;
                right: 10px;
                left: 10px;
                width: auto;
                padding: 12px 16px;
                min-width: unset;
            }

            .hud-label {
                font-size: 10px;
            }

            .hud-value {
                font-size: 20px;
            }

            .hud-divider {
                margin: 6px 0;
            }

            .nav-control-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .map-legend {
                width: 90%;
                max-width: 280px;
                bottom: 90px;
                right: 5%;
                left: auto;
                padding: 12px;
            }

            .legend-title {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .legend-item {
                gap: 8px;
                margin-bottom: 8px;
                font-size: 11px;
            }

            .legend-color-box {
                width: 16px;
                height: 16px;
            }

            .battery-section {
                margin: 12px 0;
            }

            .battery-header {
                font-size: 12px;
                margin-bottom: 6px;
            }

            .battery-bar {
                height: 6px;
            }
        }

        @media (max-width: 480px) {
            .header {
                height: 56px;
                padding: 0 8px;
                gap: 4px;
            }

            #mapTitle {
                font-size: 14px;
            }

            .search-container {
                display: none;
            }

            .btn {
                padding: 5px 8px;
                font-size: 11px;
            }

            .btn span {
                display: none;
            }

            .btn svg {
                width: 14px;
                height: 14px;
            }

            #map {
                margin-top: 56px;
                height: calc(100% - 56px);
            }

            .side-panel {
                left: 4px;
                top: 64px;
                width: calc(100% - 8px);
                max-width: 100%;
                max-height: calc(100vh - 95px);
                border-radius: 10px;
                display: none;
                z-index: 1500;
            }

            .side-panel.mobile-open {
                display: flex;
            }

            .panel-section {
                padding: 10px;
            }

            .section-title {
                font-size: 10px;
                margin-bottom: 6px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                margin-bottom: 8px;
            }

            .stat-card {
                padding: 6px;
            }

            .stat-value {
                font-size: 14px;
            }

            .stat-label {
                font-size: 9px;
            }

            .state-summary-card {
                padding: 6px 8px;
                font-size: 11px;
                margin-bottom: 4px;
            }

            .state-summary-count {
                font-size: 11px;
                padding: 2px 4px;
                min-width: 26px;
            }

            .nearest-item {
                padding: 8px;
                margin-bottom: 4px;
            }

            .nearest-name {
                font-size: 12px;
            }

            .nearest-distance {
                font-size: 10px;
            }

            .routing-panel {
                width: 96%;
                max-width: 100%;
                bottom: 5px;
                right: 2%;
                left: 2%;
                max-height: 60vh;
                border-radius: 12px;
            }

            .routing-header {
                padding: 10px;
            }

            .routing-destination {
                font-size: 13px;
            }

            .routing-content {
                padding: 10px;
                font-size: 12px;
            }

            .routing-stat {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .nav-buttons {
                gap: 4px;
                margin-top: 10px;
            }

            .nav-button {
                padding: 6px;
                font-size: 11px;
            }

            .turn-instruction-bar {
                width: 90%;
                max-width: 320px;
                left: 50% !important;
                right: auto !important;
                transform: translateX(-50%) !important;
                padding: 12px 16px;
                top: 70px;
            }

            .turn-instruction-icon {
                font-size: 20px;
            }

            .turn-instruction-distance {
                font-size: 18px;
            }

            .turn-instruction-text {
                font-size: 11px;
            }

            .station-detail-panel {
                width: 98%;
                left: 1%;
                right: 1%;
                bottom: 45px;
                top: auto;
                max-height: 70vh;
                transform: translateY(120%);
                border-radius: 12px;
            }

            .station-detail-panel.active {
                transform: translateY(0);
            }

            .station-detail-header {
                padding: 12px 10px;
            }

            .station-detail-title {
                font-size: 13px;
            }

            .station-detail-close {
                width: 26px;
                height: 26px;
                font-size: 14px;
            }

            .station-detail-body {
                padding: 10px;
                max-height: 60vh;
                overflow-y: auto;
            }

            .detail-item {
                gap: 8px;
                margin-bottom: 10px;
            }

            .detail-icon {
                width: 32px;
                height: 32px;
            }

            .detail-label {
                font-size: 9px;
            }

            .detail-value {
                font-size: 12px;
            }

            .station-detail-action {
                padding: 8px;
                font-size: 12px;
            }

            .nav-hud {
                bottom: 12px;
                right: 10px;
                left: 10px;
                width: auto;
                padding: 16px;
                min-width: unset;
                gap: 14px;
            }

            .hud-label {
                font-size: 10px;
            }

            .hud-value {
                font-size: 24px;
            }

            .hud-divider {
                margin: 6px 0;
            }

            .nav-control-btn {
                padding: 10px 8px;
                font-size: 11px;
            }

            .map-legend {
                display: none;
            }

            .battery-section {
                margin: 10px 0;
            }

            .battery-header {
                font-size: 11px;
            }

            .battery-bar {
                height: 5px;
            }
        }

        body.night-mode .header {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            border-bottom-color: #333;
        }

        body.night-mode #map {
            background: #1a1a1a;
        }

        body.night-mode .side-panel,
        body.night-mode .routing-panel,
        body.night-mode .map-legend {
            background: #2a2a2a;
            border-color: #444;
        }

        body.night-mode .btn {
            background: #1f1f1f;
            color: #e0e0e0;
            border-color: #444;
        }

        body.night-mode .btn:active {
            background: #333;
            border-color: #666;
        }

        .mobile-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1400;
        }

        .mobile-panel-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        #mobileMenuBtn {
            display: none !important;
        }

        @media (max-width: 480px) {
            #mobileMenuBtn {
                display: flex !important;
                order: -1;
            }

            #mapTitle {
                flex: 1;
                margin-right: auto;
            }

            .side-panel {
                transform: translateX(-120%);
                transition: transform 0.3s ease;
                z-index: 1500;
                top: 56px;
                max-height: calc(100vh - 56px);
                left: 0;
                border-radius: 0;
                width: 280px;
            }

            .side-panel.mobile-open {
                transform: translateX(0);
            }

            .turn-instruction-bar {
                gap: 6px;
            }

            .turn-instruction-distance {
                font-size: 18px;
                margin-bottom: 1px;
                letter-spacing: -0.3px;
            }

            .turn-instruction-text {
                font-size: 11px;
                opacity: 0.92;
                max-width: 280px;
                word-break: break-word;
                line-height: 1.3;
                hyphens: auto;
            }

            .turn-instruction-icon {
                font-size: 20px;
                width: 32px;
                height: 32px;
                border-radius: 8px;
            }

            @media (max-width: 380px) {
                .turn-instruction-bar {
                    width: 88%;
                    left: 6%;
                    right: 6%;
                    padding: 10px 12px;
                    top: 64px;
                }

                .turn-instruction-distance {
                    font-size: 16px;
                }

                .turn-instruction-text {
                    font-size: 10px;
                    max-width: 240px;
                    line-height: 1.2;
                }

                .turn-instruction-icon {
                    font-size: 18px;
                    width: 28px;
                    height: 28px;
                    margin-bottom: 2px;
                }

                .nav-hud {
                    bottom: 8px;
                    right: 6px;
                    left: 6px;
                    width: calc(100% - 12px);
                    padding: 12px 12px;
                    min-width: unset;
                    gap: 8px;
                    border-radius: 12px;
                }

                .hud-metric-row {
                    padding: 8px 10px;
                    gap: 8px;
                    border-radius: 10px;
                }

                .hud-icon {
                    width: 22px;
                    height: 22px;
                    font-size: 12px;
                    border-radius: 5px;
                }

                .hud-label {
                    font-size: 7px;
                    letter-spacing: 0.4px;
                }

                .hud-value {
                    font-size: 14px;
                    font-weight: 700;
                    letter-spacing: -0.3px;
                }

                .nav-control-buttons {
                    gap: 6px;
                    margin-top: 6px;
                }

                .nav-control-btn {
                    padding: 6px 8px;
                    font-size: 9px;
                    border-radius: 6px;
                    letter-spacing: 0.2px;
                }

                .routing-panel {
                    width: 94%;
                    left: 3%;
                    right: 3%;
                    max-width: 100%;
                }

                .station-detail-panel {
                    width: 96%;
                    left: 2%;
                    right: 2%;
                }
            }
        }
    </style>
  <script src="/_sdk/element_sdk.js"></script>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="root" style="height: 100%; width: 100%;">
   <div id="map"></div>
   <div class="header"><button id="mobileMenuBtn" class="btn" style="display: none;">
     <svg fill="currentColor" viewbox="0 0 24 24">
      <path d="M3 12h18M3 6h18M3 18h18" />
     </svg></button>
    <div id="mapTitle">
     ‚ö° EV Station Finder
    </div>
    <div class="search-container"><input id="searchInput" type="text" placeholder="Search stations...">
     <div id="searchResults"></div>
    </div>
    <div class="control-buttons"><button id="nightModeBtn" class="btn">
      <svg fill="currentColor" viewbox="0 0 24 24">
       <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
      </svg><span id="nightModeLabel">Night</span> </button> <button id="locationBtn" class="btn">
      <svg fill="currentColor" viewbox="0 0 24 24">
       <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
      </svg> Locate </button>
    </div>
   </div>
   <div id="mobilePanelOverlay" class="mobile-panel-overlay"></div>
   <div id="sidePanel" class="side-panel">
    <div class="panel-section" style="padding: 16px; border-bottom: 1px solid #f0f0f0;">
     <div style="margin-bottom: 4px;">
      <div style="font-size: 18px; font-weight: 900; color: #1a1a1a;">
       ‚ö° EV Stations
      </div>
     </div>
     <div style="font-size: 12px; color: #999; font-weight: 500;">
      Filter &amp; explore charging stations
     </div>
    </div>
    <div class="panel-section" style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
     <div class="section-title">
      üó∫Ô∏è States
     </div><button id="clearFilterBtn" class="btn" style="font-size: 11px; padding: 4px 8px; display: none;">Clear</button>
     <div class="state-summary-grid-container">
      <div style="display: flex; gap: 6px; margin-bottom: 12px; background: white; padding: 4px; border-radius: 12px; border: 1px solid #d0d0d0;"><button id="viewClustered" class="view-btn active" style="flex: 1; padding: 6px 12px;">Clustered</button> <button id="viewIndividual" class="view-btn" style="flex: 1; padding: 6px 12px;">Individual</button>
      </div>
      <div id="stateSummary" class="state-summary-grid"></div>
     </div>
    </div>
    <div class="panel-section" style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
     <div class="section-title">
      üìä Overall Stats
     </div>
     <div class="stats-grid">
      <div class="stat-card">
       <div class="stat-value" id="totalStations">
        0
       </div>
       <div class="stat-label">
        Total Stations
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-value" id="totalStates">
        0
       </div>
       <div class="stat-label">
        States
       </div>
      </div>
     </div>
    </div>
    <div class="panel-section" style="padding: 12px; flex: 1; display: flex; flex-direction: column; min-height: 0; border-bottom: none;">
     <div class="section-title">
      üîã Nearest Stations
     </div>
     <div id="nearestList"></div>
    </div>
   </div>
   <div id="routingPanel" class="routing-panel">
    <div class="routing-header">
     <div class="routing-destination" id="routingDestination">
      Loading...
     </div><button id="routingClose" class="routing-close">‚úï</button>
    </div>
    <div class="routing-content">
     <div class="routing-stat"><span class="routing-stat-label">Distance</span> <span class="routing-stat-value" id="routingDistance">-- km</span>
     </div>
     <div class="routing-stat"><span class="routing-stat-label">Time</span> <span class="routing-stat-value" id="routingTime">--:--</span>
     </div>
     <div class="routing-stat"><span class="routing-stat-label">Avg Speed</span> <span class="routing-stat-value" id="routingSpeed">-- km/h</span>
     </div>
     <div class="battery-section">
      <div class="battery-header"><span>üîã Battery Impact</span> <span id="batteryRemaining">100%</span>
      </div>
      <div class="battery-bar">
       <div id="batteryFill" style="width: 100%;"></div>
      </div>
      <div style="font-size: 11px; color: #999; margin-top: 6px;"><span id="batteryUsed">0 kWh used</span>
      </div>
     </div>
     <div class="nav-buttons"><button id="startNavBtn" class="nav-button primary">Navigate</button> <button id="routingClose2" class="nav-button secondary">Cancel</button>
     </div>
    </div>
   </div>
   <div id="turnInstructionBar" class="turn-instruction-bar">
    <div class="turn-instruction-icon" id="turnArrow">
     <svg viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" style="width: 22px; height: 22px;"><polyline points="12 5 19 12 12 19" /><line x1="19" y1="12" x2="5" y2="12" />
     </svg>
    </div>
    <div class="turn-instruction-distance" id="turnDistanceText">
     -- km
    </div>
    <div class="turn-instruction-text" id="turnInstructionText">
     Navigation active
    </div>
   </div>
   <div id="navHUD" class="nav-hud">
    <div class="hud-metric-row">
     <div class="hud-metric-content">
      <div class="hud-label">
       Distance
      </div>
      <div class="hud-value" id="hudDistance">
       -- km
      </div>
     </div>
    </div>
    <div class="hud-metric-row">
     <div class="hud-metric-content">
      <div class="hud-label">
       ETA
      </div>
      <div class="hud-value" id="hudTime">
       --:--
      </div>
     </div>
    </div>
    <div class="hud-metric-row">
     <div class="hud-metric-content">
      <div class="hud-label">
       Speed
      </div>
      <div class="hud-value" id="hudSpeed">
       -- km/h
      </div>
     </div>
    </div>
    <div class="nav-control-buttons"><button class="nav-control-btn" onclick="toggleNavigationPause()">‚è∏ Pause</button> <button class="nav-control-btn" onclick="endNavigation()">üõë End</button>
    </div>
   </div>
   <div id="stationDetailPanel" class="station-detail-panel">
    <div class="station-detail-header">
     <div class="station-detail-header-content">
      <div class="station-detail-title" id="detailStationName">
       Station Name
      </div>
      <div class="station-detail-subtitle">
       üîå EV Charging
      </div>
     </div><button class="station-detail-close" onclick="closeStationDetail()">‚úï</button>
    </div>
    <div class="station-detail-body">
     <div class="detail-item">
      <div class="detail-icon">
       <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
       </svg>
      </div>
      <div class="detail-content">
       <div class="detail-label">
        Operator
       </div>
       <div class="detail-value" id="detailOperator">
        -
       </div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-icon">
       <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
       </svg>
      </div>
      <div class="detail-content">
       <div class="detail-label">
        Location
       </div>
       <div class="detail-value" id="detailState">
        -
       </div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-icon">
       <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="12" cy="12" r="1" /> <circle cx="19" cy="12" r="1" /> <circle cx="5" cy="12" r="1" />
       </svg>
      </div>
      <div class="detail-content">
       <div class="detail-label">
        Available Chargers
       </div>
       <div class="detail-value" id="detailChargers">
        -
       </div>
      </div>
     </div>
     <div class="station-detail-divider"></div><button class="station-detail-action" onclick="startDirectionsFromDetail()">
      <svg viewbox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z" />
      </svg> Directions </button>
    </div>
   </div>
   <div id="mapLegend" class="map-legend">
    <div class="legend-title">
     <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" />
     </svg> Map Legend
    </div>
    <div style="margin-bottom: 12px;">
     <div style="font-size: 11px; text-transform: uppercase; color: #999; margin-bottom: 8px; font-weight: 600;">
      Marker Types
     </div>
     <div class="legend-item">
      <div class="legend-color-box" style="background: linear-gradient(135deg, #3559E8 0%, #5B7EF7 100%);"></div><span>EV Station</span>
     </div>
     <div class="legend-item">
      <div class="legend-color-box" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);"></div><span>Filtered Station</span>
     </div>
    </div>
   </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script>
        const defaultConfig = {
            map_title: '‚ö° EV Station Finder',
            search_placeholder: 'Search stations...'
        };

        let config = { ...defaultConfig };
        let map, markerClusterGroup, userMarker;
        let allStations = [];
        let stateData = {};
        let userLocation = null;
        let selectedStation = null;
        let currentView = 'clustered';
        let allMarkersArray = [];
        let routePolyline = null;
        let vehicleMarker = null;
        let routeCoordinates = [];
        let navigationActive = false;
        let navigationPaused = false;
        let geolocationWatchId = null;
        let navigationDestination = null;
        let totalRoutDistance = 0;
        let navigationStartTime = 0;
        let navigationPauseTime = 0;
        let isMobile = window.innerWidth <= 480;

        async function initSDK() {
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (newConfig) => {
                        config = { ...defaultConfig, ...newConfig };
                        applyConfig();
                    },
                    mapToCapabilities: (cfg) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (cfg) => new Map([
                        ['map_title', cfg.map_title || defaultConfig.map_title],
                        ['search_placeholder', cfg.search_placeholder || defaultConfig.search_placeholder]
                    ])
                });
                config = { ...defaultConfig, ...window.elementSdk.config };
            }
            applyConfig();
            initMap();
        }

        function applyConfig() {
            document.getElementById('mapTitle').textContent = config.map_title || defaultConfig.map_title;
            document.getElementById('searchInput').placeholder = config.search_placeholder || defaultConfig.search_placeholder;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function getOSRMRoute(startLat, startLng, endLat, endLng) {
            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
                const response = await fetch(url, { method: 'GET' });
                const data = await response.json();
                
                if (!response.ok || data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
                    throw new Error('OSRM routing failed');
                }
                
                const route = data.routes[0];
                const coordinates = route.geometry.coordinates.map(coord => ({
                    lat: coord[1],
                    lng: coord[0]
                }));
                
                return {
                    summary: { 
                        lengthInMeters: route.distance, 
                        travelTimeInSeconds: route.duration 
                    },
                    legs: [{ points: coordinates }]
                };
            } catch (error) {
                showErrorToast('Route calculation failed');
                throw error;
            }
        }

        async function getDirections(lat, lng, name) {
            if (!userLocation) {
                showToast('Please enable your location first');
                document.getElementById('locationBtn').click();
                return;
            }
            
            selectedStation = { lat, lng, name };
            
            if (isMobile) {
                document.getElementById('sidePanel').classList.remove('mobile-open');
            }
            
            try {
                showToast('üõ£Ô∏è Calculating route...');
                const routeData = await getOSRMRoute(userLocation.lat, userLocation.lng, lat, lng);
                
                const summary = routeData.summary;
                const distance = (summary.lengthInMeters / 1000).toFixed(1);
                const time = Math.round(summary.travelTimeInSeconds / 60);
                const avgSpeed = (summary.lengthInMeters / summary.travelTimeInSeconds * 3.6).toFixed(0);
                
                routeCoordinates = routeData.legs[0].points || [];
                totalRoutDistance = distance;
                
                const batteryCapacity = 60;
                const consumptionRate = 17;
                const batteryUsed = (distance * consumptionRate / 100).toFixed(1);
                const batteryPercent = Math.max(0, 100 - (batteryUsed / batteryCapacity * 100)).toFixed(0);
                
                document.getElementById('routingDestination').textContent = name;
                document.getElementById('routingDistance').textContent = `${distance} km`;
                document.getElementById('routingTime').textContent = `${Math.floor(time / 60)}h ${time % 60}m`;
                document.getElementById('routingSpeed').textContent = `${avgSpeed} km/h`;
                document.getElementById('batteryFill').style.width = `${batteryPercent}%`;
                document.getElementById('batteryUsed').textContent = `${batteryUsed} kWh used`;
                document.getElementById('batteryRemaining').textContent = `${batteryPercent}% remaining`;
                
                const batteryFill = document.getElementById('batteryFill');
                if (batteryPercent < 20) {
                    batteryFill.style.background = 'linear-gradient(90deg, #ef4444 0%, #f87171 100%)';
                } else if (batteryPercent < 50) {
                    batteryFill.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';
                } else {
                    batteryFill.style.background = 'linear-gradient(90deg, #10b981 0%, #34d399 100%)';
                }
                
                displayRouteOnMap();
                
                document.getElementById('routingPanel').classList.add('active');
                showToast('‚ö° Route ready! Click "Start Navigation" to begin...');
                
                const bounds = L.latLngBounds(routeCoordinates.map(c => [c.lat, c.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
                
            } catch (error) {
                showErrorToast(`Route failed: ${error.message}`);
            }
            
            map.closePopup();
        }

        function displayRouteOnMap() {
            if (!routeCoordinates || routeCoordinates.length === 0) return;

            if (routePolyline && map.hasLayer(routePolyline)) map.removeLayer(routePolyline);

            const routePath = routeCoordinates.map(c => [c.lat, c.lng]);
            
            routePolyline = L.polyline(routePath, {
                color: '#007FFF',
                weight: 8,
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
        }

        function initMap() {
            map = L.map('map', {
                center: [4.2105, 101.9758], zoom: 7, zoomControl: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                maxZoom: 19,
                crossOrigin: 'anonymous'
            }).addTo(map);

            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 60, iconCreateFunction: createClusterIcon
            });

            loadEVStations();
            setupEventListeners();
        }

        function createClusterIcon(cluster) {
            const count = cluster.getChildCount();
            let size, color;
            if (count < 10) { size = 'small'; color = '#4DE9FF'; }
            else if (count < 50) { size = 'medium'; color = '#00D9FF'; }
            else { size = 'large'; color = '#00A8CC'; }
            
            return L.divIcon({
                html: `<div style="background: linear-gradient(135deg, ${color}, #7C3AED); width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; font-size: 12px; border: 3px solid white; box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);">${count}</div>`,
                className: `marker-cluster marker-cluster-${size}`,
                iconSize: size === 'small' ? [40, 40] : size === 'medium' ? [50, 50] : [60, 60],
                iconAnchor: [size === 'small' ? 20 : size === 'medium' ? 25 : 30, size === 'small' ? 20 : size === 'medium' ? 25 : 30]
            });
        }

        async function loadEVStations() {
            try {
                showToast('‚ö° Loading stations...');
                const response = await fetch('data/ev_station.geojson');
                const data = await response.json();
                
                if (!data.features || data.features.length === 0) {
                    throw new Error('No stations found');
                }

                allStations = data.features.map((feature, idx) => {
                    const props = feature.properties || {};
                    const coords = feature.geometry?.coordinates || [0, 0];
                    
                    return {
                        properties: {
                            name: props.name || props.station_name || 'Unknown Station',
                            operator: props.operator || props.company || 'N/A',
                            state: props.state || props.province || 'Unknown',
                            chargers: parseInt(props.chargers) || 1
                        },
                        geometry: { 
                            coordinates: [coords[0], coords[1]]
                        },
                        id: idx
                    };
                });

                processStations();
                renderStations();
                updateStats();
                populateStateList();
                updateNearestStations();
                showToast(`‚úÖ Loaded ${allStations.length} stations`);

            } catch (error) {
                console.error('Load error:', error);
                showErrorToast(`Load failed: ${error.message}`);
            }
        }

        function processStations() {
            stateData = {};
            allStations.forEach(station => {
                const state = station.properties?.state || 'Unknown';
                if (!stateData[state]) stateData[state] = [];
                stateData[state].push(station);
            });
        }

        function showStationPopup(station) {
            const props = station.properties || {};
            document.getElementById('detailStationName').textContent = props.name || 'Unknown Station';
            document.getElementById('detailOperator').textContent = props.operator || 'N/A';
            document.getElementById('detailState').textContent = props.state || 'Unknown';
            document.getElementById('detailChargers').textContent = `${props.chargers || 1} Unit${(props.chargers || 1) !== 1 ? 's' : ''}`;
            
            selectedStation = {
                lat: station.geometry.coordinates[1],
                lng: station.geometry.coordinates[0],
                name: props.name || 'Unknown Station',
                station: station
            };
            
            document.getElementById('stationDetailPanel').classList.add('active');
            
            const coords = station.geometry?.coordinates;
            if (coords) {
                map.setView([coords[1], coords[0]], 16);
            }
        }

        function closeStationDetail() {
            document.getElementById('stationDetailPanel').classList.remove('active');
            selectedStation = null;
        }

        function startDirectionsFromDetail() {
            if (selectedStation) {
                getDirections(selectedStation.lat, selectedStation.lng, selectedStation.name);
                closeStationDetail();
            }
        }

        function renderStations(filterState = null) {
            const isClusteredView = currentView === 'clustered';
            
            // Remove clusters if showing individual
            if (map.hasLayer(markerClusterGroup)) {
                markerClusterGroup.clearLayers();
                map.removeLayer(markerClusterGroup);
            }

            // Clear existing markers
            allMarkersArray.forEach((marker) => {
                if (map.hasLayer(marker)) map.removeLayer(marker);
            });

            allMarkersArray = [];

            const stationsToRender = filterState ? allStations.filter(s => s.properties?.state === filterState) : allStations;

            stationsToRender.forEach((station, idx) => {
                const coords = station.geometry?.coordinates;
                if (!coords) return;

                const props = station.properties || {};
                const lat = coords[1], lng = coords[0];
                const markerGradient = filterState ? 'linear-gradient(135deg, #10b981 0%, #34d399 100%)' : 'linear-gradient(135deg, #3559E8 0%, #5B7EF7 100%)';

                const icon = L.divIcon({
                    html: `<div style="width: 28px; height: 28px; background: ${markerGradient}; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 4px 12px rgba(53, 89, 232, 0.3);"><svg viewBox="0 0 24 24" fill="white" style="width: 14px; height: 14px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>`,
                    className: 'custom-marker-container', iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
                });

                const marker = L.marker([lat, lng], { icon });
                marker.stationId = station.id;
                marker.station = station;
                marker.on('click', function() {
                    showStationPopup(station);
                });

                if (isClusteredView) {
                    markerClusterGroup.addLayer(marker);
                } else {
                    map.addLayer(marker);
                }

                allMarkersArray.push(marker);
            });

            if (isClusteredView) {
                map.addLayer(markerClusterGroup);
            }

            if (filterState && stationsToRender.length > 0) {
                const bounds = L.latLngBounds(stationsToRender.map(s => [s.geometry.coordinates[1], s.geometry.coordinates[0]]));
                map.fitBounds(bounds, { padding: [50, 50], animate: true, duration: 0.8 });
            }
        }

        function updateStats() {
            document.getElementById('totalStations').textContent = allStations.length;
            document.getElementById('totalStates').textContent = Object.keys(stateData).length;
        }

        function populateStateList() {
            const stateSummary = document.getElementById('stateSummary');
            stateSummary.innerHTML = '';

            Object.entries(stateData)
                .sort((a, b) => b[1].length - a[1].length)
                .forEach(([state, stations]) => {
                    const summaryCard = document.createElement('div');
                    summaryCard.className = 'state-summary-card';
                    summaryCard.innerHTML = `<span class="state-summary-name">‚ö° ${state}</span><span class="state-summary-count">${stations.length}</span>`;
                    summaryCard.addEventListener('click', () => filterByState(state));
                    stateSummary.appendChild(summaryCard);
                });
        }

        function filterByState(state) {
            document.querySelectorAll('.state-summary-card').forEach(card => {
                const isActive = card.querySelector('.state-summary-name').textContent === state;
                card.classList.toggle('active', isActive);
            });
            document.getElementById('clearFilterBtn').style.display = 'block';
            renderStations(state);
        }

        function clearFilter() {
            document.querySelectorAll('.state-summary-card').forEach(card => card.classList.remove('active'));
            document.getElementById('clearFilterBtn').style.display = 'none';
            renderStations();
            map.setView([4.2105, 101.9758], 7);
        }

        function updateNearestStations() {
            const nearestList = document.getElementById('nearestList');
            nearestList.innerHTML = '';

            if (!userLocation) {
                nearestList.innerHTML = '<div style="padding: 10px; color: #999; font-size: 0.85rem; text-align: center;">Enable location to see nearest stations</div>';
                return;
            }

            const withDistance = allStations.map(s => ({
                ...s,
                distance: getDistance(userLocation.lat, userLocation.lng, s.geometry.coordinates[1], s.geometry.coordinates[0])
            })).sort((a, b) => a.distance - b.distance).slice(0, 3);

            withDistance.forEach(station => {
                const item = document.createElement('div');
                item.className = 'nearest-item';
                const props = station.properties;
                item.innerHTML = `<div class="nearest-name">${props.name}</div><div class="nearest-distance"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg>${station.distance.toFixed(1)} km</div>`;
                item.addEventListener('click', () => {
                    getDirections(station.geometry.coordinates[1], station.geometry.coordinates[0], props.name);
                });
                nearestList.appendChild(item);
            });
        }

        function showToast(message) {
            // Toast messages removed
        }

        function showErrorToast(message) {
            // Error toast messages removed
        }

        function startRealTimeNavigation() {
            if (!routeCoordinates || routeCoordinates.length === 0) {
                showErrorToast('No route found');
                return;
            }

            navigationActive = true;
            navigationPaused = false;
            navigationDestination = selectedStation;
            navigationStartTime = Date.now();
            navigationPauseTime = 0;

            document.getElementById('routingPanel').classList.remove('active');
            document.getElementById('sidePanel').style.display = 'none';
            document.getElementById('mapLegend').style.display = 'none';
            document.getElementById('turnInstructionBar').classList.add('active');
            document.getElementById('navHUD').classList.add('active');

            if (userMarker && map.hasLayer(userMarker)) {
                map.removeLayer(userMarker);
            }

            if (vehicleMarker && map.hasLayer(vehicleMarker)) {
                map.removeLayer(vehicleMarker);
            }

            const vehicleIcon = L.divIcon({
                html: '<div style="width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid #F6CE53; filter: drop-shadow(0 0 8px rgba(246, 206, 83, 0.6)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));"></div>',
                iconSize: [40, 40],
                iconAnchor: [20, 35],
                className: 'nav-vehicle-marker'
            });

            vehicleMarker = L.marker([userLocation.lat, userLocation.lng], { icon: vehicleIcon }).addTo(map);
            
            // Smooth zoom animation from current zoom to closer view (like Google Maps)
            map.setView([userLocation.lat, userLocation.lng], 17, {
                animate: true,
                duration: 1.2,
                easeLinearity: 0.5
            });

            showToast(`üß≠ Navigation started ‚ö° ${parseFloat(totalRoutDistance).toFixed(1)} km ‚Ä¢ ~${(parseFloat(totalRoutDistance) / 50 * 60).toFixed(0)} min`);

            beginLiveTracking();
        }

        function beginLiveTracking() {
            if (geolocationWatchId !== null) {
                navigator.geolocation.clearWatch(geolocationWatchId);
            }

            let gpsTimeoutCounter = 0;
            const maxTimeoutsBeforeError = 3;
            let lastValidPosition = null;

            geolocationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    if (!navigationActive) return;

                    gpsTimeoutCounter = 0;

                    const newLat = position.coords.latitude;
                    const newLng = position.coords.longitude;

                    lastValidPosition = { lat: newLat, lng: newLng };

                    userLocation = {
                        lat: newLat,
                        lng: newLng,
                        heading: position.coords.heading || 0,
                        speed: (position.coords.speed || 0) * 3.6
                    };

                    if (!vehicleMarker) {
                        const vehicleIcon = L.divIcon({
                            html: '<div style="width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid #F6CE53; filter: drop-shadow(0 0 8px rgba(246, 206, 83, 0.6)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));"></div>',
                            iconSize: [40, 40],
                            iconAnchor: [20, 35],
                            className: 'nav-vehicle-marker'
                        });
                        
                        vehicleMarker = L.marker([newLat, newLng], { icon: vehicleIcon }).addTo(map);
                    } else {
                        vehicleMarker.setLatLng([newLat, newLng]);
                    }

                    if (vehicleMarker._icon) {
                        vehicleMarker._icon.style.transform = `rotate(${userLocation.heading}deg)`;
                        vehicleMarker._icon.style.filter = 'drop-shadow(0 0 8px rgba(246, 206, 83, 0.6)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2))';
                    }

                    const mapCenter = map.getCenter();
                    const distanceFromCenter = getDistance(mapCenter.lat, mapCenter.lng, newLat, newLng);
                    
                    if (distanceFromCenter > 0.05) {
                        map.panTo([newLat, newLng], { animate: true, duration: 0.3 });
                    }

                    updateVehicleDisplay();
                },
                (error) => {
                    gpsTimeoutCounter++;
                    
                    if (error.code === 1) {
                        showErrorToast('Location permission denied');
                        endNavigation();
                    } else if (error.code === 2) {
                        if (gpsTimeoutCounter >= maxTimeoutsBeforeError) {
                            showErrorToast('GPS signal lost - position unavailable');
                        }
                    } else if (error.code === 3) {
                        if (gpsTimeoutCounter >= maxTimeoutsBeforeError) {
                            showErrorToast('GPS timeout - check location services');
                        }
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 0
                }
            );

            showToast('üß≠ Navigation started - tracking real GPS...');
        }

        function updateVehicleDisplay() {
            if (!vehicleMarker || !navigationActive || !navigationDestination) return;

            const destDistance = getDistance(
                userLocation.lat,
                userLocation.lng,
                navigationDestination.lat,
                navigationDestination.lng
            );

            let targetZoom = 18;
            if (destDistance > 3) {
                targetZoom = 14;
            } else if (destDistance > 1) {
                targetZoom = 16;
            }

            map.setView([userLocation.lat, userLocation.lng], targetZoom, {
                animate: true,
                duration: 0.5
            });

            if (destDistance < 0.05) {
                navigationComplete();
                return;
            }

            const avgSpeed = userLocation.speed || 50;
            const remainingSeconds = (destDistance * 1000) / (avgSpeed / 3.6);
            
            const hours = Math.floor(remainingSeconds / 3600);
            const mins = Math.floor((remainingSeconds % 3600) / 60);
            let timeStr = '';
            if (hours > 0) timeStr = `${hours}h ${mins}m`;
            else timeStr = `${Math.max(1, Math.ceil(remainingSeconds / 60))}m`;

            const eta = new Date(Date.now() + remainingSeconds * 1000);
            const etaHour = String(eta.getHours()).padStart(2, '0');
            const etaMin = String(eta.getMinutes()).padStart(2, '0');
            const etaStr = `${etaHour}:${etaMin}`;

            const speed = Math.round(userLocation.speed) || 0;

            document.getElementById('hudDistance').textContent = destDistance < 1 ? `${Math.round(destDistance * 1000)}m` : `${destDistance.toFixed(1)} km`;
            document.getElementById('hudTime').textContent = `ETA ${etaStr}`;
            document.getElementById('hudSpeed').textContent = `${speed} km/h`;

            document.getElementById('turnDistanceText').textContent = destDistance < 1 ? `${Math.round(destDistance * 1000)}m` : `${destDistance.toFixed(1)} km`;
            document.getElementById('turnInstructionText').textContent = `üõ£Ô∏è ${navigationDestination.name} ‚Ä¢ ETA ${etaStr}`;
            document.getElementById('turnArrow').textContent = '‚Üí';
        }

        function navigationComplete() {
            navigationActive = false;
            document.getElementById('turnDistanceText').textContent = '0m';
            document.getElementById('turnInstructionText').textContent = '‚úì Arrived!';
            document.getElementById('turnArrow').textContent = '‚úì';
            
            showToast('üéâ You\'ve arrived at the charging station!');
            
            setTimeout(() => {
                endNavigation();
            }, 3000);
        }

        function toggleNavigationPause() {
            if (navigationPaused) {
                navigationPaused = false;
                navigationStartTime += Date.now() - navigationPauseTime;
                showToast('üß≠ Navigation resumed');
            } else {
                navigationPaused = true;
                navigationPauseTime = Date.now();
                showToast('‚è∏ Navigation paused');
            }
        }

        function endNavigation() {
            navigationActive = false;
            navigationPaused = false;

            if (geolocationWatchId !== null) {
                navigator.geolocation.clearWatch(geolocationWatchId);
                geolocationWatchId = null;
            }

            if (vehicleMarker && map.hasLayer(vehicleMarker)) {
                map.removeLayer(vehicleMarker);
            }

            document.getElementById('turnInstructionBar').classList.remove('active');
            document.getElementById('navHUD').classList.remove('active');
            document.getElementById('routingPanel').classList.remove('active');
            document.getElementById('sidePanel').style.display = '';
            document.getElementById('mapLegend').style.display = '';

            map.setView([userLocation.lat, userLocation.lng], 14);
            showToast('‚úì Navigation ended');
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const nightModeBtn = document.getElementById('nightModeBtn');
            
            const savedNightMode = localStorage.getItem('nightMode') === 'true';
            if (savedNightMode) {
                document.body.classList.add('night-mode');
                document.getElementById('nightModeLabel').textContent = 'Light';
            }
            
            nightModeBtn.addEventListener('click', () => {
                document.body.classList.toggle('night-mode');
                const isNightMode = document.body.classList.contains('night-mode');
                localStorage.setItem('nightMode', isNightMode);
                document.getElementById('nightModeLabel').textContent = isNightMode ? 'Light' : 'Night';
            });
            
            document.getElementById('locationBtn').addEventListener('click', getUserLocation);
            document.getElementById('clearFilterBtn').addEventListener('click', clearFilter);
            document.getElementById('routingClose').addEventListener('click', () => document.getElementById('routingPanel').classList.remove('active'));
            document.getElementById('routingClose2').addEventListener('click', () => document.getElementById('routingPanel').classList.remove('active'));

            document.getElementById('startNavBtn').addEventListener('click', startRealTimeNavigation);

            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidePanel = document.getElementById('sidePanel');
            const mobilePanelOverlay = document.getElementById('mobilePanelOverlay');

            if (isMobile) {
                mobileMenuBtn.style.display = 'flex';
            }

            mobileMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                sidePanel.classList.toggle('mobile-open');
                mobilePanelOverlay.classList.toggle('active');
            });

            mobilePanelOverlay.addEventListener('click', () => {
                sidePanel.classList.remove('mobile-open');
                mobilePanelOverlay.classList.remove('active');
            });

            document.getElementById('viewClustered').addEventListener('click', () => {
                currentView = 'clustered';
                document.getElementById('viewClustered').classList.add('active');
                document.getElementById('viewIndividual').classList.remove('active');
                renderStations();
            });

            document.getElementById('viewIndividual').addEventListener('click', () => {
                currentView = 'individual';
                document.getElementById('viewIndividual').classList.add('active');
                document.getElementById('viewClustered').classList.remove('active');
                renderStations();
            });

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                const searchResults = document.getElementById('searchResults');
                
                if (query.length < 2) {
                    searchResults.classList.remove('active');
                    return;
                }
                
                const matches = allStations.filter(station => {
                    const name = (station.properties?.name || '').toLowerCase();
                    const operator = (station.properties?.operator || '').toLowerCase();
                    return name.includes(query) || operator.includes(query);
                }).slice(0, 10);
                
                searchResults.innerHTML = matches.length === 0 ? '<div style="padding: 12px; text-align: center; color: #999;">No stations found</div>' : matches.map(station => {
                    const props = station.properties || {};
                    return `<div class="search-result-item" data-lat="${station.geometry.coordinates[1]}" data-lng="${station.geometry.coordinates[0]}"><div class="search-result-name">${props.name || 'Unknown'}</div><div class="search-result-operator">${props.operator || 'N/A'}</div></div>`;
                }).join('');
                
                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lng = parseFloat(item.dataset.lng);
                        map.setView([lat, lng], 16);
                        searchResults.classList.remove('active');
                        searchInput.value = '';
                    });
                });
                
                searchResults.classList.add('active');
            });

            document.addEventListener('click', (e) => {
                const searchResults = document.getElementById('searchResults');
                if (!e.target.closest('.search-container')) searchResults.classList.remove('active');
            });
        }

        function getUserLocation() {
            if (!navigator.geolocation) {
                showToast('Geolocation not supported');
                return;
            }
            
            const btn = document.getElementById('locationBtn');
            btn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (userMarker) map.removeLayer(userMarker);
                    
                    const userIcon = L.divIcon({
                        html: '<div class="user-location-marker" style="width: 32px; height: 32px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);"><svg viewBox="0 0 24 24" fill="white" style="width: 16px; height: 16px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg></div>',
                        iconSize: [36, 36], iconAnchor: [18, 18],
                        className: 'user-marker-wrapper'
                    });
                    
                    userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map);
                    map.setView([userLocation.lat, userLocation.lng], 14);
                    updateNearestStations();
                    btn.disabled = false;
                    showToast('üìç Location enabled');
                },
                () => {
                    showToast('Unable to get location');
                    btn.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        window.getDirections = getDirections;
        window.closeStationDetail = closeStationDetail;
        window.startDirectionsFromDetail = startDirectionsFromDetail;
        window.toggleNavigationPause = toggleNavigationPause;
        window.endNavigation = endNavigation;

        window.addEventListener('resize', () => {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 480;
            
            if (wasMobile !== isMobile) {
                if (isMobile) {
                    document.getElementById('sidePanel').classList.remove('mobile-open');
                }
            }
        });

        initSDK();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cbc4b5bf00bd964',t:'MTc3MDczMzcyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
