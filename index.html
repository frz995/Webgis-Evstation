<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>EV Station Finder - Navigation &amp; Route Planning</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css">
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        html, body, #root {
            height: 100%;
            width: 100%;
        }

        #map {
            height: 100%;
            width: 100%;
            background: #e5e3df;
            margin-top: 0;
            margin-left: 0;
            transition: margin-left 0.3s ease;
            position: relative;
            z-index: 1;
        }

        #navGlMap {
            position: fixed;
            inset: 0;
            z-index: 2;
            display: none;
        }

        .nav-mode #navGlMap {
            display: block;
        }

        .nav-gl-marker {
            width: 32px;
            height: 32px;
            background: #ef4444; /* Tesla-style Red */
            /* Arrow with notch shape: Matches the SVG icon structure */
            clip-path: polygon(50% 0%, 0% 100%, 50% 80%, 100% 100%);
            /* Very strong white outline simulated with stacked drop-shadows */
            filter: 
                drop-shadow(0 0 2px white) 
                drop-shadow(0 0 2px white) 
                drop-shadow(0 0 2px white)
                drop-shadow(0 4px 8px rgba(0,0,0,0.5));
            z-index: 10;
        }

        .nav-gl-dest-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #22c55e;
            border: 2px solid #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .header {
            position: fixed;
            top: 14px;
            left: 50%;
            transform: translateX(-50%);
            height: 54px;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 999px;
            border: 1px solid rgba(209, 213, 219, 0.9);
            display: flex;
            align-items: center;
            padding: 0 18px;
            z-index: 1000;
            gap: 12px;
            box-shadow:
                0 18px 45px rgba(15, 23, 42, 0.25),
                0 0 0 1px rgba(148, 163, 184, 0.25);
        }

        .dark-mode {
            background: #050816;
            color: #e5e7eb;
        }

        .dark-mode .header {
            background: rgba(15, 23, 42, 0.96);
            border-color: rgba(31, 41, 55, 0.9);
            box-shadow:
                0 18px 45px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        .dark-mode #mapTitle {
            color: #f9fafb;
        }

        .dark-mode .side-panel,
        .dark-mode .filter-panel,
        .dark-mode .station-detail-panel,
        .dark-mode .routing-panel,
        .dark-mode .map-legend,
        .dark-mode .turn-instruction-bar,
        .dark-mode .nav-hud {
            background: #0b1120;
            color: #e5e7eb;
            border-color: #1f2937;
        }

        .dark-mode .stat-card {
            background: #020617;
            border-color: #1f2937;
        }

        .dark-mode .state-summary-card,
        .dark-mode .nearest-item {
            background: #020617;
            border-color: #1f2937;
        }

        .dark-mode .state-summary-name,
        .dark-mode .state-summary-count,
        .dark-mode .nearest-name,
        .dark-mode .nearest-distance,
        .dark-mode .detail-value {
            color: #e5e7eb;
        }

        .dark-mode .detail-label {
            color: #9ca3af;
        }

        .dark-mode .btn {
            background: #111827;
            color: #e5e7eb;
            border-color: #374151;
        }

        .nav-mode #map {
            margin-top: 0;
            height: 100%;
        }

        .nav-mode .search-container,
        .nav-mode .side-panel,
        .nav-mode .map-legend,
        .nav-mode .control-bar {
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .intro-mode .header,
        .intro-mode .side-panel,
        .intro-mode .map-legend,
        .intro-mode .panel-toggle,
        .intro-mode .filter-panel,
        .intro-mode .routing-panel,
        .intro-mode #turnInstructionBar,
        .intro-mode #navHUD {
            opacity: 0;
            pointer-events: none;
        }

        .intro-mode #map {
            filter: blur(1px) brightness(1.02);
            transition: filter 0.4s ease;
        }

        .intro-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 40px;
            color: #0f172a;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.04), transparent 55%),
                radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.04), transparent 55%),
                linear-gradient(135deg, #f9fafb 0%, #f5f5f5 40%, #f3f4f6 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.6s ease, transform 0.6s ease;
            overflow: hidden;
        }

        .intro-overlay.intro-hidden {
            opacity: 0;
            transform: translateY(22px);
            pointer-events: none;
        }

        .intro-layout {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 1120px;
            padding: 24px 32px 24px 0;
            display: grid;
            grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr);
            grid-template-rows: auto auto;
            grid-template-areas:
                "heading side"
                "panel   side";
            column-gap: 28px;
            row-gap: 20px;
            align-items: flex-start;
        }

        .intro-heading {
            font-size: 40px;
            line-height: 1.06;
            font-weight: 800;
            letter-spacing: -0.06em;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #2563eb 0%, #38bdf8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            grid-area: heading;
        }

        .intro-panel {
            padding: 30px 30px 26px 30px;
            background: transparent;
            border: none;
            box-shadow: none;
            min-height: 260px;
            grid-area: panel;
        }

        .intro-map-grid {
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background:
                linear-gradient(rgba(249, 250, 251, 0.25), rgba(249, 250, 251, 0.25)),
                url('data/evpic-Photoroom.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 1;
        }

        .intro-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            margin-bottom: 14px;
        }

        .intro-title {
            font-size: 26px;
            line-height: 1.2;
            font-weight: 800;
            letter-spacing: -0.04em;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .intro-subtitle {
            font-size: 13px;
            line-height: 1.6;
            color: #4b5563;
            max-width: 460px;
            margin-bottom: 18px;
        }

        .intro-summary {
            display: flex;
            gap: 14px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .intro-summary-item {
            flex: 0 0 auto;
            min-width: 150px;
            padding: 10px 12px;
            border-radius: 0;
            background: transparent;
            border: none;
        }

        .intro-summary-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #4b5563;
            margin-bottom: 2px;
        }

        .intro-summary-value {
            font-size: 20px;
            font-weight: 800;
            color: #1d4ed8;
        }

        .intro-heading,
        .intro-panel,
        .intro-side {
            opacity: 0;
            transform: translateY(12px);
            animation: introFadeUp 0.7s ease forwards;
        }

        .intro-heading {
            animation-delay: 0.05s;
        }

        .intro-panel {
            animation-delay: 0.15s;
        }

        .intro-side {
            animation-delay: 0.25s;
        }

        .intro-side {
            position: fixed;
            right: 60px;
            top: 20%;
            transform: translateY(-50%);
            border-radius: 20px;
            padding: 18px 18px 16px 18px;
            background: rgba(255, 255, 255, 0.98);
            border: none;
            box-shadow:
                0 18px 34px rgba(15, 23, 42, 0.16);
            color: #111827;
            font-size: 12px;
            line-height: 1.6;
            max-width: 320px;
            width: 100%;
            z-index: 2;
        }

        .intro-side-section {
            margin-bottom: 14px;
        }

        .intro-side-section-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #6b7280;
        }

        .intro-side-section-body {
            font-size: 12px;
            color: #111827;
        }

        .intro-feedback-input {
            width: 100%;
            min-height: 70px;
            margin-top: 6px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #111827;
            padding: 8px 10px;
            font-size: 12px;
            resize: vertical;
        }

        .intro-feedback-input::placeholder {
            color: #9ca3af;
        }

        .intro-feedback-submit {
            margin-top: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #4b5563;
            background: #1f2937;
            color: #e5e7eb;
            font-size: 11px;
            cursor: pointer;
        }

        .intro-feedback-submit:active {
            background: #111827;
        }

        .intro-feedback-status {
            font-size: 11px;
            color: #a5b4fc;
        }

        .intro-contact-line {
            margin-top: 4px;
        }

        .intro-meta {
            margin-top: 14px;
            font-size: 11px;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .intro-meta-text {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        .intro-meta-line {
            width: 100%;
            height: 1px;
            background: rgba(148, 163, 184, 0.6);
        }

        @keyframes introFadeUp {
            from {
                opacity: 0;
                transform: translateY(12px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .intro-footer {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .intro-highlight {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 11px;
            color: #6b7280;
        }

        .intro-highlight strong {
            font-size: 13px;
            font-weight: 700;
            color: #111827;
        }

        .intro-features {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            grid-area: features;
        }

        .intro-feature {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(243, 244, 246, 0.9);
        }

        .intro-feature-icon {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563;
            font-size: 11px;
        }

        .intro-feature-label {
            font-size: 11px;
            color: #4b5563;
            white-space: nowrap;
        }

        .intro-button {
            padding: 10px 20px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
            color: white;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.35);
            transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
            white-space: nowrap;
        }

        .intro-button span {
            font-size: 15px;
        }

        .intro-button:active {
            transform: translateY(1px);
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.24);
            filter: brightness(0.98);
        }

        @media (max-width: 880px) {
            .intro-overlay {
                align-items: flex-start;
                justify-content: center;
                padding: 0;
                overflow-y: auto;
            }

            .intro-layout {
                max-width: 100%;
                padding: 18px 14px 20px 14px;
                grid-template-columns: minmax(0, 1fr);
                grid-template-rows: auto auto auto;
                grid-template-areas:
                    "heading"
                    "panel"
                    "side";
                row-gap: 16px;
            }

            .intro-heading {
                font-size: 22px;
                margin-bottom: 8px;
            }

            .intro-panel {
                padding: 18px 14px 16px 14px;
                min-height: auto;
            }

            .intro-title {
                font-size: 22px;
            }

            .intro-footer {
                flex-direction: column-reverse;
                align-items: flex-start;
            }

            .intro-button {
                width: 100%;
                justify-content: center;
            }

            .intro-side {
                position: static;
                right: auto;
                top: auto;
                transform: none;
                padding: 18px 14px 16px 14px;
                align-self: stretch;
                max-width: 100%;
            }
        }

        #mapTitle {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-right: auto;
        }

        .search-container {
            position: relative;
            width: 100%;
            height: 36px;
            margin-top: 8px;
        }

        #searchInput {
            width: 100%;
            height: 100%;
            padding: 0 12px;
            border: 1px solid #d0d0d0;
            border-radius: 20px;
            font-size: 14px;
            background: white;
            outline: none;
            transition: all 0.3s;
        }

        #searchInput:focus {
            border-color: #007FFF;
            box-shadow: 0 0 0 3px rgba(0, 127, 255, 0.1);
        }

        #searchResults {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 200;
        }

        #searchResults.active {
            opacity: 1;
            pointer-events: all;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:active {
            background: #f0f0f0;
        }

        .search-result-name {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .search-result-operator {
            font-size: 12px;
            color: #999;
        }

        .control-bar {
            position: fixed;
            top: 14px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        .control-title {
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid #e5e7eb;
            font-size: 12px;
            font-weight: 700;
            color: #1f2937;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
        }

        .dark-mode .control-title {
            background: rgba(15, 23, 42, 0.98);
            border-color: #1f2937;
            color: #e5e7eb;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.85);
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 4px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.16);
        }

        .dark-mode .control-buttons {
            background: rgba(15, 23, 42, 0.98);
            border-color: #1f2937;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.85);
        }

        .control-divider {
            width: 1px;
            height: 16px;
            background: #e5e7eb;
        }

        .dark-mode .control-divider {
            background: #374151;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            color: #333;
            border: 1px solid #d0d0d0;
            -webkit-user-select: none;
        }

        .control-buttons .btn {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 999px;
            font-size: 0;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            transform: scale(0.98);
            background: #f0f0f0;
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        .control-buttons .btn svg {
            width: 14px;
            height: 14px;
        }
        .dark-mode #searchInput {
            background: #020617;
            border-color: #1f2937;
            color: #e5e7eb;
        }
        .dark-mode #searchInput::placeholder {
            color: #6b7280;
        }
        .dark-mode #searchResults {
            background: #020617;
            border-color: #1f2937;
        }
        .dark-mode .search-result-item {
            border-bottom-color: #1f2937;
        }
        .dark-mode .search-result-item:active {
            background: #111827;
        }
        .dark-mode .search-result-name {
            color: #e5e7eb;
        }

        .side-panel {
            position: fixed;
            left: 16px;
            top: 90px;
            width: 280px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
            overflow-y: hidden;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 130px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 1;
            transform: translateY(0);
        }

        .side-panel, .filters-panel, .map-legend, .control-bar, .search-container, #filtersMiniToggle {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .ui-fade-out {
            opacity: 0 !important;
            pointer-events: none;
        }

        .panel-section {
            padding: 10px 14px;
            border-bottom: 1px solid #f3f4f6;
            flex-shrink: 0;
        }

        .panel-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .dark-mode .section-title {
            color: #9ca3af;
        }

        .side-panel-title {
            font-size: 18px;
            font-weight: 900;
            color: #1a1a1a;
        }

        .dark-mode .side-panel-title {
            color: #e5e7eb;
        }

        .side-panel-subtitle {
            font-size: 12px;
            color: #999;
            font-weight: 500;
        }

        .dark-mode .side-panel-subtitle {
            color: #9ca3af;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 4px;
        }

        .stat-card {
            background: linear-gradient(135deg, #e5efff 0%, #ddeeff 100%);
            padding: 8px 10px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #bfdbfe;
        }
        .dark-mode .stat-card {
            background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
            border-color: #1f2937;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #1d4ed8;
            margin-bottom: 2px;
        }
        .dark-mode .stat-value {
            color: #60a5fa;
        }

        .stat-label {
            font-size: 10px;
            color: #6b7280;
            font-weight: 500;
        }
        .dark-mode .stat-label {
            color: #9ca3af;
        }

        .state-summary-grid-container {
            max-height: 140px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .state-summary-grid-container::-webkit-scrollbar {
            width: 6px;
        }

        .state-summary-grid-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .state-summary-grid-container::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }

        .state-summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .state-summary-card {
            background: #ffffff;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #d0d0d0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .state-summary-card:hover {
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.65), 0 0 16px rgba(59, 130, 246, 0.45);
            border-color: #3b82f6;
        }

        .state-summary-card:active {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(15, 82, 186, 0.15);
            border-color: #0f52ba;
        }

        .state-summary-card.active {
            background: #eff5ff;
            border-color: #2a52be;
            box-shadow: 0 4px 12px rgba(0, 127, 255, 0.3);
        }

        .state-summary-name {
            font-weight: 600;
            font-size: 12px;
            color: #111827;
        }

        .state-summary-card.active .state-summary-name {
            color: #111827;
        }
        .dark-mode .state-summary-card {
            background: #020617;
            border-color: #1f2937;
        }
        .dark-mode .state-summary-name {
            color: #e5e7eb;
        }
        .dark-mode .state-summary-card.active .state-summary-name {
            color: #f9fafb;
        }

        .state-summary-count {
            font-size: 14px;
            font-weight: 900;
            color: #2a52be;
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 8px;
            border-radius: 6px;
            min-width: 35px;
            text-align: center;
        }

        .state-summary-card.active .state-summary-count {
            color: #0f52ba;
            background: white;
        }

        .dark-mode .state-summary-count {
            background: rgba(15, 23, 42, 0.96);
        }

        .ev-marker.highlighted svg {
            filter: drop-shadow(0 0 8px rgba(255, 193, 7, 0.8));
        }

        .map-legend.highlighted {
            border: 2px solid #15B392;
            box-shadow: 0 4px 16px rgba(21, 179, 146, 0.2);
        }

        .map-legend.highlighted .legend-title {
            color: #15B392;
        }

        .nearest-item {
            padding: 10px 12px;
            background: #ffffff;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #d0d0d0;
            transition: all 0.2s;
        }

        .nearest-item:active {
            border-color: #007FFF;
            box-shadow: 0 2px 8px rgba(0, 127, 255, 0.2);
        }

        .nearest-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 12px;
            color: #111827;
        }

        .nearest-distance {
            font-size: 11px;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .dark-mode .nearest-item {
            background: #020617;
            border-color: #1f2937;
        }
        .dark-mode .nearest-name {
            color: #e5e7eb;
        }
        .dark-mode .nearest-distance {
            color: #9ca3af;
        }

        #nearestList {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        #nearestList::-webkit-scrollbar {
            width: 6px;
        }

        #nearestList::-webkit-scrollbar-track {
            background: transparent;
        }

        #nearestList::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }

        .routing-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            transform: translateY(120%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 10001;
            opacity: 0;
            pointer-events: none;
        }

        .routing-panel.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .routing-header {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .routing-destination {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 16px;
        }

        .routing-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }

        .routing-content {
            padding: 16px;
        }

        .routing-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .routing-stat-label {
            color: #666;
            font-weight: 600;
        }

        .routing-stat-value {
            color: #2a52be;
            font-weight: 700;
        }

        .battery-section {
            margin: 16px 0;
        }

        .battery-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        .dark-mode .routing-header {
            border-bottom-color: #1f2937;
        }
        .dark-mode .routing-destination {
            color: #e5e7eb;
        }
        .dark-mode .routing-stat-label {
            color: #9ca3af;
        }
        .dark-mode .routing-stat-value {
            color: #60a5fa;
        }
        .dark-mode .battery-header {
            color: #e5e7eb;
        }

        .battery-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        #batteryFill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            width: 100%;
            transition: width 0.3s, background 0.3s;
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 16px;
        }

        .nav-button {
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .nav-button.primary {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
        }

        .nav-button.primary:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 127, 255, 0.3);
        }

        .nav-button.secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #d0d0d0;
        }
        .dark-mode .nav-button.secondary {
            background: #020617;
            color: #e5e7eb;
            border-color: #1f2937;
        }

        .turn-instruction-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            transform: translateY(-150%);
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            color: #1a1a1a;
            padding: 18px 22px;
            border-radius: 18px;
            z-index: 3000;
            box-shadow: 0 16px 45px rgba(15, 23, 42, 0.22);
            border: 1px solid rgba(148, 163, 184, 0.45);
            display: flex;
            align-items: center;
            gap: 16px;
            width: 280px;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            pointer-events: none;
        }

        .turn-instruction-bar.active {
            transform: translateY(0);
            pointer-events: auto;
        }

        .turn-instruction-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 127, 255, 0.3);
            flex-shrink: 0;
        }

        .turn-instruction-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .turn-instruction-distance {
            font-size: 24px;
            font-weight: 800;
            color: #111827;
            line-height: 1;
            margin-bottom: 2px;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            letter-spacing: -0.5px;
        }

        .turn-instruction-text {
            font-size: 13px;
            color: #4b5563;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .dark-mode .turn-instruction-distance {
            color: #f9fafb;
        }
        .dark-mode .turn-instruction-text {
            color: #9ca3af;
        }

        .nav-hud {
            position: fixed;
            bottom: 26px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            background: white;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            color: #111827;
            padding: 12px 18px 10px 18px;
            border-radius: 16px;
            z-index: 3000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 320px;
            max-width: 420px;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            pointer-events: none;
        }

        .nav-hud.active {
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .hud-metrics {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 18px;
        }

        .hud-metric-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .hud-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6b7280;
            font-weight: 700;
        }

        .hud-value {
            font-size: 17px;
            font-weight: 800;
            color: #111827;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            letter-spacing: -0.4px;
        }
        .dark-mode .hud-label {
            color: #9ca3af;
        }
        .dark-mode .hud-value {
            color: #f9fafb;
        }

        .nav-progress-track {
            position: relative;
            height: 6px;
            border-radius: 999px;
            background: #e5e7eb;
            overflow: hidden;
        }

        .nav-progress-fill {
            position: absolute;
            inset: 0;
            width: 55%;
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .nav-progress-marker {
            position: absolute;
            top: 50%;
            left: 55%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            border-radius: 999px;
            background: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4);
        }

        .nav-hud-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 2px;
        }

        .nav-hud-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-hud-sub {
            font-size: 12px;
            font-weight: 600;
            color: #047857;
        }

        .nav-control-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            color: #111827;
            border: 1px solid #e5e7eb;
            border-radius: 999px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.16s ease;
            white-space: nowrap;
        }

        .nav-control-btn:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .nav-control-btn:active {
            transform: translateY(1px);
        }

        .nav-left-stack {
            position: fixed;
            top: 112px;
            left: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 3000;
        }

        .nav-mode .nav-left-stack {
            display: flex;
        }

        .nav-card {
            background: white;
            border-radius: 16px;
            padding: 12px 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0e0e0;
        }

        .dark-mode .nav-card {
            background: #020617;
            border-color: #1f2937;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.85);
        }

        .nav-media-card {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 280px;
        }

        .nav-media-cover {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: #e5e7eb;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-media-glyph {
            width: 22px;
            height: 22px;
            border-radius: 8px;
            background: #111827;
            color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .nav-media-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-media-title {
            font-size: 13px;
            font-weight: 700;
            color: #1f2937;
        }

        .nav-media-artist {
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
        }

        .nav-media-close {
            margin-left: auto;
            border: none;
            background: transparent;
            font-size: 14px;
            cursor: pointer;
            color: #9ca3af;
        }

        .dark-mode .nav-media-cover {
            background: #020617;
        }

        .dark-mode .nav-media-title {
            color: #e5e7eb;
        }

        .dark-mode .nav-media-artist {
            color: #9ca3af;
        }

        .dark-mode .nav-media-close {
            color: #6b7280;
        }

        .nav-energy-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 280px;
            padding: 14px 18px;
            border-radius: 16px;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .nav-energy-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-energy-icon {
            position: relative;
            width: 32px;
            height: 20px;
            border-radius: 6px;
            background: #ecfdf5;
            border: 2px solid #22c55e;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-energy-icon::before {
            content: '';
            position: absolute;
            left: 4px;
            right: 6px;
            top: 4px;
            bottom: 4px;
            border-radius: 4px;
            background: #22c55e;
        }

        .nav-energy-icon::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            width: 4px;
            height: 10px;
            border-radius: 2px;
            background: #22c55e;
            transform: translateY(-50%);
        }

        .nav-energy-icon span {
            position: relative;
            font-size: 0;
        }

        .nav-right-stack {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 3000;
        }

        .nav-mode .nav-right-stack {
            display: flex;
        }

        .nav-ctrl-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: white;
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .dark-mode .nav-ctrl-btn {
            border-color: #1f2937;
            background: #020617;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.8);
            color: #e5e7eb;
        }

        .nav-energy-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-energy-value {
            font-size: 15px;
            font-weight: 800;
            color: #047857;
        }

        .nav-energy-label {
            font-size: 11px;
            color: #6b7280;
        }

        .nav-energy-more {
            font-size: 18px;
            color: #9ca3af;
        }

        .dark-mode .nav-energy-card {
            background: #020617;
            border-color: #1f2937;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.85);
        }

        .dark-mode .nav-energy-icon {
            background: rgba(21, 128, 61, 0.25);
            border-color: #22c55e;
        }

        .dark-mode .nav-energy-icon::before {
            background: #22c55e;
        }

        .dark-mode .nav-energy-icon::after {
            background: #22c55e;
        }

        .dark-mode .nav-energy-value {
            color: #bbf7d0;
        }

        .dark-mode .nav-energy-label {
            color: #9ca3af;
        }

        .dark-mode .nav-energy-more {
            color: #4b5563;
        }

        .nav-speed-hud {
            position: fixed;
            top: 20px;
            right: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 3000;
        }

        .nav-mode .nav-speed-hud {
            display: flex;
        }

        @media (max-width: 768px) {
            .nav-speed-hud {
                top: 50%;
                left: 10px;
                right: auto;
                transform: translateY(-50%);
                flex-direction: column;
            }
        }

        .nav-speed-pill {
            border-radius: 16px;
            padding: 8px 10px;
            min-width: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.18);
            border: 1px solid #e0e0e0;
        }

        .nav-speed-current {
            background: #dcfce7;
            color: #166534;
        }

        .nav-speed-limit {
            background: white;
            color: #111827;
        }

        .nav-speed-value {
            font-size: 18px;
            font-weight: 800;
            line-height: 1;
        }

        .nav-speed-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-top: 2px;
        }

        .dark-mode .nav-speed-pill {
            border-color: #1f2937;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.75);
        }

        .dark-mode .nav-speed-current {
            background: rgba(22, 163, 74, 0.16);
            color: #bbf7d0;
        }

        .dark-mode .nav-speed-limit {
            background: rgba(15, 23, 42, 0.96);
            color: #e5e7eb;
        }

        .dark-mode .nav-speed-label {
            color: #9ca3af;
        }

        .map-legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            min-width: 240px;
            border: 1px solid #e0e0e0;
            max-height: 70vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        /* Desktop/webview: place filters toggle above legend on right with clear gap */
        @media (min-width: 769px) {
            #filtersMiniToggle {
                position: fixed !important;
                right: 20px;
                bottom: 140px;
                left: auto;
                top: auto;
                width: 36px;
                height: 36px;
                z-index: 1002;
            }
        }
        .panel-toggle {
            border-radius: 10px;
            border: none;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
        }

        .dark-mode .panel-toggle {
            background: #020617;
            color: #e5e7eb;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.85);
        }
        .filter-panel {
            position: fixed;
            right: 20px;
            bottom: 140px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1002;
            width: 300px;
            border: 1px solid #e0e0e0;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
        }

        .filter-panel.mobile-open {
            display: block;
        }

        .legend-title {
            font-weight: 700;
            font-size: 13px;
            color: #1a1a1a;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dark-mode .legend-title {
            color: #e5e7eb;
        }

        .dark-mode .legend-item {
            color: #9ca3af;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #666;
            transition: opacity 0.3s ease;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color-box {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .station-detail-panel {
            position: fixed;
            top: 90px;
            right: 16px;
            width: 320px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
            z-index: 9998;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            transform: translateX(400px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        .station-detail-panel.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: all;
        }

        .station-detail-header {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .station-detail-header-content {
            flex: 1;
            min-width: 0;
        }

        .station-detail-title {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 2px;
            line-height: 1.25;
            word-break: break-word;
        }

        .station-detail-subtitle {
            font-size: 11px;
            opacity: 0.9;
            font-weight: 500;
            letter-spacing: 0.24px;
            text-transform: uppercase;
        }

        .station-detail-close {
            background: rgba(255, 255, 255, 0.18);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .station-detail-close:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .station-detail-body {
            padding: 14px 14px;
        }

        .detail-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .detail-item:last-of-type {
            margin-bottom: 0;
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e0eeff 0%, #cce0ff 100%);
            border: 1.5px solid #99ccff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2a52be;
            flex-shrink: 0;
        }

        .detail-content {
            flex: 1;
            min-width: 0;
        }

        .detail-label {
            font-size: 10px;
            color: #9ca3af;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.32px;
            margin-bottom: 2px;
        }

        .detail-value {
            font-weight: 600;
            color: #111827;
            font-size: 13px;
            line-height: 1.3;
        }

        .station-detail-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 12px 0;
        }

        .station-detail-action {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 3px 10px rgba(16, 185, 129, 0.22);
        }

        .station-detail-action:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
        }

        .station-detail-secondary {
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            color: #6b7280;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .station-detail-secondary svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        .station-detail-secondary:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(15, 23, 42, 0.16);
        }

        .view-toggle {
            display: flex;
            gap: 6px;
            background: white;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid #d0d0d0;
        }

        .view-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            border-radius: 8px;
            transition: all 0.2s;
        }
        #clearStateSelection:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .view-btn.active {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
        }

        .view-toggle-container {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            background: white;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid #d0d0d0;
        }

        .dark-mode .view-toggle-container {
            background: #020617;
            border-color: #1f2937;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        @keyframes vehiclePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }



        @media (max-width: 768px) {
            .header {
                top: 10px;
                height: 52px;
                padding: 0 12px;
                gap: 8px;
            }

            #mapTitle {
                font-size: 16px;
            }

            .control-bar {
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
                gap: 6px;
            }

            .control-title {
                max-width: 85vw;
                font-size: 11px;
                padding: 4px 10px;
                text-align: center;
                white-space: nowrap;
            }

            .control-buttons {
                padding: 2px 4px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            #savedAddressPanel {
                /* On mobile, open the saved addresses panel at the top, centered */
                top: 60px;
                bottom: auto;
                left: 4%;
                right: 4%;
                width: auto;
                max-height: 50vh;
            }

            #map {
                margin-top: 0;
                height: 100%;
            }

            .side-panel {
                left: 3%;
                right: 3%;
                top: auto;
                bottom: 12px;
                width: auto;
                max-height: 50vh;
                padding: 8px 10px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                transition: max-height 0.25s ease;
            }

            .side-panel.expanded {
                max-height: 80vh;
            }

            .side-panel.minimized {
                max-height: 80px;
            }

            .routing-panel {
                width: 92%;
                max-width: 340px;
                top: 50%;
                left: 50%;
                bottom: auto;
                right: auto;
                max-height: 70vh;
                transform: translate(-50%, 120%);
                overflow-y: auto;
            }

            .routing-panel.active {
                transform: translate(-50%, -50%);
            }

            .station-detail-panel {
                width: 94%;
                max-width: 360px;
                top: 50%;
                left: 50%;
                right: auto;
                bottom: auto;
                max-height: 70vh;
                transform: translate(-50%, 120%);
                overflow-y: auto;
            }

            .station-detail-panel.active {
                transform: translate(-50%, -50%);
            }

            .map-legend {
                display: none;
            }

            .legend-title {
                font-size: 10px;
                margin-bottom: 6px;
            }

            .legend-item {
                gap: 4px;
                margin-bottom: 4px;
                font-size: 10px;
            }

            .legend-color-box {
                width: 12px;
                height: 12px;
            }

            .filter-panel {
                width: 82%;
                max-width: 300px;
                bottom: 190px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                padding: 8px 10px;
                display: none;
            }

            .filter-panel.mobile-open {
                display: block;
            }

            .turn-instruction-bar {
                top: 10px;
                left: 50%;
                transform: translate(-50%, -150%);
                padding: 12px 16px;
                gap: 12px;
                max-width: 95%;
            }

            .turn-instruction-bar.active {
                transform: translate(-50%, 0);
            }

            .turn-instruction-distance {
                font-size: 20px;
            }

            .turn-instruction-text {
                font-size: 12px;
                max-width: 160px;
            }

            .nav-hud {
                bottom: 24px;
                padding: 12px 16px;
                gap: 16px;
                max-width: 360px;
                min-width: 300px;
            }

            .hud-value {
                font-size: 16px;
            }

            .nav-control-btn {
                padding: 8px 14px;
            }

            .nav-ctrl-btn {
                width: 40px;
                height: 40px;
            }

            .panel-toggle {
                display: flex;
                width: 36px;
                height: 32px;
                left: 8px;
                top: 12px;
                bottom: auto;
                transform: none;
            }

            .panel-toggle-filters {
                left: 8px;
                top: 12px;
                right: auto;
                bottom: auto;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast-message {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            animation: slideUp 0.3s ease-out;
        }

        .intro-mode .toast-message {
            display: none;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .filters-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        .filter-toggle-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 8px;
        }
        .filter-toggle {
            padding: 8px 10px;
            border: 1px solid #d0d0d0;
            border-radius: 20px;
            background: white;
            font-size: 12px;
            font-weight: 700;
            color: #333;
            transition: all 0.2s ease;
        }
        .filter-toggle.active {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            color: white;
            border-color: #2a52be;
        }
        .power-range-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            border-radius: 8px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid #2a52be;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid #2a52be;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 12px;
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            border-radius: 8px;
        }
        input[type="range"]::-moz-range-track {
            height: 12px;
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            border-radius: 8px;
        }
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: 700;
            color: #666;
        }
        .chip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
            gap: 8px;
        }
        .chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            border-radius: 8px;
            border: 1px solid #eee;
            background: #fff;
            font-size: 10px;
            font-weight: 500;
            color: #666;
            text-align: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            aspect-ratio: 1;
            gap: 6px;
            cursor: pointer;
        }
        .chip-icon {
            font-size: 20px;
            line-height: 1;
            filter: grayscale(100%);
            opacity: 0.5;
            margin-bottom: 2px;
            transition: all 0.2s ease;
        }
        .chip-label {
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            max-width: 100%;
            opacity: 0.9;
        }
        .chip:hover {
            border-color: #ccc;
            background: #fcfcfc;
            transform: translateY(-1px);
        }
        .chip.active {
            background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%);
            border-color: #2a52be;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(42, 82, 190, 0.3);
        }
        .chip.active .chip-icon {
            opacity: 1;
            filter: brightness(0) invert(1);
            transform: scale(1.1);
        }
        .equipment-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 8px;
        }
        .equipment-item {
            display: grid;
            grid-template-columns: 20px 1fr auto;
            align-items: center;
            gap: 10px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 8px 10px;
        }
        .equipment-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .equipment-meta {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2px;
        }
        .equipment-title {
            font-size: 13px;
            font-weight: 800;
            color: #1a1a1a;
        }
        .equipment-sub {
            font-size: 12px;
            color: #666;
        }
        /* Update this block in your <style> tag */
        .nav-gl-marker {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
        }

        .nav-arrow-shape {
            display: none;
        }

        .equipment-badge {
            display: inline-flex; /* Changed from inline-block to inline-flex for better centering */
            align-items: center;
            justify-content: center;
            padding: 2px 4px; /* Reduced padding */
            border-radius: 6px;
            background: linear-gradient(135deg, #e0eeff 0%, #cce0ff 100%);
            color: #2a52be;
            font-weight: 800;
            font-size: 10px; /* Slightly smaller for a cleaner look */
            border: 1px solid #99ccff;
            min-width: 10px; /* Ensures AC and DC are similar widths */
            height: 20px;
            white-space: nowrap; /* Prevents text wrapping */
        }

        .user-pulse-marker {
            width: 24px;
            height: 24px;
            background: radial-gradient(circle at 30% 30%, #ffd27a, #FFAE42);
            border: 3px solid #ffffff;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 174, 66, 0.5);
            position: relative;
            z-index: 1000;
        }
        
        .user-pulse-marker::before {
            content: '';
            position: absolute;
            top: -12px;
            left: -12px;
            right: -12px;
            bottom: -12px;
            background: rgba(255, 174, 66, 0.25);
            border-radius: 50%;
            z-index: -1;
            animation: softPulse 2s cubic-bezier(0.25, 0.8, 0.25, 1) infinite;
        }

        .user-pulse-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }

        @keyframes softPulse {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        .user-nav-marker {
            transition: transform 0.3s linear; /* Smooth rotation */
            transform-origin: center center;
        }

        /* 3D Navigation Mode */
        #map.map-tilted {
            /* We handle the transform in JS to include dynamic rotation */
            transition: transform 1s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: center center;
            border-radius: 0; /* Ensure no clipping issues if styled */
        }
        
        /* Disable the pane transform override */
        /* .map-tilted .leaflet-map-pane { ... } removed */

        /* Smooth marker movement for real-time feel */
        .smooth-marker-move {
            transition: transform 1s linear !important;
        }

        .route-line {
            filter: drop-shadow(0 0 10px rgba(0, 127, 255, 0.5));
        }

        .active-layer {
            background: #10b981 !important;
            color: white !important;
        }

        .saved-address-panel {
            position: fixed;
            top: 60px;
            right: 16px;
            width: 260px;
            max-height: 260px;
            background: #ffffff;
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 16px 45px rgba(15, 23, 42, 0.22);
            z-index: 1100;
            display: none;
            overflow: hidden;
        }

        .saved-address-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .saved-address-title {
            font-size: 12px;
            font-weight: 700;
            color: #111827;
        }

        .saved-address-close {
            border: none;
            background: transparent;
            font-size: 12px;
            color: #9ca3af;
            cursor: pointer;
            padding: 2px 4px;
        }

        .saved-address-list {
            max-height: 220px;
            overflow-y: auto;
        }

        .saved-address-item {
            padding: 8px 10px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .saved-address-item:last-child {
            border-bottom: none;
        }

        .saved-address-item:hover {
            background: #f3f4ff;
        }

        .saved-address-name {
            font-size: 12px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
        }

        .saved-address-location {
            font-size: 11px;
            color: #6b7280;
        }
    </style>
  <script src="/_sdk/element_sdk.js"></script>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
  <body class="intro-mode">
  <div id="root" style="height: 100%; width: 100%;">
   <div id="map"></div>
   <div id="navGlMap"></div>
   <div class="control-bar">
    <button id="filtersMiniToggle" class="panel-toggle panel-toggle-filters"></button>
    <div class="control-title">
      EV Station Finder MY
    </div>
    <div class="control-buttons">
     <button id="nightModeBtn" class="btn">
      <svg fill="currentColor" viewbox="0 0 24 24">
       <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
      </svg>
     </button>
     <span class="control-divider"></span>
     <button id="locationBtn" class="btn">
      <svg fill="currentColor" viewbox="0 0 24 24">
       <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
      </svg>
     </button>
     <button id="saveAddressBtn" class="btn" title="Save address">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
       <path d="M6 4h12a1 1 0 0 1 1 1v15l-7-4-7 4V5a1 1 0 0 1 1-1z" />
      </svg>
     </button>
    </div>
    <div id="savedAddressPanel" class="saved-address-panel">
     <div class="saved-address-header">
      <div class="saved-address-title">
       Saved addresses
      </div>
      <button class="saved-address-close" onclick="toggleSavedAddressPanel(false)"></button>
     </div>
     <div id="savedAddressList" class="saved-address-list"></div>
    </div>
   </div>
   <div id="sidePanel" class="side-panel">
    <div class="panel-section">
     <div style="margin-bottom: 4px;">
      <div class="side-panel-title">
        EV Stations
      </div>
     </div>
     <div class="side-panel-subtitle">
      Filter &amp; explore charging stations
     </div>
     <div class="search-container"><input id="searchInput" type="text" placeholder="Search stations...">
      <div id="searchResults"></div>
     </div>
    </div>
    <div class="panel-section">
     <div class="section-title">
       Stats
     </div>
     <div class="stats-grid">
      <div class="stat-card">
       <div class="stat-value" id="totalStations">
        0
       </div>
       <div class="stat-label">
        Total
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-value" id="totalStates">
        0
       </div>
       <div class="stat-label">
        States
       </div>
      </div>
     </div>
    </div>
    <div class="panel-section">
     <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
       <div class="section-title"> States</div>
       <button id="clearStateSelection" class="view-btn" style="display: none; padding: 6px 12px; color: #dc2626; font-weight: 700; background: rgba(220, 38, 38, 0.08);">Clear</button>
     </div>
     <div class="view-toggle-container"><button id="viewClustered" class="view-btn active" style="flex: 1; padding: 6px 12px;">Clustered</button> <button id="viewIndividual" class="view-btn" style="flex: 1; padding: 6px 12px;">Individual</button>
     </div>
     <div class="state-summary-grid-container">
      <div id="stateSummary" class="state-summary-grid"></div>
     </div>
    </div>
    <div class="panel-section" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
     <div class="section-title">
       Nearest
     </div>
     <div id="nearestList"></div>
    </div>
   </div>
   <div id="routingPanel" class="routing-panel">
    <div class="routing-header">
     <div class="routing-destination" id="routingDestination">
      Loading...
     </div><button id="routingClose" class="routing-close"></button>
    </div>
    <div class="routing-content">
     <div class="routing-stat"><span class="routing-stat-label">Distance</span> <span class="routing-stat-value" id="routingDistance">-- km</span>
     </div>
     <div class="routing-stat"><span class="routing-stat-label">Time</span> <span class="routing-stat-value" id="routingTime">--:--</span>
     </div>
     <div class="battery-section">
                    <div class="battery-header"><span>Battery</span> <span id="batteryRemaining">100%</span>
      </div>
      <div class="battery-bar">
       <div id="batteryFill" style="width: 100%;"></div>
      </div>
     </div>
     <div class="nav-buttons"><button id="startNavBtn" class="nav-button primary">Start Nav</button> <button id="routingClose2" class="nav-button secondary">Cancel</button>
     </div>
    </div>
   </div>
  <div id="turnInstructionBar" class="turn-instruction-bar">
   <div class="turn-instruction-icon">
   </div>
   <div class="turn-instruction-content">
    <div class="turn-instruction-distance" id="turnDistanceText">
     -- km
    </div>
    <div class="turn-instruction-text" id="turnInstructionText">
     Navigation active
    </div>
   </div>
  </div>
  <div class="nav-left-stack">
   <div class="nav-card nav-media-card" id="navMediaCard">
    <div class="nav-media-cover">
    </div>
    <div class="nav-media-text">
     <div class="nav-media-title">
      Pigments
     </div>
     <div class="nav-media-artist">
      Norabel
     </div>
    </div>
    <button class="nav-media-close" onclick="document.getElementById('navMediaCard').style.display='none'">
     
    </button>
   </div>
   <div class="nav-energy-card">
    <div class="nav-energy-main">
     <div class="nav-energy-icon">
      
     </div>
     <div class="nav-energy-text">
      <div class="nav-energy-value" id="navArrivalEnergy">
       155 mi
      </div>
      <div class="nav-energy-label">
       on arrival
      </div>
     </div>
    </div>
    <div class="nav-energy-more">
     
    </div>
   </div>
  </div>
  <div id="navHUD" class="nav-hud">
   <div class="hud-metrics">
    <div class="hud-metric-item">
     <div class="hud-label">
      Distance
     </div>
     <div class="hud-value" id="hudDistance">
      --
     </div>
    </div>
    <div class="hud-metric-item">
     <div class="hud-label">
      Duration
     </div>
     <div class="hud-value" id="hudTime">
      --:--
     </div>
    </div>
    <div class="hud-metric-item">
     <div class="hud-label">
      Arrival
     </div>
     <div class="hud-value" id="hudArrival">
      --:--
     </div>
    </div>
   </div>
   <div class="nav-progress-track">
    <div class="nav-progress-fill"></div>
    <div class="nav-progress-marker"></div>
   </div>
   <div class="nav-hud-bottom">
    <div class="nav-hud-sub" id="hudRemainingLabel">
     15 min remaining
    </div>
    <div class="nav-hud-actions">
        <button class="nav-control-btn" onclick="toggleNavOverview()">Overview</button>
        <button class="nav-control-btn" onclick="endNavigation()">End navigation</button>
    </div>
   </div>
  </div>
  <div class="nav-speed-hud">
   <div class="nav-speed-pill nav-speed-current">
    <div class="nav-speed-value" id="hudSpeed">
     --
    </div>
    <div class="nav-speed-label">
     speed
    </div>
   </div>
   <div class="nav-speed-pill nav-speed-limit">
    <div class="nav-speed-value" id="hudSpeedLimit">
     30
    </div>
    <div class="nav-speed-label">
     limit
    </div>
   </div>
  </div>
  <div class="nav-right-stack">
   <button id="navLayerBtn" class="nav-ctrl-btn" onclick="toggleNavLayer()" style="margin-bottom: 8px;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
     <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
    </svg>
   </button>
   <button id="navRecenterBtn" class="nav-ctrl-btn">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
     <polygon points="12 2 2 22 12 18 22 22 12 2" fill="#f8fafc" stroke="#64748b"/>
    </svg>
   </button>
   <button id="navZoomInBtn" class="nav-ctrl-btn">
    +
   </button>
   <button id="navZoomOutBtn" class="nav-ctrl-btn">
    
   </button>
  </div>
   <div id="stationDetailPanel" class="station-detail-panel">
    <div class="station-detail-header">
     <div class="station-detail-header-content">
      <div class="station-detail-title" id="detailStationName">
       Station Name
      </div>
      <div class="station-detail-subtitle">
        EV Charging
      </div>
     </div><button class="station-detail-close" onclick="closeStationDetail()"></button>
    </div>
    <div class="station-detail-body">
     <div class="detail-item">
      <div class="detail-content">
       <div class="detail-label">
        Network
       </div>
       <div class="detail-value" id="detailOperator">
        -
       </div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-content">
       <div class="detail-label">
        Location
       </div>
       <div class="detail-value" id="detailLocation">
        -
       </div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-content">
       <div class="detail-label">
        State
       </div>
       <div class="detail-value" id="detailState">
        -
       </div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-content">
       <div class="detail-label">
        Equipment
       </div>
       <div class="equipment-list" id="detailEquipmentList"></div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-content">
       <div class="detail-label">
        Chargers
       </div>
       <div class="detail-value" id="detailChargers">
        -
       </div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-content">
       <div class="detail-label">
        Usage
       </div>
       <div class="detail-value" id="detailUsage">
        -
       </div>
      </div>
     </div>
     <div class="detail-item" id="detailPriceRow" style="display:none;">
      <div class="detail-content">
       <div class="detail-label">
        Price
       </div>
       <div class="detail-value" id="detailPrice">
        -
       </div>
      </div>
     </div>
     <div class="detail-item">
      <div class="detail-content">
       <div class="detail-label">
        Access
       </div>
       <div class="detail-value" id="detailAccess">
        -
       </div>
      </div>
     </div>
     <div class="station-detail-divider"></div>
     <div style="display:flex; gap:8px; align-items:center;">
      <button class="station-detail-action" onclick="startDirectionsFromDetail()"> Get Directions</button>
      <button class="station-detail-secondary" onclick="shareStationLocation()">
       <svg viewBox="0 0 24 24" fill="none">
        <circle cx="6" cy="12" r="2" />
        <circle cx="18" cy="6" r="2" />
        <circle cx="18" cy="18" r="2" />
        <line x1="8" y1="11" x2="16" y2="7" />
        <line x1="8" y1="13" x2="16" y2="17" />
       </svg>
      </button>
      <button class="station-detail-secondary" onclick="toggleFavoriteStation()">
       <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 20s-4.5-2.7-7-6.2C3.2 12.4 3 11.8 3 11.1 3 9.4 4.4 8 6.1 8c1.1 0 2.2.6 2.9 1.5L12 11.8l3-2.3C15.7 8.6 16.8 8 17.9 8 19.6 8 21 9.4 21 11.1c0 .7-.2 1.3-1 2-2.5 3.5-7 6.9-7 6.9z" />
       </svg>
      </button>
     </div>
    </div>
   </div>
   <div id="equipmentIconsTemplate" style="display:none;">
    <svg data-icon="type2" viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="#ddd"/><circle cx="12" cy="12" r="2"/><circle cx="20" cy="12" r="2"/><circle cx="12" cy="20" r="2"/><circle cx="20" cy="20" r="2"/></svg>
    <svg data-icon="ccs" viewBox="0 0 32 32"><rect x="8" y="8" width="16" height="16" rx="8" fill="#ddd"/><circle cx="13" cy="13" r="2"/><circle cx="19" cy="13" r="2"/><rect x="12" y="19" width="8" height="4" rx="2"/></svg>
    <svg data-icon="chademo" viewBox="0 0 32 32"><rect x="8" y="8" width="16" height="16" rx="4" fill="#ddd"/><circle cx="16" cy="13" r="3"/><rect x="14" y="18" width="4" height="4"/></svg>
    <svg data-icon="type1" viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="#ddd"/><circle cx="16" cy="16" r="3"/><circle cx="12" cy="20" r="2"/><circle cx="20" cy="20" r="2"/></svg>
    <svg data-icon="gbt" viewBox="0 0 32 32"><rect x="8" y="8" width="16" height="16" rx="2" fill="#ddd"/><circle cx="12" cy="12" r="2"/><circle cx="20" cy="12" r="2"/><circle cx="12" cy="20" r="2"/><circle cx="20" cy="20" r="2"/></svg>
    <svg data-icon="tesla" viewBox="0 0 32 32"><path d="M6 10h20l-10 12z" fill="#ddd"/></svg>
    <svg data-icon="scame" viewBox="0 0 32 32"><rect x="8" y="10" width="16" height="12" rx="2" fill="#ddd"/><circle cx="12" cy="16" r="2"/><circle cx="20" cy="16" r="2"/></svg>
    <svg data-icon="unknown" viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="#ddd"/><text x="16" y="20" text-anchor="middle" font-size="12">?</text></svg>
   </div>
   <div id="mapLegend" class="map-legend">
    <div class="legend-title">
      Legend
    </div>
    <div class="legend-item" id="defaultLegendItem">
     <div class="legend-color-box" style="background: linear-gradient(135deg, #3559E8 0%, #5B7EF7 100%);"></div><span>All EV Stations</span>
    </div>
    <div class="legend-item" id="filteredLegendItem" style="display: none; cursor: pointer;" title="Click to clear filter" onclick="document.getElementById('clearStateSelection').click()">
     <div class="legend-color-box" style="background: linear-gradient(135deg, #15B392 0%, #34D399 100%);"></div><span id="filteredLegendText">Filtered State</span> <span style="margin-left: auto; font-size: 10px; color: #999;"></span>
    </div>
   </div>
   <div id="filtersPanel" class="filter-panel">
    <div class="section-title"> Filters</div>
    <div class="filters-grid">
     <div class="filter-toggle-row">
      <button id="toggleAvailable" class="filter-toggle"><span style="filter: grayscale(100%); margin-right: 4px;"></span>Available</button>
      <button id="toggleCable" class="filter-toggle"><span style="filter: grayscale(100%); margin-right: 4px;"></span>With cable</button>
     </div>
     <div>
      <div class="range-labels"><span>PLUG TYPE</span></div>
      <div class="chip-grid" id="dynamicPlugFilters"></div>
      </div>
     </div>
    </div>
   </div>
   <div id="introOverlay" class="intro-overlay">
    <div class="intro-map-grid"></div>
     <div class="intro-layout">
     <div class="intro-heading">WebGIS - An Interactive Webmap EV<br>Station Finder MY</div>
     <div class="intro-panel">
      <div class="intro-tag">
       <span>EV CHARGING  MALAYSIA</span>
      </div>
      <div class="intro-title">
       Discover charging stations across Malaysia in one interactive map
      </div>
      <div class="intro-subtitle">
       Explore live coverage by state, filter by connector type, and start turn-by-turn navigation to nearby chargers.
      </div>
      <div class="intro-summary">
       <div class="intro-summary-item">
        <div class="intro-summary-label">Active stations</div>
        <div class="intro-summary-value" id="introTotalStations">0</div>
       </div>
       <div class="intro-summary-item">
        <div class="intro-summary-label">States covered</div>
        <div class="intro-summary-value" id="introTotalStates">0</div>
       </div>
      </div>
      <div class="intro-footer">
       <div class="intro-highlight">
        <strong>Optimised for day & night driving</strong>
        <span>Light and dark map themes with a focused driving HUD.</span>
       </div>
       <button id="introStartBtn" class="intro-button">
        <span>Start Explore</span>
        <span></span>
       </button>
      </div>
     </div>
     <div class="intro-side">
      <div class="intro-side-section">
       <div class="intro-side-section-title">About this webmap</div>
       <div class="intro-side-section-body">
        EV Station Finder MY is a personal, non-commercial project built to visualise Malaysias EV charging network in a single interactive experience. It focuses on helping drivers and enthusiasts explore coverage by state, understand charger density, and experiment with turn-by-turn navigation around real-world locations.
       </div>
      </div>
      <div class="intro-side-section">
       <div class="intro-side-section-title">Data and sources</div>
       <div class="intro-side-section-body">
        Charging station information is based on open, community-maintained EV data (for example Open Charge Map and similar public datasets). The data used here is open source and does not rely on any illegal or unauthorised sources, and there is no guarantee of completeness or absolute accuracy.
       </div>
      </div>
      <div class="intro-side-section">
       <div class="intro-side-section-title">Feedback</div>
       <div class="intro-side-section-body">
        Help improve this webmap by sharing missing stations, incorrect details, or ideas for new features.
       </div>
       <textarea id="introFeedback" class="intro-feedback-input" placeholder="Type your feedback here"></textarea>
       <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
        <button id="introFeedbackSubmit" class="intro-feedback-submit">Submit feedback</button>
        <span id="introFeedbackStatus" class="intro-feedback-status"></span>
       </div>
      </div>
      <div class="intro-side-section">
       <div class="intro-side-section-title">Contact</div>
       <div class="intro-side-section-body">
        <div>This is a personal project created for learning and future improvements to EV tools.</div>
        <div class="intro-contact-line">Email: fariz.farhan95@gmail.com</div>
        <div class="intro-contact-line">Contact: +60177776506</div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script>
        const defaultConfig = {
            map_title: ' EV Station Finder'
        };

        let config = { ...defaultConfig };
        let map, markerClusterGroup, userMarker, malaysiaBounds;
        let allStations = [];
        let selectedPlugTypes = new Set();
        let stateData = {};
        let userLocation = null;
        let selectedStation = null;
        let currentView = 'clustered';
        let allMarkersArray = [];
        let routePolyline = null;
        let navigationActive = false;
        let currentRouteSteps = [];
        let currentStepIndex = 0;
        let geolocationWatchId = null;
        let navigationDestination = null;
        let routeTotalDistanceKm = 0;
        let routeTotalDurationMin = 0;
        let baseLayer = null;
        let isDarkMode = false;
        let wasDarkBeforeNav = false;
        let lastHeading = null;
        let smoothedHeading = 0;
        let lastRerouteTime = 0;
        let navGlMap = null;
        let navGlMarker = null;
        let navGlDestMarker = null;
        let navGlRouteData = null;
        let navigationRouteGeoJSON = null;
        let navGl3DEnabled = false;
        const NAV_GL_STYLE_LIGHT = 'https://tiles.openfreemap.org/styles/positron';
        const NAV_GL_STYLE_DARK = 'https://tiles.openfreemap.org/styles/liberty';
        const MALAYSIA_STATES = [
            'Johor','Kedah','Kelantan','Melaka','Negeri Sembilan','Pahang','Perak','Perlis','Pulau Pinang','Sabah','Sarawak','Selangor','Terengganu','Kuala Lumpur'
        ];
        let filterAvailable = false;
        let filterCable = false;
        let filterMinPower = 0;
        let filterMaxPower = 400;
       
        function normalizeConnectionType(c) {
        // 1. Check for ID (Most reliable - works for both raw API and processed objects)
        const id = c?.ConnectionTypeID || c?.ConnectionType?.ID || c?.id;
        const idMap = {
            33: 'CCS (Type 2)',
            2: 'CHAdeMO',
            25: 'Type 2 (Socket)',
            1036: 'Type 2 (Tethered)',
            1: 'Type 1 (J1772)',
            30: 'Tesla (Model S/X)',
            27: 'Tesla Supercharger',
            32: 'CCS (Type 1)',
            3: 'BS1363 3-Pin'
        };
        if (idMap[id]) return idMap[id];

        // 2. If already processed, use the existing type
        if (c?.type && c.type !== 'Unknown') return c.type;

        // 3. Smart Keyword Fallback (Checks Level, Current, and Description)
        let t = (c?.ConnectionType?.Title) || (c?.ConnectionType?.FormalName) || '';
        if (!t || t.toLowerCase() === 'unknown') {
            const level = (c?.Level?.Title || c?.level || '').toLowerCase();
            const current = (c?.CurrentType?.Title || c?.current || '').toLowerCase();
            const desc = (c?.ConnectionType?.Description || '').toLowerCase();
            const combined = `${level} ${current} ${desc}`;

            if (combined.includes('ccs') || combined.includes('combo')) return 'CCS';
            if (combined.includes('chademo')) return 'CHAdeMO';
            if (combined.includes('type 2') || combined.includes('mennekes')) return 'Type 2';
            if (combined.includes('type 1') || combined.includes('yazaki')) return 'Type 1';
            if (combined.includes('tesla')) return 'Tesla';
            if (current.includes('dc')) return 'DC Fast';
            if (current.includes('ac')) return 'AC';
        }
        return t ? t : 'Unknown';
    }

        function aggregateConnections(conns) {
            if (!Array.isArray(conns) || conns.length === 0) return '-';
            const map = new Map();
            conns.forEach(c => {
                const type = normalizeConnectionType(c);
                const key = type.toLowerCase();
                const power = typeof c.power === 'number' ? c.power : (typeof c.PowerKW === 'number' ? c.PowerKW : null);
                const item = map.get(key) || { type, count: 0, maxPower: 0 };
                item.count += 1;
                if (power && power > item.maxPower) item.maxPower = power;
                map.set(key, item);
            });
            return Array.from(map.values()).map(i => {
                if (i.maxPower && i.maxPower > 0) return `${i.type} (${i.count})  ${i.maxPower}kW`;
                return `${i.type} (${i.count})`;
            }).join(', ');
        }

        function deriveFullType(c) {
            const base = normalizeConnectionType(c);
            const level = (c.level || c.Level?.Title || '')?.toLowerCase();
            const tether = level.includes('tethered') ? ' (Tethered Connector)' : '';
            return (base || 'Unknown') + tether;
        }

        function getConnectorIconName(type) {
            const t = (type || '').toLowerCase();
            if (t.includes('ccs')) return 'ccs';
            if (t.includes('type 2') || t.includes('mennekes')) return 'type2';
            if (t.includes('type 1') || t.includes('yazaki')) return 'type1';
            if (t.includes('chademo')) return 'chademo';
            if (t.includes('gb/t')) return 'gbt';
            if (t.includes('tesla')) return 'tesla';
            if (t.includes('scame')) return 'scame';
            return 'unknown';
        }

        function getIconSvg(iconName) {
            const tpl = document.querySelector(`#equipmentIconsTemplate svg[data-icon="${iconName}"]`);
            return tpl ? tpl.outerHTML : document.querySelector('#equipmentIconsTemplate svg[data-icon="unknown"]').outerHTML;
        }

        function renderEquipmentDetails(conns, isOperational) {
            const list = document.getElementById('detailEquipmentList');
            if (!list) return;
            if (!Array.isArray(conns) || conns.length === 0) { list.innerHTML = ''; return; }
            list.innerHTML = conns.map(c => {
                const type = deriveFullType(c);
                const icon = getIconSvg(getConnectorIconName(type));
                const qty = (typeof c.quantity === 'number' && c.quantity > 0) ? c.quantity : 1;
                const power = (typeof c.power === 'number' && c.power > 0) ? `${c.power} kW` : '-';
                const current = (c.current && c.current.trim() !== '') ? c.current : (c.level || '');
                const level = c.level || '';
                const ampsVolt = [c.amps ? `${c.amps}A` : '', c.voltage ? `${c.voltage}V` : ''].filter(Boolean).join(' ');
                const op = (c.status && c.status.trim() !== '') ? c.status : (isOperational ? 'Operational' : '-');
                const idText = c.id ? String(c.id) : '';
                return `
                <div class="equipment-item">
                    <div class="equipment-icon">${icon}</div>
                    <div class="equipment-meta">
                        <div class="equipment-sub">${qty}   ${op}</div>
                        <div class="equipment-title">${type}</div>
                        <div class="equipment-sub">${power}</div>
                        <div class="equipment-sub">${current || level || '-'}</div>
                        <div class="equipment-sub">${[ampsVolt, idText].filter(Boolean).join(' ') || '-'}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function generatePlugFilters() {
            const grid = document.getElementById('dynamicPlugFilters');
            if (!grid) return;
            
            grid.innerHTML = ''; // Clear old ones
            const uniqueTypes = new Set();

            // 1. Scan data for all available plug types
            allStations.forEach(s => {
                (s.properties.connections || []).forEach(c => {
                    if (c.type && c.type !== 'Unknown') uniqueTypes.add(c.type);
                });
            });

            // 2. Create the buttons
            const plugEmojis = {
                'CCS (Type 2)': '',
                'CCS (Type 1)': '',
                'CHAdeMO': '',
                'Tesla (Model S/X)': '',
                'Tesla Supercharger': '',
                'Type 2 (Socket)': '',
                'Type 2 (Tethered)': '',
                'Type 1 (J1772)': '',
                'BS1363 3-Pin': '',
                'Unknown': ''
            };

            Array.from(uniqueTypes).sort().forEach(type => {
                const chip = document.createElement('div');
                chip.className = 'chip' + (selectedPlugTypes.has(type) ? ' active' : '');
                
                // Add gray emoji
                const emoji = plugEmojis[type] || '';
                chip.innerHTML = `<div class="chip-icon">${emoji}</div><div class="chip-label">${type}</div>`;

                chip.onclick = () => {
                    chip.classList.toggle('active');
                    if (chip.classList.contains('active')) {
                        selectedPlugTypes.add(type);
                    } else {
                        selectedPlugTypes.delete(type);
                    }
                    // Trigger the map refresh (no zoom change, only markers)
                    const activeCard = document.querySelector('.state-summary-card.active');
                    renderStations(
                        activeCard ? activeCard.querySelector('.state-summary-name').textContent : null,
                        false
                    );
                };
                grid.appendChild(chip);
            });
        }

        function normalizeStateName(raw, lat, lon, addressInfo) {
            const v = (raw || '').trim().toLowerCase();
            const alias = {
                'johor': 'Johor',
                'johor ': 'Johor',
                "johor darul ta'zim": 'Johor',
                'selangor': 'Selangor',
                'melaka': 'Melaka',
                'malacca': 'Melaka',
                'negeri sembilan': 'Negeri Sembilan',
                'pulau pinang': 'Pulau Pinang',
                'penang': 'Pulau Pinang',
                'perlis': 'Perlis',
                'kedah': 'Kedah',
                'perak': 'Perak',
                'pahang': 'Pahang',
                'terengganu': 'Terengganu',
                'kelantan': 'Kelantan',
                'sabah': 'Sabah',
                'sarawak': 'Sarawak',
                'labuan': 'Labuan',
                'putrajaya': 'Putrajaya',
                'kuala lumpur': 'Kuala Lumpur',
                'wilayah persekutuan kuala lumpur': 'Kuala Lumpur',
                'wp kuala lumpur': 'Kuala Lumpur',
                'w.p. kuala lumpur': 'Kuala Lumpur',
                'kl': 'Kuala Lumpur',
                'sungai buloh': 'Selangor',
                'shah alam': 'Selangor',
                'subang jaya': 'Selangor',
                'johor bahru': 'Johor',
                'george town': 'Pulau Pinang',
                'butterworth': 'Pulau Pinang',
                'ipoh': 'Perak',
                'kota kinabalu': 'Sabah',
                'sandakan': 'Sabah',
                'tawau': 'Sabah',
                'kuching': 'Sarawak',
                'miri': 'Sarawak',
                'bintulu': 'Sarawak'
            };
            if (alias[v]) return alias[v];
            const latNum = typeof lat === 'number' ? lat : (addressInfo?.Latitude || null);
            const lonNum = typeof lon === 'number' ? lon : (addressInfo?.Longitude || null);
            if (latNum == null || lonNum == null) return raw && raw.toLowerCase() !== 'unknown' ? raw : 'Unknown';
            const s = [
                { n: 'Perlis', minLat: 6.30, maxLat: 6.80, minLon: 100.10, maxLon: 100.50 },
                { n: 'Kedah', minLat: 5.00, maxLat: 6.70, minLon: 100.00, maxLon: 101.20 },
                { n: 'Pulau Pinang', minLat: 5.20, maxLat: 5.55, minLon: 100.20, maxLon: 100.55 },
                { n: 'Perak', minLat: 3.60, maxLat: 5.70, minLon: 100.50, maxLon: 101.50 },
                { n: 'Selangor', minLat: 2.60, maxLat: 3.90, minLon: 101.15, maxLon: 101.95 },
                { n: 'Kuala Lumpur', minLat: 3.05, maxLat: 3.25, minLon: 101.62, maxLon: 101.75 },
                { n: 'Putrajaya', minLat: 2.90, maxLat: 2.96, minLon: 101.65, maxLon: 101.75 },
                { n: 'Negeri Sembilan', minLat: 2.50, maxLat: 3.20, minLon: 101.80, maxLon: 102.40 },
                { n: 'Melaka', minLat: 2.10, maxLat: 2.50, minLon: 102.10, maxLon: 102.50 },
                { n: 'Johor', minLat: 1.20, maxLat: 2.20, minLon: 102.50, maxLon: 104.30 },
                { n: 'Pahang', minLat: 2.70, maxLat: 4.70, minLon: 101.50, maxLon: 103.50 },
                { n: 'Terengganu', minLat: 4.10, maxLat: 5.80, minLon: 102.60, maxLon: 103.70 },
                { n: 'Kelantan', minLat: 4.60, maxLat: 6.20, minLon: 101.80, maxLon: 102.70 },
                { n: 'Sarawak', minLat: 0.80, maxLat: 5.30, minLon: 109.60, maxLon: 115.00 },
                { n: 'Sabah', minLat: 4.20, maxLat: 7.50, minLon: 115.00, maxLon: 118.70 },
                { n: 'Labuan', minLat: 5.25, maxLat: 5.37, minLon: 115.18, maxLon: 115.40 }
            ];
            const hit = s.find(b => latNum >= b.minLat && latNum <= b.maxLat && lonNum >= b.minLon && lonNum <= b.maxLon);
            if (hit) return hit.n;
            return raw && raw.toLowerCase() !== 'unknown' ? raw : 'Unknown';
        }

       /**
        * 1. Initialize the element SDK
        * This waits for the SDK and any configuration changes before starting the map.
        */
        async function initSDK() {
            // Wait for Element SDK to initialize
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (newConfig) => {
                        config = { ...defaultConfig, ...newConfig };
                        // Refresh markers if configuration (like cluster settings) changes, without changing view
                        renderStations(null, false); 
                    }
                });
            }
            
            // Start map setup only after SDK is ready
            initMap();
        }

        /**
        * 2. Initialize the Leaflet Map
        * Sets up the map layers and then triggers data loading.
        */
        function initMap() {
            map = L.map('map', {
                zoomControl: false
            });
        
            baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);

            malaysiaBounds = L.latLngBounds([-1.0, 96.0], [9.0, 122.0]);
            map.fitBounds(malaysiaBounds);

            // Setup marker clustering
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 60,
                iconCreateFunction: createClusterIcon,
                zoomToBoundsOnClick: false
            });

            markerClusterGroup.on('clusterclick', (e) => {
                const bounds = e.layer.getBounds();
                map.flyToBounds(bounds, {
                    animate: true,
                    duration: 1.6,
                    easeLinearity: 0.2,
                    padding: [40, 40]
                });
            });

            /**
            * 3. Load Data and Refresh UI
            * We use .then() to ensure this code runs ONLY after data is fully downloaded.
            */
            loadEVStations().then(() => {
                // --- CRITICAL STEPS TO UPDATE COUNTERS FROM 0 ---
                processStations();
                populateStateList();
                updateStats();
                updateIntroSummary();
                // ------------------------------------------------

                // Setup UI features
                generatePlugFilters(); // Generates Type 2, CCS, etc. buttons
                setupEventListeners(); // Attaches click listeners to map buttons
                
                // Final Step: Draw markers on the map, keep initial Malaysia view
                renderStations(null, false);

                // Auto-center to user location on first load (with smooth zoom)
                getUserLocation();

                const autoHidePanels = () => {
                    if (window.innerWidth > 768) return;
                    const sidePanel = document.getElementById('sidePanel');
                    const filtersPanel = document.getElementById('filtersPanel');
                    if (sidePanel) {
                        sidePanel.classList.remove('expanded');
                        sidePanel.classList.add('minimized');
                    }
                    if (filtersPanel) {
                        filtersPanel.classList.remove('mobile-open');
                    }
                };

                // On mobile, start with the side panel minimized when the map first loads
                autoHidePanels();

                map.on('click', autoHidePanels);
                map.on('movestart', autoHidePanels);
            }).catch(error => {
                console.error("Failed to load EV stations:", error);
            });
        }
        function toggleMapTheme(isDark) {
            if (!map) return;
            if (baseLayer) {
                map.removeLayer(baseLayer);
            }
            const url = isDark
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            baseLayer = L.tileLayer(url, { maxZoom: 19 });
            baseLayer.addTo(map);
        }

        function ensureNavGlMap() {
            if (typeof maplibregl === 'undefined') return;
            if (navGlMap) return;
            const container = document.getElementById('navGlMap');
            if (!container) return;
            const center = userLocation ? [userLocation.lng, userLocation.lat] : [101.6869, 3.139];
            navGlMap = new maplibregl.Map({
                container: 'navGlMap',
                style: NAV_GL_STYLE_LIGHT,
                center,
                zoom: 17,
                pitch: 60,
                bearing: 0,
                attributionControl: true
            });
            // Removed default NavigationControl as per user request
            navGlMap.on('load', () => {
                if (!navGlMap.getLayer('3d-buildings')) {
                    const style = navGlMap.getStyle();
                    let buildingSource = 'openmaptiles';
                    let buildingSourceLayer = 'building';

                    if (style) {
                        // 1. Try to find an existing building layer to infer source/layer
                        if (style.layers) {
                            const existingBuildingLayer = style.layers.find(l => 
                                (l.id.includes('building') || l['source-layer'] === 'building') && 
                                l.type !== 'fill-extrusion'
                            );
                            if (existingBuildingLayer) {
                                buildingSource = existingBuildingLayer.source;
                                if (existingBuildingLayer['source-layer']) {
                                    buildingSourceLayer = existingBuildingLayer['source-layer'];
                                }
                            }
                        }
                        // 2. Fallback: if 'openmaptiles' missing, pick first vector source
                        if (style.sources && !style.sources[buildingSource]) {
                             const vectorSource = Object.keys(style.sources).find(key => style.sources[key].type === 'vector');
                             if (vectorSource) buildingSource = vectorSource;
                        }
                    }

                    navGlMap.addLayer({
                        id: '3d-buildings',
                        type: 'fill-extrusion',
                        source: buildingSource,
                        'source-layer': buildingSourceLayer,
                        minzoom: 13,
                        layout: {
                            visibility: 'visible'
                        },
                        paint: {
                            'fill-extrusion-color': '#eeeeee',
                            'fill-extrusion-opacity': 0.5,
                            'fill-extrusion-height': [
                                'coalesce',
                                ['get', 'render_height'],
                                ['get', 'height'],
                                15
                            ],
                            'fill-extrusion-base': 0
                        }
                    }, undefined);
                }

                // Add route source and layer
                if (!navGlMap.getSource('route-source')) {
                    navGlMap.addSource('route-source', {
                        type: 'geojson',
                        data: navigationRouteGeoJSON || { type: 'FeatureCollection', features: [] }
                    });
                    navGlMap.addLayer({
                        id: 'route-layer',
                        type: 'line',
                        source: 'route-source',
                        layout: {
                            'line-cap': 'round',
                            'line-join': 'round'
                        },
                        paint: {
                            'line-color': '#007FFF',
                            'line-width': 8,
                            'line-blur': 1
                        }
                    });
                }

                if (!navGlMarker) {
                    const el = document.createElement('div');
                    el.className = 'nav-gl-marker';
                    el.innerHTML = `
                    <svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                        <path d="M32 10 L50 50 Q32 42 14 50 Z" fill="#e31937" stroke="white" stroke-width="5" stroke-linejoin="round" stroke-linecap="round"/>
                    </svg>
                    `;
                    
                    navGlMarker = new maplibregl.Marker({ element: el, anchor: 'center', rotationAlignment: 'map' })
                        .setLngLat(center)
                        .addTo(navGlMap);
                }
            });
        }

        function updateNavRouteLine() {
            if (navGlMap && navGlMap.getSource('route-source') && navigationRouteGeoJSON) {
                navGlMap.getSource('route-source').setData(navigationRouteGeoJSON);
            }
        }

        function updateNavGlRoute(rawCoords) {
            if (!navGlMap || !rawCoords || !rawCoords.length) return;
            if (!navGlMap.isStyleLoaded()) {
                navGlMap.once('load', () => updateNavGlRoute(rawCoords));
                return;
            }

            // Update Destination Marker
            const destCoords = rawCoords[rawCoords.length - 1];
            if (navGlDestMarker) {
                navGlDestMarker.setLngLat(destCoords);
            } else {
                const el = document.createElement('div');
                el.className = 'nav-gl-dest-marker';
                el.innerHTML = '';
                navGlDestMarker = new maplibregl.Marker({ element: el })
                    .setLngLat(destCoords)
                    .addTo(navGlMap);
            }

            const data = {
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: rawCoords
                },
                properties: {}
            };
            navGlRouteData = data;
            if (navGlMap.getSource('nav-route')) {
                navGlMap.getSource('nav-route').setData(data);
            } else {
                navGlMap.addSource('nav-route', {
                    type: 'geojson',
                    data
                });
                navGlMap.addLayer({
                    id: 'nav-route-line',
                    type: 'line',
                    source: 'nav-route',
                    layout: {
                        'line-cap': 'round',
                        'line-join': 'round'
                    },
                    paint: {
                        'line-color': '#007FFF',
                        'line-width': 6,
                        'line-opacity': 0.95
                    }
                });
                navGlMap.addLayer({
                    id: 'nav-route-arrows',
                    type: 'symbol',
                    source: 'nav-route',
                    layout: {
                        'symbol-placement': 'line',
                        'symbol-spacing': 80,
                        'text-field': '',
                        'text-size': 16,
                        'text-keep-upright': true
                    },
                    paint: {
                        'text-color': '#ef4444',
                        'text-halo-color': '#f9fafb',
                        'text-halo-width': 1
                    }
                });
            }
            const bounds = rawCoords.reduce((b, c) => b.extend(c), new maplibregl.LngLatBounds(rawCoords[0], rawCoords[0]));
            navGlMap.fitBounds(bounds, { padding: 120, pitch: 45 });
            if (!navGlMarker) {
                const el = document.createElement('div');
                el.className = 'nav-gl-marker';
                navGlMarker = new maplibregl.Marker({ element: el, anchor: 'center' })
                    .setLngLat(rawCoords[0])
                    .addTo(navGlMap);
            } else {
                navGlMarker.setLngLat(rawCoords[0]);
            }
        }

        function createClusterIcon(cluster) {
            const count = cluster.getChildCount();
            const sz = count < 10 ? 40 : (count > 50 ? 60 : 50);
            return L.divIcon({
                html: `<div style="background: linear-gradient(135deg, #007FFF 0%, #2a52be 100%); width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; font-size: 12px; border: 3px solid white; box-shadow: 0 4px 12px rgba(0, 127, 255, 0.3);">${count}</div>`,
                className: `marker-cluster`,
                iconSize: [sz, sz],
                iconAnchor: [sz / 2, sz / 2]
            });
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function loadEVStations() {
            try {
                showToast(' Loading Malaysian stations...');
                const apiUrl = 'https://api.openchargemap.io/v3/poi/?output=json&countrycode=MY&maxresults=10000&compact=false&verbose=true&key=c10f1691-d3a4-4408-bf34-ff9a3b3e69bd';
                const response = await fetch(apiUrl);
                const data = await response.json();

                allStations = data.map((station, idx) => ({
                    properties: {
                        name: station.AddressInfo?.Title ?? '-',
                        operator: station.OperatorInfo?.Title ?? '-',
                        operatorSite: station.OperatorInfo?.WebsiteURL || '',
                        operatorEmail: station.OperatorInfo?.ContactEmail || '',
                        state: normalizeStateName(
                            station.AddressInfo?.StateOrProvince,
                            station.AddressInfo?.Latitude,
                            station.AddressInfo?.Longitude,
                            station.AddressInfo
                        ),
                        chargers: station.NumberOfPoints ?? 1,
                        addressLine1: station.AddressInfo?.AddressLine1 ?? '',
                        town: station.AddressInfo?.Town ?? '',
                        postcode: station.AddressInfo?.Postcode ?? '',
                        usage: station.UsageType?.Title ?? '-',
                        usageCost: station.UsageCost ?? '',
                        access: station.AddressInfo?.AccessComments ?? '',
                        statusTitle: station.StatusType?.Title ?? '-',
                        isOperational: station.StatusType?.IsOperational ?? false,
                        image: station.MediaItems?.[0]?.ItemURL || station.MediaItems?.[0]?.ItemThumbnailURL || null,
                        connections: (station.Connections || []).map(c => ({
                            type: normalizeConnectionType(c),
                            power: c?.PowerKW ?? null,
                            level: c?.Level?.Title ?? '',
                            current: c?.CurrentType?.Title ?? '',
                            amps: c?.Amps ?? null,
                            voltage: c?.Voltage ?? null,
                            quantity: c?.Quantity ?? 1,
                            status: c?.StatusType?.Title ?? '-',
                            id: c?.ID ?? null
                        }))
                    },
                    geometry: { 
                        coordinates: [station.AddressInfo?.Longitude ?? 0, station.AddressInfo?.Latitude ?? 0]
                    },
                    id: idx
                })).filter(s => s.geometry.coordinates[0] !== 0);

                processStations();
                renderStations(null, false);
                updateStats();
                populateStateList();
                updateNearestStations();
                showToast(` Loaded ${allStations.length} stations`);
            } catch (error) {
                showToast(' API Error');
            }
        }

        function processStations() {
            stateData = {};
            allStations.forEach(station => {
                const state = station.properties.state || 'Other';
                if (!stateData[state]) stateData[state] = [];
                stateData[state].push(station);
            });
            
            // We defer rendering to populateStateList() to ensure consistent ordering
            // and use of the global stateData we just populated.
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function getClosestPointOnRoute(lat, lng) {
            if (!routePolyline || !map || typeof L === 'undefined') {
                return { lat, lng, distanceKm: 0 };
            }
            let latlngs = routePolyline.getLatLngs();
            if (!latlngs || latlngs.length === 0) {
                return { lat, lng, distanceKm: 0 };
            }
            if (Array.isArray(latlngs[0])) {
                latlngs = latlngs.flat();
            }
            const targetPoint = map.latLngToLayerPoint([lat, lng]);
            let closestPoint = null;
            let minDist = Infinity;

            for (let i = 0; i < latlngs.length - 1; i++) {
                const p1 = map.latLngToLayerPoint(latlngs[i]);
                const p2 = map.latLngToLayerPoint(latlngs[i + 1]);
                const candidate = L.LineUtil.closestPointOnSegment(targetPoint, p1, p2);
                const dist = targetPoint.distanceTo(candidate);
                if (dist < minDist) {
                    minDist = dist;
                    closestPoint = candidate;
                }
            }

            if (!closestPoint) {
                return { lat, lng, distanceKm: 0 };
            }

            const closestLatLng = map.layerPointToLatLng(closestPoint);
            const distanceKm = getDistance(lat, lng, closestLatLng.lat, closestLatLng.lng);
            return { lat: closestLatLng.lat, lng: closestLatLng.lng, distanceKm };
        }

        function latLngToTile(lat, lng, zoom) {
            const rad = lat * Math.PI / 180;
            const n = Math.pow(2, zoom);
            const x = Math.floor((lng + 180) / 360 * n);
            const y = Math.floor((1 - Math.log(Math.tan(rad) + 1 / Math.cos(rad)) / Math.PI) / 2 * n);
            return { x, y };
        }

        function renderStations(filterState = null, adjustView = true) {
            // 1. Clear Existing Markers
            if (map.hasLayer(markerClusterGroup)) markerClusterGroup.clearLayers();
            allMarkersArray.forEach(m => map.removeLayer(m));
            allMarkersArray = [];

            // 2. Legend & Card UI Logic
            const mapLegend = document.getElementById('mapLegend');
            const defaultLegendItem = document.getElementById('defaultLegendItem');
            const filteredLegendItem = document.getElementById('filteredLegendItem');
            const filteredLegendText = document.getElementById('filteredLegendText');

            // Update the Summary Cards and Legend based on selected state
            if (filterState) {
                mapLegend.classList.add('highlighted');
                defaultLegendItem.style.display = 'none';
                filteredLegendItem.style.display = 'flex';
                filteredLegendText.textContent = 'Filtered: ' + filterState;
            } else {
                mapLegend.classList.remove('highlighted');
                defaultLegendItem.style.display = 'flex';
                filteredLegendItem.style.display = 'none';
            }

            // 3. APPLY FILTERS (State + Plug Type + Power)
            let stationsToRender = filterState ? 
                allStations.filter(s => s.properties.state === filterState) : 
                allStations;

            // Filter: Available (Operational)
            if (filterAvailable) {
                stationsToRender = stationsToRender.filter(s => s.properties.isOperational);
            }

            // Filter: With Cable (Tethered)
            if (filterCable) {
                stationsToRender = stationsToRender.filter(s => 
                    (s.properties.connections || []).some(c => {
                        const t = (c.type || '').toLowerCase();
                        // CCS, CHAdeMO, Tesla are always tethered. Type 2 can be tethered.
                        return t.includes('tethered') || 
                               t.includes('ccs') || 
                               t.includes('chademo') || 
                               t.includes('tesla');
                    })
                );
            }

            // Plug Type Filter (Multi-select)
            if (selectedPlugTypes.size > 0) {
                stationsToRender = stationsToRender.filter(s => 
                    (s.properties.connections || []).some(c => {
                        const type = (c.type || '').toLowerCase();
                        return Array.from(selectedPlugTypes).some(filter => 
                            type.includes(filter.toLowerCase())
                        );
                    })
                );
            }

            // 4. RENDERING MARKERS
            stationsToRender.forEach(station => {
                const coords = station.geometry.coordinates;
                const icon = L.divIcon({
                    html: `<div style="width: 28px; height: 28px; background: ${filterState ? '#15B392' : '#3559E8'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.2);"><svg viewBox="0 0 24 24" fill="white" style="width: 14px; height: 14px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>`,
                    className: 'ev-marker',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                const marker = L.marker([coords[1], coords[0]], { icon });
                marker.on('click', () => showStationPopup(station));
                
                if (currentView === 'clustered') markerClusterGroup.addLayer(marker);
                else marker.addTo(map);
                allMarkersArray.push(marker);
            });

            if (currentView === 'clustered') map.addLayer(markerClusterGroup);
            if (adjustView && stationsToRender.length > 0) {
                const latLngs = stationsToRender.map(s => [s.geometry.coordinates[1], s.geometry.coordinates[0]]);
                const bounds = L.latLngBounds(latLngs);
                const center = bounds.getCenter();

                if (stationsToRender.length === 1) {
                    map.flyTo(center, 14, {
                        animate: true,
                        duration: 1.8,
                        easeLinearity: 0.2
                    });
                } else {
                    const targetZoom = Math.min(map.getBoundsZoom(bounds, true), 11);
                    map.flyTo(center, targetZoom, {
                        animate: true,
                        duration: 1.8,
                        easeLinearity: 0.2
                    });
                }
            }
            updateNearestStations(stationsToRender);
            updateClearButtonVisibility();
        }

        function resetToMalaysiaView() {
            if (map && malaysiaBounds) {
                map.flyToBounds(malaysiaBounds, {
                    animate: true,
                    duration: 2.0,
                    easeLinearity: 0.2
                });
            }
        }

        function showStationPopup(station) {
            // 1. Save selected station for navigation
            selectedStation = {
                lat: station.geometry.coordinates[1],
                lng: station.geometry.coordinates[0],
                name: station.properties.name,
                image: station.properties.image
            };

            const props = station.properties;

            // --- SMART ADDRESS LOGIC ---
            // If the main address is missing, we combine other fields the data has
            const fallbackAddress = [props.addressLine1, props.town, props.postcode]
                .filter(item => item && item.trim() !== "" && item !== '-')
                .join(", ");

            const finalAddress = (props.address && props.address !== '-') ? 
                                props.address : 
                                (fallbackAddress || 'Location details not provided');

            // 2. Fill the Text Details using your existing IDs
            document.getElementById('detailStationName').textContent = props.name || 'EV Station';
            document.getElementById('detailOperator').textContent = props.operator || 'Unknown Operator';
            document.getElementById('detailLocation').textContent = finalAddress; // Updated logic
            document.getElementById('detailState').textContent = props.state || '-';
            document.getElementById('detailUsage').textContent = props.usage || 'Public';
            document.getElementById('detailAccess').textContent = props.access || 'Open 24/7';
            const priceRow = document.getElementById('detailPriceRow');
            const priceEl = document.getElementById('detailPrice');
            if (priceRow && priceEl) {
                const rawPrice = props.usageCost || '';
                const trimmed = rawPrice.trim();
                if (trimmed) {
                    priceRow.style.display = '';
                    priceEl.textContent = trimmed;
                } else {
                    priceRow.style.display = 'none';
                    priceEl.textContent = '-';
                }
            }
            
            // 3. Update Charger Count and list
            const connections = props.connections || [];
            document.getElementById('detailChargers').textContent = `${connections.length} Chargers Available`;

            const equipmentList = document.getElementById('detailEquipmentList');
            equipmentList.innerHTML = ''; 

            connections.forEach(conn => {
                const item = document.createElement('div');
                item.className = 'equipment-item';
                
                const isDC = (conn.power > 40);
                const badgeText = isDC ? 'DC FAST' : 'AC';

                item.innerHTML = `
                    <div class="equipment-icon">
                        <span style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#22c55e;"></span>
                    </div>
                    <div class="equipment-meta">
                        <div class="equipment-title">${conn.type || 'Charger'}</div>
                        <div class="equipment-sub">${conn.power ? conn.power + ' kW' : 'N/A'}  ${conn.status || 'Available'}</div>
                    </div>
                    <div class="equipment-badge" style="${isDC ? 'background: #FF5722; color: white; border: none;' : ''}">
                        ${badgeText}
                    </div>
                `;
                equipmentList.appendChild(item);
            });

            // 4. Open the Panel (Slide from Right)
            document.getElementById('stationDetailPanel').classList.add('active');
        }

        function updateUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    userLocation = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude
                    };

                    // Zoom the map to user location
                    map.setView([userLocation.lat, userLocation.lng], 10);

                    // Add/Update the blue user marker
                    if (window.userMarker) {
                        window.userMarker.setLatLng([userLocation.lat, userLocation.lng]);
                    } else {
                        const userIcon = L.divIcon({
                            html: '<div class="user-pulse-marker"></div>',
                            className: '',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });
                        window.userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map);
                    }

                    // Update the "Nearest Stations" sidebar list
                    updateNearestStations();
                    
                }, (err) => {
                    alert("Please enable location permissions.");
                }, { enableHighAccuracy: true });
            }
        }

        // Connect the button to the function - REMOVED (Handled in setupEventListeners)
        // document.getElementById('locationBtn').onclick = ...
        function updateStats() {
            const totalStationsEl = document.getElementById('totalStations');
            const totalStatesEl = document.getElementById('totalStates');
            
            if (totalStationsEl) {
                totalStationsEl.textContent = allStations.length;
            }
            
            if (totalStatesEl) {
                const uniqueStates = new Set(allStations.map(s => s.properties.state).filter(Boolean));
                totalStatesEl.textContent = uniqueStates.size;
            }
        }

        function animateIntroCount(element, target, duration) {
            if (!element) return;
            const startValue = 0;
            const startTime = performance.now();
            const endTime = startTime + duration;

            function frame(now) {
                const progress = Math.min((now - startTime) / (endTime - startTime), 1);
                const value = Math.floor(startValue + (target - startValue) * progress);
                element.textContent = value.toLocaleString();
                if (progress < 1) {
                    requestAnimationFrame(frame);
                }
            }

            requestAnimationFrame(frame);
        }

        function updateIntroSummary() {
            const totalStationsEl = document.getElementById('totalStations');
            const totalStatesEl = document.getElementById('totalStates');
            const introStationsEl = document.getElementById('introTotalStations');
            const introStatesEl = document.getElementById('introTotalStates');
            if (!totalStationsEl || !totalStatesEl || !introStationsEl || !introStatesEl) return;

            const stations = parseInt(totalStationsEl.textContent || '0', 10) || 0;
            const states = parseInt(totalStatesEl.textContent || '0', 10) || 0;

            animateIntroCount(introStationsEl, stations, 900);
            animateIntroCount(introStatesEl, states, 900);
        }

        function populateStateList() {
            const container = document.getElementById('stateSummary');
            container.innerHTML = '';
            const counts = MALAYSIA_STATES.map(s => ({ state: s, count: (stateData[s] || []).length }));
            counts.sort((a,b) => b.count - a.count);
            counts.forEach(({ state, count }) => {
                const card = document.createElement('div');
                card.className = 'state-summary-card';
                card.innerHTML = `<span class="state-summary-name">${state}</span><span class="state-summary-count">${count}</span>`;
                card.onclick = () => {
                    const isActive = card.classList.contains('active');
                    document.querySelectorAll('.state-summary-card').forEach(c => c.classList.remove('active'));
                    if (isActive) {
                        renderStations(null, false);
                        resetToMalaysiaView();
                    } else {
                        card.classList.add('active');
                        renderStations(state);
                    }
                    updateClearButtonVisibility();
                };
                container.appendChild(card);
            });
            updateClearButtonVisibility();
        }

        function updateClearButtonVisibility() {
            const btn = document.getElementById('clearStateSelection');
            const active = document.querySelector('.state-summary-card.active');
            if (!btn) return;
            btn.style.display = active ? 'inline-block' : 'none';
        }

        function updateNearestStations(sourceStations = allStations) {
            const list = document.getElementById('nearestList');
            if (!userLocation) {
                list.innerHTML = '<div style="padding: 10px; color: #999; font-size: 12px; text-align: center;">Enable location to see nearest</div>';
                return;
            }
            const nearest = sourceStations
                .map(s => ({ ...s, dist: getDistance(userLocation.lat, userLocation.lng, s.geometry.coordinates[1], s.geometry.coordinates[0]) }))
                    .sort((a, b) => a.dist - b.dist).slice(0, 3);
            
            list.innerHTML = nearest.map(s => `
                <div class="nearest-item" onclick="onNearestItemClick(${s.geometry.coordinates[1]}, ${s.geometry.coordinates[0]}, '${s.properties.name.replace(/'/g, "\\'")}')">
                    <div class="nearest-name">${s.properties.name}</div>
                    <div class="nearest-distance"> ${s.dist.toFixed(1)} km</div>
                </div>`).join('');
        }

        function onNearestItemClick(lat, lng, name) {
            if (window.innerWidth <= 768) {
                const station = allStations.find(s => {
                    const props = s.properties || {};
                    return Math.abs(s.geometry.coordinates[1] - lat) < 1e-6 &&
                           Math.abs(s.geometry.coordinates[0] - lng) < 1e-6 &&
                           props.name === name;
                });
                if (station) {
                    showStationPopup(station);
                    return;
                }
            }
            getDirections(lat, lng, name);
        }

        let sidePanelTouchStartY = null;
        let sidePanelTouchCurrentY = null;
        let sidePanelActivePointerId = null;

        function setupSidePanelDrag() {
            const panel = document.getElementById('sidePanel');
            if (!panel) return;
            panel.addEventListener('pointerdown', (e) => {
                if (window.innerWidth > 768) return;
                const rect = panel.getBoundingClientRect();
                if (e.clientY > rect.top + 40) return;
                sidePanelActivePointerId = e.pointerId;
                sidePanelTouchStartY = e.clientY;
                sidePanelTouchCurrentY = e.clientY;
                panel.setPointerCapture(e.pointerId);
            });
            panel.addEventListener('pointermove', (e) => {
                if (window.innerWidth > 768) return;
                if (sidePanelActivePointerId === null || e.pointerId !== sidePanelActivePointerId) return;
                sidePanelTouchCurrentY = e.clientY;
            });
            const endDrag = (e) => {
                if (window.innerWidth > 768) {
                    sidePanelTouchStartY = null;
                    sidePanelTouchCurrentY = null;
                    sidePanelActivePointerId = null;
                    return;
                }
                if (sidePanelActivePointerId === null || e.pointerId !== sidePanelActivePointerId) return;
                if (sidePanelTouchStartY === null || sidePanelTouchCurrentY === null) {
                    sidePanelTouchStartY = null;
                    sidePanelTouchCurrentY = null;
                    sidePanelActivePointerId = null;
                    return;
                }
                const deltaY = sidePanelTouchCurrentY - sidePanelTouchStartY;
                if (deltaY < -30) {
                    panel.classList.remove('minimized');
                    panel.classList.add('expanded');
                } else if (deltaY > 30) {
                    panel.classList.remove('expanded');
                    panel.classList.add('minimized');
                }
                sidePanelTouchStartY = null;
                sidePanelTouchCurrentY = null;
                sidePanelActivePointerId = null;
                panel.releasePointerCapture(e.pointerId);
            };
            panel.addEventListener('pointerup', endDrag);
            panel.addEventListener('pointercancel', endDrag);
        }

        function setupEventListeners() {
            document.getElementById('locationBtn').onclick = getUserLocation;
            
            const closeRouting = () => {
                document.getElementById('routingPanel').classList.remove('active');
                const sidePanel = document.getElementById('sidePanel');
                if (sidePanel) sidePanel.classList.remove('ui-fade-out');
                
                // Clear the route line
                if (routePolyline) {
                    map.removeLayer(routePolyline);
                    routePolyline = null;
                }
            };
            
            document.getElementById('routingClose').onclick = closeRouting;
            document.getElementById('routingClose2').onclick = closeRouting;
            
            document.getElementById('startNavBtn').onclick = startNavigation;
            document.getElementById('viewClustered').onclick = () => {
                currentView = 'clustered';
                document.getElementById('viewClustered').classList.add('active');
                document.getElementById('viewIndividual').classList.remove('active');
                const activeState = document.querySelector('.state-summary-card.active')?.querySelector('.state-summary-name')?.textContent || null;
                renderStations(activeState, false);
            };
            document.getElementById('viewIndividual').onclick = () => {
                currentView = 'individual';
                document.getElementById('viewIndividual').classList.add('active');
                document.getElementById('viewClustered').classList.remove('active');
                const activeState = document.querySelector('.state-summary-card.active')?.querySelector('.state-summary-name')?.textContent || null;
                renderStations(activeState, false);
            };
            document.getElementById('clearStateSelection').onclick = () => {
                document.querySelectorAll('.state-summary-card').forEach(c => c.classList.remove('active'));
                renderStations(null, false);
                resetToMalaysiaView();
                updateClearButtonVisibility();
            };
            const toggleAvail = document.getElementById('toggleAvailable');
            const toggleCable = document.getElementById('toggleCable');
            const rangeMin = document.getElementById('powerMin');
            const rangeMax = document.getElementById('powerMax');
            const powerMinLabel = document.getElementById('powerMinLabel');
            const powerMaxLabel = document.getElementById('powerMaxLabel');

            [toggleAvail, toggleCable].forEach(btn => {
                if (!btn) return;
                btn.onclick = () => {
                    btn.classList.toggle('active');
                    filterAvailable = !!(toggleAvail && toggleAvail.classList.contains('active'));
                    filterCable = !!(toggleCable && toggleCable.classList.contains('active'));
                    const activeStateName = document.querySelector('.state-summary-card.active')?.querySelector('.state-summary-name')?.textContent || null;
                    renderStations(activeStateName, false);
                };
            });
            const saveAddressBtn = document.getElementById('saveAddressBtn');
            if (saveAddressBtn) {
                saveAddressBtn.onclick = () => toggleSavedAddressPanel();
            }

            const sidePanelEl = document.getElementById('sidePanel');
            if (sidePanelEl) {
                sidePanelEl.addEventListener('click', () => {
                    if (window.innerWidth > 768) return;
                    if (sidePanelEl.classList.contains('minimized')) {
                        sidePanelEl.classList.remove('minimized');
                        sidePanelEl.classList.remove('expanded');
                    }
                });
            }

            if (rangeMin && rangeMax && powerMinLabel && powerMaxLabel) {
                rangeMin.oninput = () => {
                    filterMinPower = parseInt(rangeMin.value, 10);
                    if (filterMinPower > filterMaxPower) {
                        filterMinPower = filterMaxPower;
                        rangeMin.value = String(filterMinPower);
                    }
                    powerMinLabel.textContent = filterMinPower + ' kW';
                    const activeStateName = document.querySelector('.state-summary-card.active')?.querySelector('.state-summary-name')?.textContent || null;
                    renderStations(activeStateName, false);
                };

                rangeMax.oninput = () => {
                    filterMaxPower = parseInt(rangeMax.value, 10);
                    if (filterMaxPower < filterMinPower) {
                        filterMaxPower = filterMinPower;
                        rangeMax.value = String(filterMaxPower);
                    }
                    powerMaxLabel.textContent = filterMaxPower + ' kW';
                    const activeStateName = document.querySelector('.state-summary-card.active')?.querySelector('.state-summary-name')?.textContent || null;
                    renderStations(activeStateName, false);
                };
            }
            document.querySelectorAll('.plug-chip').forEach(ch => {
                ch.onclick = () => { const label = ch.getAttribute('data-type'); if (ch.classList.contains('active')) { ch.classList.remove('active'); selectedPlugTypes.delete(label); } else { ch.classList.add('active'); selectedPlugTypes.add(label); } renderStations(document.querySelector('.state-summary-card.active')?.querySelector('.state-summary-name')?.textContent || null, false); };
            });

            const filtersMiniToggle = document.getElementById('filtersMiniToggle');
            const sidePanelMiniToggle = document.getElementById('sidePanelMiniToggle');
            const filtersPanel = document.getElementById('filtersPanel');
            const sidePanel = document.getElementById('sidePanel');

            if (filtersMiniToggle && filtersPanel) {
                filtersMiniToggle.onclick = () => {
                    filtersPanel.classList.toggle('mobile-open');
                };
            }

            const navRecenterBtn = document.getElementById('navRecenterBtn');
            const navZoomInBtn = document.getElementById('navZoomInBtn');
            const navZoomOutBtn = document.getElementById('navZoomOutBtn');

            if (navRecenterBtn) {
                navRecenterBtn.onclick = () => {
                    if (userLocation && map) {
                        map.flyTo([userLocation.lat, userLocation.lng], map.getZoom(), {
                            animate: true,
                            duration: 1.0
                        });
                    }
                };
            }

            if (navZoomInBtn) {
                navZoomInBtn.onclick = () => {
                    if (map) map.zoomIn();
                };
            }

            if (navZoomOutBtn) {
                navZoomOutBtn.onclick = () => {
                    if (map) map.zoomOut();
                };
            }

            setupSidePanelDrag();

            const nightBtn = document.getElementById('nightModeBtn');
            if (nightBtn) {
                nightBtn.onclick = () => {
                    isDarkMode = !isDarkMode;
                    document.body.classList.toggle('dark-mode', isDarkMode);
                    toggleMapTheme(isDarkMode);
                };
            }

            document.getElementById('searchInput').oninput = (e) => {
                const q = e.target.value.toLowerCase();
                const res = document.getElementById('searchResults');
                if (q.length < 2) return res.classList.remove('active');
                const matches = allStations.filter(s => s.properties.name.toLowerCase().includes(q)).slice(0, 5);
                res.innerHTML = matches.map(s => `<div class="search-result-item" onclick="map.setView([${s.geometry.coordinates[1]}, ${s.geometry.coordinates[0]}], 15); document.getElementById('searchResults').classList.remove('active')">${s.properties.name}</div>`).join('');
                res.classList.add('active');
            };
        }

        function setupIntroOverlay() {
            const introOverlay = document.getElementById('introOverlay');
            const introStartBtn = document.getElementById('introStartBtn');
            const feedbackInput = document.getElementById('introFeedback');
            const feedbackSubmit = document.getElementById('introFeedbackSubmit');
            const feedbackStatus = document.getElementById('introFeedbackStatus');
            if (introOverlay && introStartBtn) {
                introStartBtn.onclick = () => {
                    introOverlay.classList.add('intro-hidden');
                    document.body.classList.remove('intro-mode');
                    setTimeout(() => {
                        introOverlay.style.display = 'none';
                    }, 600);
                };
            }

            if (feedbackInput && feedbackSubmit && feedbackStatus) {
                feedbackSubmit.onclick = () => {
                    const value = feedbackInput.value.trim();
                    if (!value) {
                        showToast(' Please type some feedback before submitting');
                        return;
                    }
                    console.log('Intro feedback:', value);
                    feedbackInput.value = '';
                    feedbackStatus.textContent = 'Thank you for your feedback!';
                    setTimeout(() => {
                        feedbackStatus.textContent = '';
                    }, 3000);
                };
            }
        }

        function onLocationFound(lat, lng, sourceLabel) {
            userLocation = { lat, lng };
            
            if (userMarker) {
                userMarker.setLatLng([lat, lng]);
            } else {
                const userIcon = L.divIcon({
                    html: '<div class="user-pulse-marker"></div>',
                    className: '',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(map);
            }
            
            map.flyTo([lat, lng], 16, {
                animate: true,
                duration: 1.5
            });
            
            updateNearestStations();
            showToast(` Location found ${sourceLabel}`);
        }

        function getIpLocation() {
            showToast(' Trying IP-based location...');
            fetch('https://ipapi.co/json/')
                .then(res => res.json())
                .then(data => {
                    if (data.latitude && data.longitude) {
                        onLocationFound(data.latitude, data.longitude, '(IP-based)');
                    } else {
                        throw new Error('Invalid IP data');
                    }
                })
                .catch(err => {
                    console.error("IP Location failed:", err);
                    showToast(' All location methods failed');
                });
        }

        function getUserLocation() {
            showToast(' Locating...');
            if (!navigator.geolocation) {
                getIpLocation();
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => onLocationFound(pos.coords.latitude, pos.coords.longitude, ''),
                (err) => {
                    console.error("GPS error:", err);
                    // If high accuracy fails, try low accuracy
                    showToast(' GPS weak, trying low accuracy...');
                    
                    navigator.geolocation.getCurrentPosition(
                        (pos) => onLocationFound(pos.coords.latitude, pos.coords.longitude, '(Low Accuracy)'),
                        (err2) => {
                            console.error("Low accuracy GPS error:", err2);
                            // If both GPS methods fail, fall back to IP
                            getIpLocation();
                        },
                        { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
                    );
                }, 
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        async function getDirections(lat, lng, name) {
            if (!userLocation) return showToast(' Enable location first');
            document.getElementById('routingDestination').textContent = name;
            document.getElementById('routingPanel').classList.add('active');
            
            // Fade out the side panel
            const sidePanel = document.getElementById('sidePanel');
            if (sidePanel) sidePanel.classList.add('ui-fade-out');

            document.getElementById('routingDistance').textContent = 'Calculating...';
            document.getElementById('routingTime').textContent = '--:--';

            const mediaCoverEl = document.querySelector('#navMediaCard .nav-media-cover');
            const mediaTitleEl = document.querySelector('#navMediaCard .nav-media-title');
            const mediaSubtitleEl = document.querySelector('#navMediaCard .nav-media-artist');
            if (mediaTitleEl) mediaTitleEl.textContent = name || 'Destination';
            if (mediaSubtitleEl) mediaSubtitleEl.textContent = 'EV charging station';
            if (mediaCoverEl) {
                let imgUrl;
                if (selectedStation && selectedStation.image) {
                    imgUrl = selectedStation.image;
                } else {
                    // Fallback to Satellite Tile (ArcGIS) for "real picture" look
                    const zoom = 17;
                    const tile = latLngToTile(lat, lng, zoom);
                    imgUrl = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${tile.y}/${tile.x}`;
                }
                mediaCoverEl.style.backgroundImage = `url('${imgUrl}')`;
                mediaCoverEl.style.backgroundSize = 'cover';
                mediaCoverEl.style.backgroundPosition = 'center';
            }

            if (routePolyline) map.removeLayer(routePolyline);

            // 1. Try OSRM Routing API
            try {
                showToast(' Calculating route...');
                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${userLocation.lng},${userLocation.lat};${lng},${lat}?overview=full&geometries=geojson&steps=true`);
                const data = await response.json();

                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    currentRouteSteps = route.legs[0].steps;
                    currentStepIndex = 0;
                    
                    const rawCoords = route.geometry.coordinates;
                    navigationRouteGeoJSON = route.geometry;
                    const coordinates = rawCoords.map(c => [c[1], c[0]]);
                    
                    routePolyline = L.polyline(coordinates, { 
                        color: '#007FFF', 
                        weight: 8,
                        opacity: 0.85,
                        lineCap: 'round',
                        lineJoin: 'round',
                        className: 'route-line'
                    }).addTo(map);
                    
                    // Update stats
                    routeTotalDistanceKm = route.distance / 1000;
                    routeTotalDurationMin = Math.round(route.duration / 60);
                    const distKm = routeTotalDistanceKm.toFixed(1);
                    const hrs = Math.floor(routeTotalDurationMin / 60);
                    const mins = routeTotalDurationMin % 60;
                    
                    document.getElementById('routingDistance').textContent = `${distKm} km`;
                    document.getElementById('routingTime').textContent = hrs > 0 ? `${hrs}h ${mins}m` : `${mins} min`;

                    // Prime HUD metrics
                    const hudDistanceEl = document.getElementById('hudDistance');
                    const hudTimeEl = document.getElementById('hudTime');
                    const hudArrivalEl = document.getElementById('hudArrival');
                    const hudRemainingLabelEl = document.getElementById('hudRemainingLabel');
                    const navArrivalEnergyEl = document.getElementById('navArrivalEnergy');

                    if (hudDistanceEl) hudDistanceEl.textContent = `${distKm} km`;
                    if (hudTimeEl) hudTimeEl.textContent = hrs > 0 ? `${hrs} hr ${mins} min` : `${mins} min`;

                    if (hudArrivalEl) {
                        const arrivalDate = new Date(Date.now() + routeTotalDurationMin * 60000);
                        const hours = arrivalDate.getHours().toString().padStart(2, '0');
                        const minutes = arrivalDate.getMinutes().toString().padStart(2, '0');
                        hudArrivalEl.textContent = `${hours}:${minutes}`;
                    }

                    if (hudRemainingLabelEl) {
                        hudRemainingLabelEl.textContent = routeTotalDurationMin > 0 ? `~${routeTotalDurationMin} min remaining` : '';
                    }

                    if (navArrivalEnergyEl) {
                        navArrivalEnergyEl.textContent = `${distKm} km`;
                    }
                    
                    map.fitBounds(routePolyline.getBounds(), { 
                        padding: [50, 50],
                        animate: true,
                        duration: 5.0
                    });
                    ensureNavGlMap();
                    updateNavGlRoute(rawCoords);
                    updateNavRouteLine();
                } else {
                    throw new Error('No route found');
                }
            } catch (err) {
                console.error("Routing failed:", err);
                showToast(' Road routing failed, showing straight line');
                
                // Fallback to straight line
                routePolyline = L.polyline([[userLocation.lat, userLocation.lng], [lat, lng]], { color: '#007FFF', weight: 6, dashArray: '10, 10' }).addTo(map);
                
                // Calculate straight line distance
                const dist = getDistance(userLocation.lat, userLocation.lng, lat, lng);
                routeTotalDistanceKm = dist;
                routeTotalDurationMin = 0;
                document.getElementById('routingDistance').textContent = `${dist.toFixed(1)} km (Linear)`;
                document.getElementById('routingTime').textContent = '--';
                
                map.fitBounds(routePolyline.getBounds(), { 
                    padding: [50, 50],
                    animate: true,
                    duration: 5.0
                });
            }

            navigationDestination = { lat, lng, name };
        }

        async function rerouteFromCurrentLocation() {
            if (!navigationDestination || !userLocation || !map) return;
            const now = Date.now();
            if (now - lastRerouteTime < 15000) return;
            lastRerouteTime = now;

            try {
                const { lat, lng, name } = navigationDestination;
                if (routePolyline) map.removeLayer(routePolyline);

                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${userLocation.lng},${userLocation.lat};${lng},${lat}?overview=full&geometries=geojson&steps=true`);
                const data = await response.json();

                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    currentRouteSteps = route.legs[0].steps;
                    currentStepIndex = 0;

                    const rawCoords = route.geometry.coordinates;
                    navigationRouteGeoJSON = route.geometry;
                    const coordinates = rawCoords.map(c => [c[1], c[0]]);

                    routePolyline = L.polyline(coordinates, {
                        color: '#007FFF',
                        weight: 8,
                        opacity: 0.85,
                        lineCap: 'round',
                        lineJoin: 'round',
                        className: 'route-line'
                    }).addTo(map);

                    routeTotalDistanceKm = route.distance / 1000;
                    routeTotalDurationMin = Math.round(route.duration / 60);

                    const distKm = routeTotalDistanceKm.toFixed(1);
                    const hrs = Math.floor(routeTotalDurationMin / 60);
                    const mins = routeTotalDurationMin % 60;

                    const hudDistanceEl = document.getElementById('hudDistance');
                    const hudTimeEl = document.getElementById('hudTime');
                    const hudArrivalEl = document.getElementById('hudArrival');
                    const hudRemainingLabelEl = document.getElementById('hudRemainingLabel');
                    const navArrivalEnergyEl = document.getElementById('navArrivalEnergy');

                    if (hudDistanceEl) hudDistanceEl.textContent = `${distKm} km`;
                    if (hudTimeEl) hudTimeEl.textContent = hrs > 0 ? `${hrs} hr ${mins} min` : `${mins} min`;

                    if (hudArrivalEl) {
                        const arrivalDate = new Date(Date.now() + routeTotalDurationMin * 60000);
                        const hours = arrivalDate.getHours().toString().padStart(2, '0');
                        const minutes = arrivalDate.getMinutes().toString().padStart(2, '0');
                        hudArrivalEl.textContent = `${hours}:${minutes}`;
                    }

                    if (hudRemainingLabelEl) {
                        hudRemainingLabelEl.textContent = routeTotalDurationMin > 0 ? `~${routeTotalDurationMin} min remaining` : '';
                    }

                    if (navArrivalEnergyEl) {
                        navArrivalEnergyEl.textContent = `${distKm} km`;
                    }

                    ensureNavGlMap();
                    updateNavGlRoute(rawCoords);
                    updateNavRouteLine();
                }
            } catch (err) {
                console.error("Re-routing failed:", err);
            }
        }

        function startNavigation() {
            if (!navigationDestination) return;
            navigationActive = true;
            wasDarkBeforeNav = isDarkMode;
            
            // Phase 1: 2D Preparation (Leaflet)
            // Zoom in on Leaflet map first
            if (userLocation) {
                map.flyTo([userLocation.lat, userLocation.lng], 18, {
                    animate: true,
                    duration: 1.2,
                    easeLinearity: 0.1
                });
            }

            // Prepare Nav Map (Hidden initially)
            const navMapEl = document.getElementById('navGlMap');
            if (navMapEl) {
                navMapEl.style.opacity = '0';
                navMapEl.style.transition = 'opacity 0.8s ease-in-out';
            }

            // Add nav-mode to trigger UI fade-outs and display nav container
            document.body.classList.add('nav-mode');
            
            // Ensure Nav Map is ready and set to top-down view (Phase 2 Prep)
            ensureNavGlMap();
            if (navGlMap && userLocation) {
                navGlMap.resize(); // Important after display:none -> block
                navGlMap.jumpTo({
                    center: [userLocation.lng, userLocation.lat],
                    zoom: 18, // Match Leaflet target
                    pitch: 0,
                    bearing: 0
                });
                
                if (navGlMap.getLayer('3d-buildings')) {
                    navGlMap.setLayoutProperty('3d-buildings', 'visibility', 'visible');
                }
            }

            // Phase 2: The Transition Hand-off
            // Wait for 800ms before showing 3D map
            setTimeout(() => {
                // Fade in Nav Map
                if (navMapEl) {
                    navMapEl.style.opacity = '1';
                }

                // Phase 3: 3D "Falling" Animation (MapLibre)
                // Start immediately with the fade
                if (navGlMap && userLocation) {
                    navGlMap.flyTo({
                        center: [userLocation.lng, userLocation.lat],
                        zoom: 18.5,
                        pitch: 65, // Target pitch
                        bearing: smoothedHeading || 0,
                        duration: 2500, // 2.5s duration
                        curve: 1.2,
                        essential: true
                    });
                }

                // UI Polish: Delay HUD and Turn Instructions
                setTimeout(() => {
                    document.getElementById('turnInstructionBar').classList.add('active');
                    document.getElementById('navHUD').classList.add('active');
                    
                    if (userLocation) {
                        updateTurnInstruction(userLocation.lat, userLocation.lng);
                    }

                    // Start tracking
                    if (navigationActive) {
                        beginTracking();
                    }
                }, 2000); // 80% of 2500ms

            }, 800); // Wait 800ms

            document.getElementById('routingPanel').classList.remove('active');

            // On mobile, briefly show the left stack cards then auto-hide after 5s
            if (window.innerWidth <= 768) {
                const leftStack = document.querySelector('.nav-left-stack');
                if (leftStack) {
                    leftStack.style.display = '';
                    setTimeout(() => {
                        if (!navigationActive) return;
                        leftStack.style.display = 'none';
                    }, 5000);
                }
            }

            // Apply 3D Tilt
            document.getElementById('map').classList.add('map-tilted');
            
            toggleMapTheme(isDarkMode);

            setTimeout(() => {
                if (map) map.invalidateSize();
            }, 350);

            // Switch to nav marker (navigation arrow)
            if (userMarker) {
                const navIcon = L.divIcon({
                    html: `
                    <svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                        <path d="M32 10 L50 50 Q32 42 14 50 Z" fill="#e31937" stroke="white" stroke-width="5" stroke-linejoin="round" stroke-linecap="round"/>
                    </svg>
                    `,
                    className: 'nav-gl-marker smooth-marker-move',
                    iconSize: [48, 48],
                    iconAnchor: [24, 24]
                });
                userMarker.setIcon(navIcon);
                userMarker.setZIndexOffset(2000);
            }
        }

        function getTurnIcon(modifier) {
            // Tesla-style: Bold, rounded, white stroke (via currentColor)
            const style = 'fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"';
            const size = 'style="width: 32px; height: 32px;"';
            const svgStart = `<svg viewBox="0 0 24 24" ${style} ${size}>`;

            if (modifier === 'arrive') {
                return `<svg viewBox="0 0 24 24" fill="currentColor" style="width: 32px; height: 32px;"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
            }
            
            let path;
            if (modifier === 'uturn') {
                 path = '<path d="M7 19v-7a4 4 0 0 1 8 0v7M7 19l-4-4M7 19l4-4"/>';
            } else if (modifier.includes('sharp left')) {
                path = '<path d="M18 20v-8a4 4 0 0 0-4-4H4M4 8l5-5M4 8l5 5"/>';
            } else if (modifier.includes('slight left')) {
                path = '<path d="M15 21v-8a6 6 0 0 0-6-6M9 7l-4-4 4-4"/>';
            } else if (modifier.includes('left')) {
                path = '<path d="M17 21v-8a4 4 0 0 0-4-4H5M5 9l5-5M5 9l5 5"/>';
            } else if (modifier.includes('sharp right')) {
                path = '<path d="M6 20v-8a4 4 0 0 1 4-4h10M20 8l-5-5M20 8l-5 5"/>';
            } else if (modifier.includes('slight right')) {
                path = '<path d="M9 21v-8a6 6 0 0 1 6-6M15 7l4-4-4-4"/>';
            } else if (modifier.includes('right')) {
                path = '<path d="M7 21v-8a4 4 0 0 1 4-4h8M19 9l-5-5M19 9l-5 5"/>';
            } else {
                // Straight
                path = '<path d="M12 21V3M5 10l7-7 7 7"/>';
            }

            return `${svgStart}${path}</svg>`;
        }

        function updateTurnInstruction(lat, lng) {
            if (!currentRouteSteps || currentRouteSteps.length === 0) return;

            // If we are at the last step
            if (currentStepIndex >= currentRouteSteps.length - 1) {
                 document.querySelector('.turn-instruction-icon').innerHTML = getTurnIcon('arrive');
                 document.getElementById('turnInstructionText').textContent = 'Arriving at destination';
                 const dist = getDistance(lat, lng, navigationDestination.lat, navigationDestination.lng);
                 document.getElementById('turnDistanceText').textContent = (dist < 1) ? (dist * 1000).toFixed(0) + ' m' : dist.toFixed(1) + ' km';
                 return;
            }

            const nextStep = currentRouteSteps[currentStepIndex + 1];
            const maneuverLoc = nextStep.maneuver.location; // [lng, lat]
            const distToManeuver = getDistance(lat, lng, maneuverLoc[1], maneuverLoc[0]);

            // Check if we reached the maneuver (< 30m)
            if (distToManeuver < 0.03) {
                currentStepIndex++;
                updateTurnInstruction(lat, lng); // Recurse
                return;
            }

            // Approximate speed limit for the current road segment using step distance/duration
            const hudSpeedLimitEl = document.getElementById('hudSpeedLimit');
            if (hudSpeedLimitEl && typeof nextStep.distance === 'number' && typeof nextStep.duration === 'number' && nextStep.duration > 0) {
                const inferredSpeed = (nextStep.distance / nextStep.duration) * 3.6; // m/s -> km/h
                const clampedSpeed = Math.max(20, Math.min(120, inferredSpeed));
                hudSpeedLimitEl.textContent = clampedSpeed.toFixed(0);
            }

            // Update UI
            const modifier = nextStep.maneuver.modifier;
            const type = nextStep.maneuver.type;
            const icon = getTurnIcon(modifier || 'straight');
            
            let text = '';
            if (type === 'turn') {
                text = `Turn ${modifier} onto ${nextStep.name || 'road'}`;
            } else if (type === 'new name') {
                text = `Continue onto ${nextStep.name || 'road'}`;
            } else if (type === 'depart') {
                text = `Head ${modifier || ''} on ${nextStep.name || 'road'}`;
            } else if (type === 'arrive') {
                text = `Arrive at ${nextStep.name || 'destination'}`;
            } else {
                text = `${type} ${modifier || ''} onto ${nextStep.name || 'road'}`;
            }
            
            // Clean up text
            text = text.replace(/undefined/g, '').trim();
            text = text.charAt(0).toUpperCase() + text.slice(1);
               
            document.querySelector('.turn-instruction-icon').innerHTML = icon;
            document.getElementById('turnInstructionText').textContent = text;
            
            // Update distance in the turn bar specifically (independent of HUD total distance)
            document.getElementById('turnDistanceText').textContent = (distToManeuver < 1) ? 
                (distToManeuver * 1000).toFixed(0) + ' m' : 
                distToManeuver.toFixed(1) + ' km';
        }

        let isNavTracking = true;
        let isNavOverview = false;

        let lastNavPos = null;

        function updateNavMap(lat, lng, bearing) {
            if (!navGlMap || !navGlMap.isStyleLoaded()) return;

            const center = [lng, lat];
            let effectiveBearing = bearing;

            // Sync Marker with Route Shape: Calculate bearing if null
            if ((effectiveBearing === null || effectiveBearing === undefined || isNaN(effectiveBearing)) && lastNavPos) {
                 const dLon = (lng - lastNavPos.lng) * Math.PI / 180;
                 const lat1 = lastNavPos.lat * Math.PI / 180;
                 const lat2 = lat * Math.PI / 180;
                 const y = Math.sin(dLon) * Math.cos(lat2);
                 const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
                 const brng = Math.atan2(y, x) * 180 / Math.PI;
                 effectiveBearing = (brng + 360) % 360;
            }
            lastNavPos = { lat, lng };
            
            // Default to current map bearing if still unknown
            if (effectiveBearing === null || effectiveBearing === undefined || isNaN(effectiveBearing)) {
                effectiveBearing = navGlMap.getBearing();
            }

            // Sync Marker Rotation IMMEDIATELY before ease
            if (navGlMarker) {
                navGlMarker.setLngLat(center);
                navGlMarker.setRotation(effectiveBearing);
            }

            // Lock POV Parameters (Fix Zoom Out)
            if (isNavTracking) {
                navGlMap.easeTo({
                    center: center,
                    zoom: 18,             // Locked zoom
                    pitch: 65,            // Locked Tesla-style pitch
                    bearing: effectiveBearing,
                    duration: 1000,
                    easing: (t) => t,     // Linear easing for smooth driving feel
                    essential: true
                });
            }
        }

        function beginTracking() {
            // Reset tracking state on start
            isNavTracking = true;
            
            // Setup Map Interaction Listeners for navGlMap
            if (navGlMap) {
                const disableTracking = () => { isNavTracking = false; };
                navGlMap.on('dragstart', disableTracking);
                navGlMap.on('pitchstart', disableTracking);
                navGlMap.on('rotatestart', disableTracking);
                navGlMap.on('touchmove', disableTracking);
                navGlMap.on('wheel', disableTracking);
                
                // Bind custom buttons
                const zoomInBtn = document.getElementById('navZoomInBtn');
                const zoomOutBtn = document.getElementById('navZoomOutBtn');
                const recenterBtn = document.getElementById('navRecenterBtn');
                
                if (zoomInBtn) zoomInBtn.onclick = (e) => { 
                    e.stopPropagation(); 
                    navGlMap.zoomIn(); 
                };
                if (zoomOutBtn) zoomOutBtn.onclick = (e) => { 
                    e.stopPropagation(); 
                    navGlMap.zoomOut(); 
                };
                if (recenterBtn) recenterBtn.onclick = (e) => {
                    e.stopPropagation();
                    isNavTracking = true;
                    if (userLocation) {
                        // User requested to bring back exact zoom for navigating
                        navGlMap.flyTo({
                            center: [userLocation.lng, userLocation.lat],
                            zoom: 18,
                            pitch: 45,
                            bearing: smoothedHeading || 0,
                            essential: true
                        });
                    }
                };
            }

            geolocationWatchId = navigator.geolocation.watchPosition((pos) => {
                if (!navigationActive) return;
                
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                userLocation = { lat, lng };

                let displayLat = lat;
                let displayLng = lng;
                let offRouteKm = 0;

                if (navigationActive && routePolyline) {
                    const snap = getClosestPointOnRoute(lat, lng);
                    displayLat = snap.lat;
                    displayLng = snap.lng;
                    offRouteKm = snap.distanceKm;
                    if (offRouteKm > 0.02) { // 20m threshold
                        rerouteFromCurrentLocation();
                    }
                }

                // Update marker (snapped to route when navigating)
                if (userMarker) {
                    userMarker.setLatLng([displayLat, displayLng]);
                    
                    let heading = (pos.coords.heading !== null && !isNaN(pos.coords.heading)) ? pos.coords.heading : smoothedHeading;

                    if (lastHeading === null) {
                        lastHeading = heading;
                        smoothedHeading = heading;
                    } else {
                        let rawDiff = heading - lastHeading;
                        rawDiff = ((rawDiff + 540) % 360) - 180;
                        const maxStep = 10;
                        const clampedDiff = Math.max(-maxStep, Math.min(maxStep, rawDiff));
                        const limitedHeading = lastHeading + clampedDiff;
                        const alpha = 0.2;
                        smoothedHeading = (1 - alpha) * smoothedHeading + alpha * limitedHeading;
                        lastHeading = limitedHeading;
                        heading = smoothedHeading;
                    }
                    
                    const mapEl = document.getElementById('map');
                    if (mapEl.classList.contains('map-tilted')) {
                        mapEl.style.transform = `translateY(-10vh) perspective(900px) rotateX(50deg) scale(2.5) rotateZ(-${heading}deg)`;
                    }

                    const markerElement = userMarker.getElement();
                    if (markerElement) {
                        const navMarker = markerElement.querySelector('.user-nav-marker');
                        if (navMarker) {
                            const zoom = map ? map.getZoom() : 18;
                            const baseZoom = 18;
                            const zoomDelta = zoom - baseZoom;
                            let markerScale = Math.pow(2, -zoomDelta * 0.3);
                            markerScale = Math.max(0.4, Math.min(1.0, markerScale));
                            navMarker.style.transform = `scale(${markerScale}) rotate(${heading}deg)`;
                        }
                    }

                    const navCenterLat = navigationActive && routePolyline ? displayLat : lat;
                    const navCenterLng = navigationActive && routePolyline ? displayLng : lng;
                    
                    updateNavMap(navCenterLat, navCenterLng, heading);
                }

                // Calculate distance to destination
                const dist = getDistance(userLocation.lat, userLocation.lng, navigationDestination.lat, navigationDestination.lng);
                
                // Update HUD distance
                const distText = dist < 1 ? `${(dist * 1000).toFixed(0)} m` : `${dist.toFixed(1)} km`;
                const hudDistanceEl = document.getElementById('hudDistance');
                if (hudDistanceEl) hudDistanceEl.textContent = distText;

                // Update energy card distance indicator
                const navArrivalEnergyEl = document.getElementById('navArrivalEnergy');
                if (navArrivalEnergyEl) navArrivalEnergyEl.textContent = distText;

                // Update progress bar and remaining time if we know total route length
                if (routeTotalDistanceKm && routeTotalDistanceKm > 0) {
                    const remainingRatio = Math.min(1, dist / routeTotalDistanceKm);
                    const progress = 1 - remainingRatio;
                    const progressPct = Math.max(0, Math.min(progress * 100, 100));

                    const progressFill = document.querySelector('.nav-progress-fill');
                    const progressMarker = document.querySelector('.nav-progress-marker');
                    if (progressFill) progressFill.style.width = `${Math.max(progressPct, 4)}%`;
                    if (progressMarker) progressMarker.style.left = `${Math.min(Math.max(progressPct, 4), 96)}%`;

                    const remainingMinutes = routeTotalDurationMin > 0 ? Math.max(1, Math.round(routeTotalDurationMin * remainingRatio)) : 0;
                    const hudRemainingLabelEl = document.getElementById('hudRemainingLabel');
                    if (hudRemainingLabelEl && remainingMinutes > 0) {
                        hudRemainingLabelEl.textContent = `~${remainingMinutes} min remaining`;
                    }

                    const hudArrivalEl = document.getElementById('hudArrival');
                    if (hudArrivalEl && remainingMinutes > 0) {
                        const arrivalDate = new Date(Date.now() + remainingMinutes * 60000);
                        const hours = arrivalDate.getHours().toString().padStart(2, '0');
                        const minutes = arrivalDate.getMinutes().toString().padStart(2, '0');
                        hudArrivalEl.textContent = `${hours}:${minutes}`;
                    }
                }
                
                // Update Turn Instructions
                updateTurnInstruction(lat, lng);

                // Speed
                if (pos.coords.speed !== null) {
                    document.getElementById('hudSpeed').textContent = `${(pos.coords.speed * 3.6).toFixed(0)} km/h`;
                }

                const followLat = navigationActive && routePolyline ? displayLat : lat;
                const followLng = navigationActive && routePolyline ? displayLng : lng;
                map.panTo([followLat, followLng], { animate: true, duration: 1.0 });
            }, (err) => {
                console.warn("GPS tracking error:", err);
            }, {
                enableHighAccuracy: true,
                maximumAge: 1000,
                timeout: 5000
            });
        }

        function closeStationDetail() { document.getElementById('stationDetailPanel').classList.remove('active'); }
        function startDirectionsFromDetail() { if (selectedStation) getDirections(selectedStation.lat, selectedStation.lng, selectedStation.name); closeStationDetail(); }
        function shareStationLocation() {
            if (!selectedStation) return;
            const { lat, lng, name } = selectedStation;
            const url = `https://www.google.com/maps?q=${lat},${lng}`;
            const text = name ? `${name} - ${url}` : url;
            if (navigator.share) {
                navigator.share({ title: name || 'EV Station', text, url }).catch(() => {});
            } else {
                navigator.clipboard?.writeText(text).then(() => {
                    showToast(' Location copied');
                }).catch(() => {
                    window.open(url, '_blank');
                });
            }
        }
        function toggleFavoriteStation() {
            addFavoriteAddress();
        }
        let savedAddresses = [];

        function loadSavedAddresses() {
            try {
                const raw = localStorage.getItem('evSavedAddresses');
                savedAddresses = raw ? JSON.parse(raw) : [];
            } catch {
                savedAddresses = [];
            }
            renderSavedAddresses();
        }

        function persistSavedAddresses() {
            try {
                localStorage.setItem('evSavedAddresses', JSON.stringify(savedAddresses));
            } catch {
            }
        }

        function addFavoriteAddress() {
            if (!selectedStation) return;
            const addressEl = document.getElementById('detailLocation');
            const address = addressEl ? addressEl.textContent.trim() : '';
            if (!address) return;
            const entry = {
                name: selectedStation.name || 'EV Station',
                address,
                lat: selectedStation.lat,
                lng: selectedStation.lng
            };
            savedAddresses = savedAddresses.filter(e => !(e.name === entry.name && e.address === entry.address));
            savedAddresses.unshift(entry);
            if (savedAddresses.length > 20) savedAddresses = savedAddresses.slice(0, 20);
            persistSavedAddresses();
            renderSavedAddresses();
            showToast(' Address saved');
        }

        function renderSavedAddresses() {
            const list = document.getElementById('savedAddressList');
            if (!list) return;
            if (!savedAddresses.length) {
                list.innerHTML = '<div class="saved-address-item"><div class="saved-address-location">No saved address yet</div></div>';
                return;
            }
            list.innerHTML = '';
            savedAddresses.forEach((item, idx) => {
                const row = document.createElement('div');
                row.className = 'saved-address-item';
                row.innerHTML = '<div class="saved-address-name">' + item.name + '</div><div class="saved-address-location">' + item.address + '</div>';
                row.onclick = () => {
                    toggleSavedAddressPanel(false);
                    if (map && item.lat && item.lng) {
                        map.flyTo([item.lat, item.lng], 16, { animate: true, duration: 1.5 });
                    }
                };
                list.appendChild(row);
            });
        }

        function toggleSavedAddressPanel(force) {
            const panel = document.getElementById('savedAddressPanel');
            if (!panel) return;
            if (typeof force === 'boolean') {
                panel.style.display = force ? 'block' : 'none';
            } else {
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            }
        }
        function endNavigation() {
            navigationActive = false;
            if (geolocationWatchId) navigator.geolocation.clearWatch(geolocationWatchId);
            document.getElementById('turnInstructionBar').classList.remove('active');
            document.getElementById('navHUD').classList.remove('active');
            document.body.classList.remove('nav-mode');

            // Remove 3D Tilt and Rotation
            const mapEl = document.getElementById('map');
            mapEl.classList.remove('map-tilted');
            mapEl.style.transform = ''; // Clear inline transform
            const filtersMiniToggle = document.getElementById('filtersMiniToggle');
            if (filtersMiniToggle) {
                filtersMiniToggle.style.display = '';
            }
            
            isDarkMode = wasDarkBeforeNav;
            document.body.classList.toggle('dark-mode', isDarkMode);
            toggleMapTheme(isDarkMode);

            // Restore UI panels
            const elementsToRestore = [
                document.getElementById('sidePanel'),
                document.getElementById('filtersPanel'),
                document.getElementById('mapLegend'),
                document.querySelector('.control-bar'),
                document.querySelector('.search-container'),
                document.getElementById('filtersMiniToggle')
            ];

            elementsToRestore.forEach(el => {
                if (el) {
                    el.style.display = '';
                    el.classList.remove('ui-fade-out');
                }
            });
            
            // Restore default marker
            if (userMarker) {
                const defaultIcon = L.divIcon({
                    html: '<div class="user-pulse-marker"></div>',
                    className: '',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                userMarker.setIcon(defaultIcon);
            }

            // Remove route polyline from map
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }

            if (navGlDestMarker) {
                navGlDestMarker.remove();
                navGlDestMarker = null;
            }

            // Reset Basemap to Default (Light)
            if (navGlMap) {
                 if (navGlMap.getLayer('nav-satellite')) {
                     navGlMap.removeLayer('nav-satellite');
                     if (navGlMap.getSource('nav-satellite')) {
                        navGlMap.removeSource('nav-satellite');
                     }
                 }
                 if (navGlMap.getLayer('3d-buildings')) {
                     navGlMap.setLayoutProperty('3d-buildings', 'visibility', 'visible');
                 }
            }
            const navLayerBtn = document.getElementById('navLayerBtn');
            if (navLayerBtn) {
                navLayerBtn.innerText = 'SATELLITE';
                navLayerBtn.classList.remove('active-layer');
            }

            // Restore map view to destination area or user location
            if (userLocation) {
                 map.flyTo([userLocation.lat, userLocation.lng], 15);
            }
        }

        function toggleNavOverview() {
            if (!navGlMap) return;
            isNavOverview = !isNavOverview;
            
            if (isNavOverview) {
                // Wide view of route
                if (navigationRouteGeoJSON && navigationRouteGeoJSON.features && navigationRouteGeoJSON.features.length > 0) {
                     const coordinates = navigationRouteGeoJSON.features[0].geometry.coordinates;
                     const bounds = coordinates.reduce((bounds, coord) => {
                         return bounds.extend(coord);
                     }, new maplibregl.LngLatBounds(coordinates[0], coordinates[0]));
                     
                     navGlMap.fitBounds(bounds, {
                         padding: 50,
                         pitch: 0,
                         duration: 1000,
                         essential: true
                     });
                } else {
                     // Fallback if no route
                     const currentZoom = navGlMap.getZoom();
                     navGlMap.flyTo({
                        pitch: 0,
                        zoom: Math.max(13, currentZoom - 3),
                        duration: 1000,
                        essential: true
                     });
                }
            } else {
                // Restore 3D Navigation View
                if (userLocation) {
                    navGlMap.flyTo({
                        center: [userLocation.lng, userLocation.lat],
                        zoom: 18,
                        pitch: 60,
                        bearing: smoothedHeading || 0,
                        duration: 1000,
                        essential: true
                    });
                }
            }
        }

        function toggleNavLayer() {
            if (!navGlMap) return;
            
            const layerId = 'nav-satellite';
            const btn = document.getElementById('navLayerBtn');
            
            if (navGlMap.getLayer(layerId)) {
                // Switch to LIGHT (default)
                navGlMap.removeLayer(layerId);
                navGlMap.removeSource(layerId);
                
                // Show 3D buildings and labels (Conditional 3D Depth)
                if (navGlMap.getLayer('3d-buildings')) {
                     navGlMap.setLayoutProperty('3d-buildings', 'visibility', 'visible');
                     navGlMap.setPaintProperty('3d-buildings', 'fill-extrusion-opacity', 0.5);
                }
                
                // Ensure labels are visible
                ['poi-label', 'transit-label'].forEach(layer => {
                    if (navGlMap.getLayer(layer)) {
                        navGlMap.setLayoutProperty(layer, 'visibility', 'visible');
                    }
                });
                
                // Enhance POI icons (Information Visibility)
                if (navGlMap.getLayer('poi-label')) {
                    navGlMap.setFilter('poi-label', ['in', 'class', 'fuel', 'cafe', 'charging_station']);
                    // Make them vibrant and slightly larger
                    navGlMap.setPaintProperty('poi-label', 'text-halo-width', 2);
                    navGlMap.setPaintProperty('poi-label', 'text-halo-color', '#ffffff');
                    navGlMap.setPaintProperty('poi-label', 'icon-opacity', 1);
                    // Ensure icon size is slightly increased
                    if (navGlMap.getLayer('poi-label')) {
                         navGlMap.setLayoutProperty('poi-label', 'icon-size', 1.2);
                    }
                }
                
                // Update button state (icon only)
                if (btn) {
                    btn.classList.remove('active-layer');
                }
            } else {
                // Switch to SATELLITE
                navGlMap.addSource(layerId, {
                    'type': 'raster',
                    'tiles': [
                        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
                    ],
                    'tileSize': 256
                });
                
                // Find the first symbol layer to insert before (so labels stay on top)
                let beforeId;
                const layers = navGlMap.getStyle().layers;
                for (const layer of layers) {
                    if (layer.type === 'symbol') {
                        beforeId = layer.id;
                        break;
                    }
                }
                
                navGlMap.addLayer({
                    'id': layerId,
                    'type': 'raster',
                    'source': layerId,
                    'paint': {}
                }, beforeId);
                
                // Force route line to top
                if (navGlMap.getLayer('route-line')) {
                    navGlMap.moveLayer('route-line');
                }
                
                // Hide 3D buildings to reduce clutter
                if (navGlMap.getLayer('3d-buildings')) {
                     navGlMap.setLayoutProperty('3d-buildings', 'visibility', 'none');
                }
                
                // Update button state (icon only)
                if (btn) {
                    btn.classList.add('active-layer');
                }
            }
        }


        setupIntroOverlay();
        initSDK();
        loadSavedAddresses();
    </script>
 </body>
</html>
